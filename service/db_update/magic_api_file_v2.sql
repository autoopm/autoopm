/*
 Navicat Premium Data Transfer

 Source Server         : 本地autoom-原
 Source Server Type    : MySQL
 Source Server Version : 80019 (8.0.19)
 Source Host           : localhost:33306
 Source Schema         : task

 Target Server Type    : MySQL
 Target Server Version : 80019 (8.0.19)
 File Encoding         : 65001

 Date: 15/07/2024 23:47:06
*/

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for magic_api_file_v2
-- ----------------------------
DROP TABLE IF EXISTS `magic_api_file_v2`;
CREATE TABLE `magic_api_file_v2` (
  `file_path` varchar(512) NOT NULL,
  `file_content` mediumtext,
  PRIMARY KEY (`file_path`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- ----------------------------
-- Records of magic_api_file_v2
-- ----------------------------
BEGIN;
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"name\" : \"API\",\n  \"type\" : \"api\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/api\",\n  \"createTime\" : 1720519095229,\n  \"updateTime\" : 1712690195940,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/会话/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/会话/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"1fae9227d89a49fc943a45c59e803338\",\n  \"name\" : \"会话\",\n  \"type\" : \"api\",\n  \"parentId\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"path\" : \"/channel\",\n  \"createTime\" : 1720519095268,\n  \"updateTime\" : 1716623938329,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/会话/同步会话列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"copy1714298625842d84376\",\n  \"script\" : null,\n  \"groupId\" : \"1fae9227d89a49fc943a45c59e803338\",\n  \"name\" : \"同步会话列表\",\n  \"createTime\" : 1720519095569,\n  \"updateTime\" : 1716869054831,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/conversationsync\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n    \\\"uid\\\": \\\"6\\\",\\n    \\\"msg_count\\\": 1\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"channel_id\\\": \\\"98759d57d3d7479d8d95b4fe783bff0a\\\",\\n            \\\"channel_type\\\": 2,\\n            \\\"unread\\\": 0,\\n            \\\"timestamp\\\": 1714470321,\\n            \\\"last_msg_seq\\\": 2,\\n            \\\"last_client_msg_no\\\": \\\"e965e25048981dc835d8945a0d77cce63\\\",\\n            \\\"offset_msg_seq\\\": 0,\\n            \\\"version\\\": 1714470321746,\\n            \\\"recents\\\": [\\n                {\\n                    \\\"header\\\": {\\n                        \\\"no_persist\\\": 0,\\n                        \\\"red_dot\\\": 1,\\n                        \\\"sync_once\\\": 0\\n                    },\\n                    \\\"setting\\\": 0,\\n                    \\\"message_id\\\": 1785244038836781000,\\n                    \\\"message_idstr\\\": \\\"1785244038836781056\\\",\\n                    \\\"client_msg_no\\\": \\\"e965e25048981dc835d8945a0d77cce63\\\",\\n                    \\\"message_seq\\\": 2,\\n                    \\\"from_uid\\\": \\\"6\\\",\\n                    \\\"channel_id\\\": \\\"98759d57d3d7479d8d95b4fe783bff0a\\\",\\n                    \\\"channel_type\\\": 2,\\n                    \\\"expire\\\": 0,\\n                    \\\"timestamp\\\": 1714470321,\\n                    \\\"payload\\\": \\\"eyJjb250ZW50IjoiMTIzMTMxIiwidHlwZSI6MX0=\\\"\\n                }\\n            ],\\n            \\\"info\\\": {\\n                \\\"id\\\": 34,\\n                \\\"type\\\": \\\"group\\\",\\n                \\\"group_type\\\": \\\"project\\\",\\n                \\\"name\\\": \\\"测试新项目\\\",\\n                \\\"avatar\\\": \\\"\\\",\\n                \\\"last_at\\\": null,\\n                \\\"owner_id\\\": 0,\\n                \\\"link_id\\\": 0,\\n                \\\"top_userid\\\": 0,\\n                \\\"top_msg_id\\\": 0,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"channel_id\\\": \\\"98759d57d3d7479d8d95b4fe783bff0a\\\"\\n            }\\n        },\\n        {\\n            \\\"channel_id\\\": \\\"8786210b1c744e129b717652e88b15ab\\\",\\n            \\\"channel_type\\\": 2,\\n            \\\"unread\\\": 0,\\n            \\\"timestamp\\\": 1714411444,\\n            \\\"last_msg_seq\\\": 5,\\n            \\\"last_client_msg_no\\\": \\\"feda5f7dac24a82f1a0f1c04610bda7f3\\\",\\n            \\\"offset_msg_seq\\\": 0,\\n            \\\"version\\\": 1714411444356,\\n            \\\"recents\\\": [\\n                {\\n                    \\\"header\\\": {\\n                        \\\"no_persist\\\": 0,\\n                        \\\"red_dot\\\": 1,\\n                        \\\"sync_once\\\": 0\\n                    },\\n                    \\\"setting\\\": 0,\\n                    \\\"message_id\\\": 1784997089151811600,\\n                    \\\"message_idstr\\\": \\\"1784997089151811584\\\",\\n                    \\\"client_msg_no\\\": \\\"feda5f7dac24a82f1a0f1c04610bda7f3\\\",\\n                    \\\"message_seq\\\": 5,\\n                    \\\"from_uid\\\": \\\"6\\\",\\n                    \\\"channel_id\\\": \\\"8786210b1c744e129b717652e88b15ab\\\",\\n                    \\\"channel_type\\\": 2,\\n                    \\\"expire\\\": 0,\\n                    \\\"timestamp\\\": 1714411444,\\n                    \\\"payload\\\": \\\"eyJjb250ZW50IjoiMTIzMSIsInR5cGUiOjF9\\\"\\n                }\\n            ]\\n        },\\n        {\\n            \\\"channel_id\\\": \\\"068cb18c7c484edbbf8805a3036f77b1\\\",\\n            \\\"channel_type\\\": 2,\\n            \\\"unread\\\": 0,\\n            \\\"timestamp\\\": 1714410926,\\n            \\\"last_msg_seq\\\": 2,\\n            \\\"last_client_msg_no\\\": \\\"866e13a9c7c46f8fe09f794258f39b753\\\",\\n            \\\"offset_msg_seq\\\": 0,\\n            \\\"version\\\": 1714410926444,\\n            \\\"recents\\\": [\\n                {\\n                    \\\"header\\\": {\\n                        \\\"no_persist\\\": 0,\\n                        \\\"red_dot\\\": 1,\\n                        \\\"sync_once\\\": 0\\n                    },\\n                    \\\"setting\\\": 0,\\n                    \\\"message_id\\\": 1784994916879827000,\\n                    \\\"message_idstr\\\": \\\"1784994916879826944\\\",\\n                    \\\"client_msg_no\\\": \\\"866e13a9c7c46f8fe09f794258f39b753\\\",\\n                    \\\"message_seq\\\": 2,\\n                    \\\"from_uid\\\": \\\"6\\\",\\n                    \\\"channel_id\\\": \\\"068cb18c7c484edbbf8805a3036f77b1\\\",\\n                    \\\"channel_type\\\": 2,\\n                    \\\"expire\\\": 0,\\n                    \\\"timestamp\\\": 1714410926,\\n                    \\\"payload\\\": \\\"eyJjb250ZW50Ijoi55yf55qE5LmIIiwidHlwZSI6MX0=\\\"\\n                }\\n            ]\\n        },\\n        {\\n            \\\"channel_id\\\": \\\"bb6fe74102a048e5a4acad2256e7f70a\\\",\\n            \\\"channel_type\\\": 2,\\n            \\\"unread\\\": 0,\\n            \\\"timestamp\\\": 1713967502,\\n            \\\"last_msg_seq\\\": 1,\\n            \\\"last_client_msg_no\\\": \\\"9a3dc96aab0ddb450301e826738eacc43\\\",\\n            \\\"offset_msg_seq\\\": 0,\\n            \\\"version\\\": 1713967502601,\\n            \\\"recents\\\": [\\n                {\\n                    \\\"header\\\": {\\n                        \\\"no_persist\\\": 0,\\n                        \\\"red_dot\\\": 1,\\n                        \\\"sync_once\\\": 0\\n                    },\\n                    \\\"setting\\\": 0,\\n                    \\\"message_id\\\": 1783135062477242400,\\n                    \\\"message_idstr\\\": \\\"1783135062477242368\\\",\\n                    \\\"client_msg_no\\\": \\\"9a3dc96aab0ddb450301e826738eacc43\\\",\\n                    \\\"message_seq\\\": 1,\\n                    \\\"from_uid\\\": \\\"6\\\",\\n                    \\\"channel_id\\\": \\\"bb6fe74102a048e5a4acad2256e7f70a\\\",\\n                    \\\"channel_type\\\": 2,\\n                    \\\"expire\\\": 0,\\n                    \\\"timestamp\\\": 1713967502,\\n                    \\\"payload\\\": \\\"eyJjb250ZW50Ijoi5rWLIiwidHlwZSI6MX0=\\\"\\n                }\\n            ]\\n        },\\n        {\\n            \\\"channel_id\\\": \\\"b2620fa045004b46a17ab227d3a81cb3\\\",\\n            \\\"channel_type\\\": 2,\\n            \\\"unread\\\": 0,\\n            \\\"timestamp\\\": 1713967267,\\n            \\\"last_msg_seq\\\": 2,\\n            \\\"last_client_msg_no\\\": \\\"2c2c1704a99540a9c75377826ddbc6f03\\\",\\n            \\\"offset_msg_seq\\\": 0,\\n            \\\"version\\\": 1713967267999,\\n            \\\"recents\\\": [\\n                {\\n                    \\\"header\\\": {\\n                        \\\"no_persist\\\": 0,\\n                        \\\"red_dot\\\": 1,\\n                        \\\"sync_once\\\": 0\\n                    },\\n                    \\\"setting\\\": 0,\\n                    \\\"message_id\\\": 1783134078493524000,\\n                    \\\"message_idstr\\\": \\\"1783134078493523968\\\",\\n                    \\\"client_msg_no\\\": \\\"2c2c1704a99540a9c75377826ddbc6f03\\\",\\n                    \\\"message_seq\\\": 2,\\n                    \\\"from_uid\\\": \\\"6\\\",\\n                    \\\"channel_id\\\": \\\"b2620fa045004b46a17ab227d3a81cb3\\\",\\n                    \\\"channel_type\\\": 2,\\n                    \\\"expire\\\": 0,\\n                    \\\"timestamp\\\": 1713967267,\\n                    \\\"payload\\\": \\\"eyJjb250ZW50IjoiMTIzIiwidHlwZSI6MX0=\\\"\\n                }\\n            ]\\n        }\\n    ],\\n    \\\"timestamp\\\": 1714470396986,\\n    \\\"executeTime\\\": 17\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"uid\",\n      \"value\" : \"6\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"msg_count\",\n      \"value\" : \"1\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"channel_id\",\n          \"value\" : \"8786210b1c744e129b717652e88b15ab\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"channel_type\",\n          \"value\" : \"2\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"unread\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"timestamp\",\n          \"value\" : \"1714276660\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"last_msg_seq\",\n          \"value\" : \"4\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"last_client_msg_no\",\n          \"value\" : \"773192ad1ff8eed10165bba1eef5d33a3\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"offset_msg_seq\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"version\",\n          \"value\" : \"1714276660280\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Long\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"recents\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Array\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ {\n            \"name\" : \"\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ {\n              \"name\" : \"header\",\n              \"value\" : \"\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Object\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ {\n                \"name\" : \"no_persist\",\n                \"value\" : \"0\",\n                \"description\" : \"\",\n                \"required\" : false,\n                \"dataType\" : \"Integer\",\n                \"type\" : null,\n                \"defaultValue\" : null,\n                \"validateType\" : \"\",\n                \"error\" : \"\",\n                \"expression\" : \"\",\n                \"children\" : [ ]\n              }, {\n                \"name\" : \"red_dot\",\n                \"value\" : \"1\",\n                \"description\" : \"\",\n                \"required\" : false,\n                \"dataType\" : \"Integer\",\n                \"type\" : null,\n                \"defaultValue\" : null,\n                \"validateType\" : \"\",\n                \"error\" : \"\",\n                \"expression\" : \"\",\n                \"children\" : [ ]\n              }, {\n                \"name\" : \"sync_once\",\n                \"value\" : \"0\",\n                \"description\" : \"\",\n                \"required\" : false,\n                \"dataType\" : \"Integer\",\n                \"type\" : null,\n                \"defaultValue\" : null,\n                \"validateType\" : \"\",\n                \"error\" : \"\",\n                \"expression\" : \"\",\n                \"children\" : [ ]\n              } ]\n            }, {\n              \"name\" : \"setting\",\n              \"value\" : \"0\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Integer\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"message_id\",\n              \"value\" : \"1784431763775291400\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Long\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"message_idstr\",\n              \"value\" : \"1784431763775291392\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"String\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"client_msg_no\",\n              \"value\" : \"773192ad1ff8eed10165bba1eef5d33a3\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"String\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"message_seq\",\n              \"value\" : \"4\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Integer\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"from_uid\",\n              \"value\" : \"6\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"String\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"channel_id\",\n              \"value\" : \"8786210b1c744e129b717652e88b15ab\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"String\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"channel_type\",\n              \"value\" : \"2\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Integer\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"expire\",\n              \"value\" : \"0\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Integer\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"timestamp\",\n              \"value\" : \"1714276660\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"Integer\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            }, {\n              \"name\" : \"payload\",\n              \"value\" : \"eyJjb250ZW50Ijoi5rWLIiwidHlwZSI6MX0=\",\n              \"description\" : \"\",\n              \"required\" : false,\n              \"dataType\" : \"String\",\n              \"type\" : null,\n              \"defaultValue\" : null,\n              \"validateType\" : \"\",\n              \"error\" : \"\",\n              \"expression\" : \"\",\n              \"children\" : [ ]\n            } ]\n          } ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1714298750330\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"14\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport http\nimport env\n\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\nvar responseEntity = http.connect(wukongIMUrl + \'/conversation/sync\').contentType(\'application/json\').body({\n    uid: body.uid,\n    msg_count: body.msg_count,\n}).post().getBody();\nlog.info(\"获取会话列表：\" + responseEntity)\n//取出所有的channel_id\nfor (item in responseEntity) {\n    log.info(\"item channel_id ->\" + item.channel_id);\n    //从web_socket_dialog表中获取到所有的数据，赋值给他\n    info = db.table(\"web_socket_dialogs\").where().eq(\"channel_id\", item.channel_id).selectOne()\n    log.info(\"info--->\" + info)\n    if (info !== null) {\n        item.info = info\n    }\n}\n// 处理时间和类型等\n//dialog.type \nreturn responseEntity');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/会话/同步频道的消息.ms', '{\n  \"properties\" : { },\n  \"id\" : \"d1918bd63d5344208b8c8ff447ff9916\",\n  \"script\" : null,\n  \"groupId\" : \"1fae9227d89a49fc943a45c59e803338\",\n  \"name\" : \"同步频道的消息\",\n  \"createTime\" : 1720519095625,\n  \"updateTime\" : 1716877305867,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/messagesync\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n    \\\"login_uid\\\": \\\"6\\\",\\n    \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n    \\\"channel_type\\\": 2,\\n    \\\"start_message_seq\\\": 0,\\n    \\\"end_message_seq\\\": 0,\\n    \\\"pull_mode\\\": 0,\\n    \\\"limit\\\": 50\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"start_message_seq\\\": 0,\\n        \\\"end_message_seq\\\": 0,\\n        \\\"more\\\": 0,\\n        \\\"messages\\\": [\\n            {\\n                \\\"header\\\": {\\n                    \\\"no_persist\\\": 0,\\n                    \\\"red_dot\\\": 1,\\n                    \\\"sync_once\\\": 0\\n                },\\n                \\\"setting\\\": 0,\\n                \\\"message_id\\\": 1768461830608388000,\\n                \\\"message_idstr\\\": \\\"1768461830608388096\\\",\\n                \\\"client_msg_no\\\": \\\"ae4deb932a3685431aaab73ddf8330923\\\",\\n                \\\"message_seq\\\": 1,\\n                \\\"from_uid\\\": \\\"6\\\",\\n                \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n                \\\"channel_type\\\": 2,\\n                \\\"expire\\\": 0,\\n                \\\"timestamp\\\": 1710469131,\\n                \\\"payload\\\": \\\"eyJjb250ZW50IjoiPHA+MTIzMTIzPC9wPiIsInR5cGUiOjF9\\\"\\n            },\\n            {\\n                \\\"header\\\": {\\n                    \\\"no_persist\\\": 0,\\n                    \\\"red_dot\\\": 1,\\n                    \\\"sync_once\\\": 0\\n                },\\n                \\\"setting\\\": 0,\\n                \\\"message_id\\\": 1768463741122248700,\\n                \\\"message_idstr\\\": \\\"1768463741122248704\\\",\\n                \\\"client_msg_no\\\": \\\"a512e163b7f87ffb2ba05de151a6d90b3\\\",\\n                \\\"message_seq\\\": 2,\\n                \\\"from_uid\\\": \\\"6\\\",\\n                \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n                \\\"channel_type\\\": 2,\\n                \\\"expire\\\": 0,\\n                \\\"timestamp\\\": 1710469587,\\n                \\\"payload\\\": \\\"eyJjb250ZW50IjoiPHA+MTIzMTMxPC9wPiIsInR5cGUiOjF9\\\"\\n            },\\n            {\\n                \\\"header\\\": {\\n                    \\\"no_persist\\\": 0,\\n                    \\\"red_dot\\\": 1,\\n                    \\\"sync_once\\\": 0\\n                },\\n                \\\"setting\\\": 0,\\n                \\\"message_id\\\": 1768473429670887400,\\n                \\\"message_idstr\\\": \\\"1768473429670887424\\\",\\n                \\\"client_msg_no\\\": \\\"5a2948deed2617c6423c8177f8d4e6ad3\\\",\\n                \\\"message_seq\\\": 3,\\n                \\\"from_uid\\\": \\\"6\\\",\\n                \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n                \\\"channel_type\\\": 2,\\n                \\\"expire\\\": 0,\\n                \\\"timestamp\\\": 1710471896,\\n                \\\"payload\\\": \\\"eyJjb250ZW50IjoiPHA+MTIzMTMxMzwvcD4iLCJ0eXBlIjoxfQ==\\\"\\n            },\\n            {\\n                \\\"header\\\": {\\n                    \\\"no_persist\\\": 0,\\n                    \\\"red_dot\\\": 1,\\n                    \\\"sync_once\\\": 0\\n                },\\n                \\\"setting\\\": 0,\\n                \\\"message_id\\\": 1768480476172910600,\\n                \\\"message_idstr\\\": \\\"1768480476172910592\\\",\\n                \\\"client_msg_no\\\": \\\"b0f92a9600619207d74eb45edca39a013\\\",\\n                \\\"message_seq\\\": 4,\\n                \\\"from_uid\\\": \\\"6\\\",\\n                \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n                \\\"channel_type\\\": 2,\\n                \\\"expire\\\": 0,\\n                \\\"timestamp\\\": 1710473576,\\n                \\\"payload\\\": \\\"eyJjb250ZW50IjoiPHA+MTIzMTIzPC9wPiIsInR5cGUiOjF9\\\"\\n            },\\n            {\\n                \\\"header\\\": {\\n                    \\\"no_persist\\\": 0,\\n                    \\\"red_dot\\\": 1,\\n                    \\\"sync_once\\\": 0\\n                },\\n                \\\"setting\\\": 0,\\n                \\\"message_id\\\": 1768480892868624400,\\n                \\\"message_idstr\\\": \\\"1768480892868624384\\\",\\n                \\\"client_msg_no\\\": \\\"f2a2ac242ae7d6fd28e7624c868258e43\\\",\\n                \\\"message_seq\\\": 5,\\n                \\\"from_uid\\\": \\\"6\\\",\\n                \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n                \\\"channel_type\\\": 2,\\n                \\\"expire\\\": 0,\\n                \\\"timestamp\\\": 1710473676,\\n                \\\"payload\\\": \\\"eyJjb250ZW50IjoiPHA+MjMxMjMxMzwvcD4iLCJ0eXBlIjoxfQ==\\\"\\n            },\\n            {\\n                \\\"header\\\": {\\n                    \\\"no_persist\\\": 0,\\n                    \\\"red_dot\\\": 1,\\n                    \\\"sync_once\\\": 0\\n                },\\n                \\\"setting\\\": 0,\\n                \\\"message_id\\\": 1768481070447067100,\\n                \\\"message_idstr\\\": \\\"1768481070447067136\\\",\\n                \\\"client_msg_no\\\": \\\"daa678cf639a4b3d99cc2364707b0b0b3\\\",\\n                \\\"message_seq\\\": 6,\\n                \\\"from_uid\\\": \\\"6\\\",\\n                \\\"channel_id\\\": \\\"71bb0f6c1d9b4e89982cd9c3c3210144\\\",\\n                \\\"channel_type\\\": 2,\\n                \\\"expire\\\": 0,\\n                \\\"timestamp\\\": 1710473718,\\n                \\\"payload\\\": \\\"eyJjb250ZW50IjoiPHA+MTM0MTQxNDwvcD4iLCJ0eXBlIjoxfQ==\\\"\\n            }\\n        ]\\n    },\\n    \\\"timestamp\\\": 1710492660729,\\n    \\\"executeTime\\\": 5\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"Hello magic-api\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1710492628024\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"8\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport http\nimport env\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\nvar responseEntity = http.connect(wukongIMUrl+\'/channel/messagesync\').contentType(\'application/json\').body({\n    login_uid: body.login_uid,\n    channel_id: body.channel_id,\n    channel_type: 2, //TODO 2代表群组,本期只考虑群组的\n    start_message_seq: 0,\n    end_message_seq: 0,\n    pull_mode: 1,\n    limit: 50\n}).post().getBody();\nlog.info(\"执行消息同步\" + responseEntity)\n\nreturn responseEntity');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/会话/未定义名称.ms', '{\n  \"properties\" : { },\n  \"id\" : \"c01ca7bb04ac480cafa7cef7ff659798\",\n  \"script\" : null,\n  \"groupId\" : \"1fae9227d89a49fc943a45c59e803338\",\n  \"name\" : \"未定义名称\",\n  \"createTime\" : 1720519095641,\n  \"updateTime\" : 1713024590708,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"test\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711530358273,\\n    \\\"executeTime\\\": 5\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"Hello magic-api\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711530275808\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"2\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\nvar turns = \"[115, 116, 117, 118, 119]\"\nif (turns.length()>2){\n    let turnArr = []\n    turnstr = turns.substring(1,turns.length()-1).split(\", \")\n    for (item in turnstr) {\n        turnArr.push(item::int)\n    }\n    log.info(\'turnArr->\'+turnArr)\n\n    \n}\n\n\n\n\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"文件\",\n  \"type\" : \"api\",\n  \"parentId\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"path\" : \"/file\",\n  \"createTime\" : 1720519095279,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/保存文件内容.ms', '{\n  \"properties\" : { },\n  \"id\" : \"f1eede4e29b746bfaff45f2cf30b0411\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"保存文件内容\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720950029854,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/content/save\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"\",\n    \"description\" : \"文件ID\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"content\",\n    \"value\" : \"\",\n    \"description\" : \"Request Payload 提交  content: 内容\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\r\\n  \\\"id\\\": 72,\\r\\n  \\\"content\\\": \\\"{\\\\\\\"root\\\\\\\":{\\\\\\\"data\\\\\\\":{\\\\\\\"id\\\\\\\":\\\\\\\"4POyrRA9RUcV\\\\\\\",\\\\\\\"text\\\\\\\":\\\\\\\"111\\\\\\\"},\\\\\\\"children\\\\\\\":[]},\\\\\\\"template\\\\\\\":\\\\\\\"default\\\\\\\",\\\\\\\"theme\\\\\\\":\\\\\\\"fresh-blue\\\\\\\",\\\\\\\"version\\\\\\\":\\\\\\\"1.4.43\\\\\\\"}\\\"\\r\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 50,\\n        \\\"fid\\\": 72,\\n        \\\"content\\\": \\\"{\\\\\\\"url\\\\\\\":\\\\\\\"2024-04-19/c7270aaccd0f472ca1192de7f5ee444b.mind\\\\\\\",\\\\\\\"ext\\\\\\\":\\\\\\\"mind\\\\\\\"}\\\",\\n        \\\"text\\\": \\\"\\\",\\n        \\\"size\\\": 0,\\n        \\\"userid\\\": 6,\\n        \\\"created_at\\\": 1713510191000,\\n        \\\"updated_at\\\": null\\n    },\\n    \\\"timestamp\\\": 1713516867764,\\n    \\\"executeTime\\\": 43\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"id\",\n      \"value\" : \"66\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"content\",\n      \"value\" : \"{\\\"root\\\":{\\\"data\\\":{\\\"id\\\":\\\"aeirgZfYLkKA\\\",\\\"text\\\":\\\"111\\\"},\\\"children\\\":[{\\\"data\\\":{\\\"id\\\":\\\"d0limgola680\\\",\\\"created\\\":1713267449344,\\\"text\\\":\\\"分支主题\\\"},\\\"children\\\":[]}]},\\\"template\\\":\\\"default\\\",\\\"theme\\\":\\\"fresh-blue\\\",\\\"version\\\":\\\"1.4.43\\\"}\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"id\",\n        \"value\" : \"48\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"fid\",\n        \"value\" : \"74\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"content\",\n        \"value\" : \"{\\\"url\\\":\\\"2024-04-17/2fa0d20e9a514fb7b2246ff3181f716f.mind\\\",\\\"ext\\\":\\\"mind\\\"}\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"text\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"size\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"userid\",\n        \"value\" : \"6\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"created_at\",\n        \"value\" : \"1713360114000\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Long\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"updated_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1713360410146\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"43\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport cn.hutool.core.util.ObjectUtil\nimport log;\nimport org.ssssssss.magicboot.utils.MinioUtil\nimport cn.hutool.core.io.FileUtil;\nimport org.ssssssss.magicboot.utils.FileUtils;\nimport cn.hutool.core.util.StrUtil;\nimport cn.hutool.http.HtmlUtil;\nimport \'@/file/permissionFind\' as permissionFind;\nimport java.io.InputStream;\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\n// var userId = 6\nvar userId = StpUtil.getLoginId() \nvar id = body.id;\nvar content = body.content::json\nlog.info(\"content is \" + content);\n// 根据文件ID和用户权限查找文件实例\nvar file = permissionFind(userId, id, 1);\nlog.info(\"save permissionFind file--->\" + file)\n\n// 初始化文本变量\nvar text = \'\';\n\n// var contentJsonObject = content::json\n// log.info(\"contentJsonObject id\",contentJsonObject)\nvar contentString = \'\';\nvar ext = \'\';\n\n// 如果文件类型为文档\nif (\'document\'.equals(file.type)) {\n    // 移除内容中HTML标签，仅保留文本\n    text = HtmlUtil.cleanHtmlTag(content);\n}\n\n// 根据文件类型处理内容\nif (\'document\'.equals(file.type)) {\n    // 处理文档类型文件\n    contentString = content;\n    // 设置文件扩展名\n    ext = \'md\'.equals(content.type) ? \'md\' : \'text\';\n} else if (\'drawio\'.equals(file.type)) {\n    // 处理绘图类型文件\n    contentString = content.xml;\n    // 设置文件扩展名\n    ext = \'drawio\';\n} else if (\'mind\'.equals(file.type)) {\n    contentString = content;\n    log.info(\"contentString--------->\" + contentString)\n    ext = \'mind\';\n} else if (\'txt\'.equals(file.type) || \'code\'.equals(file.type)) {\n    // 处理文本和代码类型文件\n    contentString = content.content;\n} else {\n    exit 400, \'参数错误\';\n}\n\nlog.info(\"ext-->\" + ext)\nlog.info(\"contentString-->\" + contentString)\n// 将内容保存到文件,并上传minio\nfileName = FileUtil.createTempFile(\'.\' + ext, true)\n// fileName = \"./\"+now().format(\"yyyyMMddHHmmss\")+\".\"+ext\n\n\nlog.info(\"fileName-->\" + fileName)\nvar tempFile = FileUtil.writeUtf8String(contentString, fileName);\n// log.info(\"tempFile-->\" + tempFile)\n\n// var data = FileUtil.readBytes(tempFile);\n// // string filcontent = string(data)\nlog.info(\"FileUtil.readUtf8String(fileName)-->\" + FileUtil.readUtf8String(fileName))\n\nlog.info(\"Content of temporary file---> \" + FileUtil.readUtf8String(fileName));\n\nInputStream inputStream = FileUtil.getInputStream(tempFile);\nvar newUrl = MinioUtil.uploadStream(inputStream, \'.\' + ext);\nlog.info(\"newUrl-->\" + newUrl)\n// 添加文件的url和文件后缀名\n// content.put(\"url\",newUrl);\n// content.put(\"ext\",ext);\n\nlog.info(\"contentObj::json ss\" + contentObj::stringify)\n\n// 重新计算文件大小\nvar fileSize = FileUtils.getFileSize(MinioUtil.preview(newUrl));\n\n// 保存文件内容到file_contents\nvar fileContent = db.table(\'file_contents\')\n    .where()\n    .eq(\'fid\', id)\n    .isNull(\'deleted_at\')\n    .selectOne();\n\nvar fileContentMap = {\n    id: ObjectUtil.isNotEmpty(fileContent) ? fileContent.id : null,\n    fid: id,\n    content: content::stringify,\n    text: text,\n    size: fileSize,\n    userid: userId,\n    created_at: ObjectUtil.isNotEmpty(fileContent) ? fileContent.created_at : new Date(),\n    updated_at: ObjectUtil.isNotEmpty(fileContent) ? fileContent.updated_at : null\n}\n\ndb.table(\'file_contents\')\n    .primary(\'id\', null)\n    .save(fileContentMap);\n\n// 保存文件到files\ndb.table(\'files\').primary(\'id\').update({\n    id: id,\n    size: fileSize,\n    url: newUrl,\n    ext: ext,\n    updated_at: now()\n});\n\n//判断是否自动上传到知识库\n\n\n\n//    /api/dataset/document/split\n// 地址：http://127.0.0.1:8108/api/dataset/document/split\n// 载荷 file\n\n\n\n// todo 推送消息\nreturn fileContentMap;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/保存文件内容(office回调).ms', '{\n  \"properties\" : { },\n  \"id\" : \"7af7db25ced44571a9b72badbba238f1\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"保存文件内容(office回调)\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720635818334,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/content/office\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport org.apache.tomcat.util.http.fileupload.FileUtils\nimport org.ssssssss.magicboot.utils.MinioUtil\nimport org.ssssssss.magicboot.utils.FileUtils\nimport cn.hutool.core.util.ObjectUtil;\nimport request;\nimport cn.dev33.satoken.stp.StpUtil;\nimport http;\nimport java.io.ByteArrayInputStream;\nimport java.io.InputStream;\nimport log;\nimport java.util.Scanner;\nimport response;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\n\nvar userId = StpUtil.getLoginIdByToken(token)\nlog.info(\"---------------------------token>\"+token);\nlog.info(\"---------------------------userId>\"+userId);\n\nlog.info(\"--------------------------->office回调\");\nlog.info(\"param id get-------->\" + id)\nlog.info(\"param status  get-------->\" + body.status)\nlog.info(\"param url get-------->\" + body.url)\nlog.info(\"param user get-------->\" + body.users)\n// 查找文件\nvar file = db.table(\'files\')\n    .where()\n    .isNull(\'deleted_at\')\n    .eq(\'id\', id)\n    .selectOne();\n\nif (ObjectUtil.isEmpty(file)) {\n    exit 400, \'找不到相关文件\'\n}\n\n// 如果状态为2，表示需要保存远程办公文档到本地服务器\nif (body.status == 2) {\n    URL url = new URL(body.url);\n    HttpURLConnection connection = url.openConnection();\n    InputStream stream = connection.getInputStream();\n\n    var newUrl = MinioUtil.uploadStream(stream, \'.\' + file.ext);\n\n    // 重新计算文件大小，更新文件大小\n    var fileSize = FileUtils.getFileSize(MinioUtil.preview(newUrl));\n    var content = {\n        \"url\": newUrl\n    }\n    // 更新file_contents,没有就新增\n    var isExist = db.table(\'file_contents\').where().eq(\'fid\', id).count();\n    if (isExist > 0) {\n        db.table(\'file_contents\').primary(\'fid\').update({\n            fid: id,\n            content: content::stringify,\n            text: \'\',\n            size: fileSize,\n            userid: userId,\n            updated_at: new Date()\n        })\n    } else {\n\n        db.table(\'file_contents\').primary(\'fid\').insert({\n            fid: id,\n            content: content::stringify,\n            text: \'\',\n            size: fileSize,\n            userid: userId,\n            created_at: new Date(),\n            updated_at: new Date()\n        });\n\n    }\n\n    // 更新files\n    db.table(\'files\').primary(\'id\').update({\n        id: id,\n        url: newUrl,\n        size: fileSize,\n        updated_at: new Date()\n    })\n\n}\n\nreturn response.json({\n    error: 0\n});');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/保存文件内容(上传文件).ms', '{\n  \"properties\" : { },\n  \"id\" : \"63db3582e2954c7db94e36626fffa1de\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"保存文件内容(上传文件)\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720520731470,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/content/upload\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"pid\",\n    \"value\" : \"0\",\n    \"description\" : \"父级ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : \"\",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1716879514327,\\n    \\\"executeTime\\\": 85\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.collection.CollUtil\nimport cn.hutool.core.util.StrUtil;\nimport cn.hutool.core.io.FileUtil;\nimport com.alibaba.fastjson.JSONObject;\nimport cn.hutool.core.util.ObjectUtil;\nimport cn.dev33.satoken.stp.StpUtil;\nimport request;\nimport log;\n\nimport \'@/file/permissionFind\' as permissionFind;\nimport \'@/file/getFileTypeByExt\' as getFileTypeByExt;\nimport \'@/file/handleDuplicateName\' as handleDuplicateName;\nimport \'@/file/uploadkb\' as uploadkb;\n\nimport org.ssssssss.magicboot.utils.MinioUtil;\nimport org.ssssssss.magicboot.utils.FileUtils;\n\nvar userId = StpUtil.getLoginId();\nlog.info(\"文件上传的userid is->\" + userId);\n// var userId = 6;\nvar uploadFile = request.getFile(\'file\')\nlog.info(\"uploadFile=\" + uploadFile);\nlog.info(\"uploadFile.name\" + uploadFile.name);\nlog.info(\"pid=\" + pid);\npid = pid::int\nlog.info(\"pid----->\" + pid);\n\nif (pid > 0) {\n    var fileNum = db.table(\"files\").where().eq(\'pid\', pid).isNull(\'deleted_at\').count();\n    if (fileNum > 300) {\n        exit 400, \'每个文件夹里最多只能创建300个文件或文件夹\';\n    }\n    // 在文件夹里面创建的文件或者文件夹，所有者都是上一级文件夹的\n    var file = permissionFind(userId, pid, 1);\n    userId = file.userid;\n} else {\n    var fileNum = db.table(\"files\").where().eq(\'pid\', 0).isNull(\'deleted_at\').eq(\'userid\', userId).count();\n    if (fileNum >= 300) {\n        exit 400, \'每个文件夹里最多只能创建300个文件或文件夹\';\n    }\n}\n\n// 单独传文件是webkitRelativePath是空的\nlog.info(\"webkitRelativePath={}\", webkitRelativePath);\nvar dirs = StrUtil.isNotEmpty(webkitRelativePath) ? webkitRelativePath.split(\"/\") : null;\nlog.info(\"dirs={}\", dirs);\n// 创建文件夹\nwhile (dirs != null && dirs.length > 1) {\n    // 获取数组的第一个元素\n    var dirName = dirs[0];\n    db.transaction(() => {\n        // 检查文件夹是否存在，如果不存在则创建新文件夹。\n        var dirRow = db.select(\"\"\"\n        SELECT * FROM files WHERE pid = #{pid} AND type = \'folder\' AND name = #{dirName} and deleted_at is null FOR UPDATE\n        \"\"\")\n\n        if (CollUtil.isEmpty(dirRow)) {\n            var newName = handleDuplicateName(pid, userId, null, dirName);\n            var pshare = 0;\n\n            // pid !=0才去看父级共享状态\n            if (pid != 0) {\n                var pfolder = db.table(\'files\').where().isNull(\'deleted_at\').eq(\'id\', pid).selectOne();\n                if (ObjectUtil.isNotEmpty(pfolder)) {\n                    if (pfolder.share == 1) {\n                        // 如果父级是共享的，那么就把父级的id带过来\n                        pshare = pfolder.id;\n                    } else if (pfolder.pshare != 0) {\n                        // 如果父级的也是有pshare，那么就带过来\n                        pshare = pfolder.pshare;\n                    }\n                }\n            }\n\n            var createdAt = new Date();\n\n            log.info(\"pid={}\", pid);\n            // 保存\n            var id = db.table(\'files\')\n                .primary(\'id\')\n                .insert({\n                    created_id: userId,\n                    name: newName,\n                    type: \'folder\',\n                    pid: pid,\n                    url: url,\n                    ext: null,\n                    userid: userId,\n                    created_at: createdAt,\n                    updated_at: createdAt,\n                    pids: pids,\n                    id_path: pids,\n                    pshare: pshare\n                })\n            // 更新 pids和id_path字段\n            var pids = \'\';\n\n            if (pid == 0) {\n                pids = \"/\" + id + \"/\";\n            } else {\n                // 获取父级的pids\n                var idPath = db.table(\'files\')\n                    .where()\n                    .eq(\"id\", pid)\n                    .isNull(\'deleted_at\')\n                    .selectOne();\n                pids = idPath.id_path + id + \"/\"\n            }\n\n            db.table(\'files\').primary(\'id\').update({\n                id: id,\n                pids: pids,\n                id_path: pids\n            })\n            // 如果文件夹不存在，抛出异常。\n            if (null == id) {\n                exit 400, \'创建文件夹失败\';\n            }\n\n            // 更新pid\n            pid = id;\n\n            //插入系统用户表,permission默认为1\n            var id = db.table(\'file_users\')\n                .insert({\n                    file_id: id,\n                    created_at: createdAt,\n                    updated_at: createdAt,\n                    userid: userId,\n                    permission: 1\n                })\n\n\n\n        } else {\n            pid = dirRow.id;\n        }\n    });\n    // 移除已经处理过的元素\n    dirs = Arrays.copyOfRange(dirs, 1, dirs.length);\n}\n\nvar fileNameWithExt = (dirs != null) ? dirs[0] : uploadFile.getOriginalFilename();\nlog.info(\"fileNameWithExt={}\", fileNameWithExt);\n\nint index = StrUtil.lastIndexOfIgnoreCase(fileNameWithExt, \".\");\nvar ext = fileNameWithExt.substring(index + 1);\nvar fileName = fileNameWithExt.substring(0, index);\n\n// 上传文件获取url\nvar fileUrl = MinioUtil.upload(uploadFile);\nvar url = MinioUtil.preview(fileUrl);\nvar fileType = getFileTypeByExt(ext);\nvar newName = handleDuplicateName(pid, userId, null, fileName);\nvar fileSize = FileUtils.getFileSize(url);\n\nif (\"markdown\".equals(ext)) {\n    ext = \"md\";\n}\n\nvar result = {\n    ret: 0\n};\ndb.transaction(() => {\n    log.info(\"pids-->-->-->-->-->-->-->-->-->-->\" + pid)\n\n    var pshare = 0;\n    // pid !=0才去看父级共享状态\n    if (pid != 0) {\n        var pfolder = db.table(\'files\').where().isNull(\'deleted_at\').eq(\'id\', pid).eq(\'share\', 1).selectOne();\n        pshare = (pfolder != null && 1 == pfolder.share) ? pfolder.id : 0;\n    }\n    // 保存\n    var createdAt = new Date();\n    var id = db.table(\'files\')\n        .primary(\'id\')\n        .insert({\n            created_id: userId,\n            name: newName,\n            type: fileType,\n            pid: pid,\n            url: fileUrl,\n            ext: ext,\n            userid: userId,\n            created_at: createdAt,\n            updated_at: createdAt,\n            pshare: pshare,\n            size: fileSize\n        })\n    // 更新 pids和id_path字段\n    var pids = \'\';\n\n    if (pid == 0 || pid == \'0\') { //特殊处理了\n        pids = \"/\" + id + \"/\";\n    } else {\n        // 获取父级的pids\n        var idPath = db.table(\'files\')\n            .where()\n            .eq(\"id\", pid)\n            .isNull(\'deleted_at\')\n            .selectOne();\n        pids = idPath.id_path + id + \"/\"\n    }\n\n    db.table(\'files\').primary(\'id\').update({\n        id: id,\n        pids: pids,\n        id_path: pids\n    })\n\n    //插入系统用户表,permission默认为1\n    var file_users = db.table(\'file_users\')\n        .insert({\n            file_id: id,\n            created_at: createdAt,\n            updated_at: createdAt,\n            userid: userId,\n            permission: 1\n        })\n\n    var content = {\n        \'from\': \'\',\n        \'type\': fileType,\n        \'ext\': ext,\n        \'url\': fileUrl\n    }\n    // 新增fileContent\n    var fileContentMap = {\n        fid: id,\n        content: JSONObject.toJSONString(content),\n        text: text,\n        size: fileSize,\n        userid: userId,\n        created_at: createdAt,\n        updated_at: createdAt\n    }\n\n    db.table(\'file_contents\')\n        .primary(\'id\', null)\n        .save(fileContentMap);\n\n    //TODO 调用函数上传知识库,暂时不考虑上传\n    // uploadkb(fileUrl)\n    result = {\n        id: id,\n        created_id: userId,\n        name: newName,\n        type: fileType,\n        pid: pid,\n        ext: ext,\n        userid: userId,\n        created_at: createdAt,\n        updated_at: createdAt,\n        deleted_at: null,\n        pshare: pshare,\n        pids: pids,\n        id_path: pids,\n        size: fileSize,\n        ret: 1\n    }\n    if (\"picture\".equals(fileType)) {\n        result.put(\'image_url\', \'http://82.157.62.190:8081/api/file/preview/\' + id);\n    }\n\n});\n\nreturn result;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/删除文件(夹).ms', '{\n  \"properties\" : { },\n  \"id\" : \"835b892be2dc4949a70b5bcd0e54666c\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"删除文件(夹)\",\n  \"createTime\" : 1720519095689,\n  \"updateTime\" : 1716776098912,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/remove\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"ids\",\n    \"value\" : \"\",\n    \"description\" : \"文件id,多个使用,分割\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711793828291,\\n    \\\"executeTime\\\": 9627\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.collection.CollUtil;\nimport cn.hutool.core.util.StrUtil;\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\nvar userId = StpUtil.getLoginId()\nvar idList = StrUtil.split(ids, \',\')\n\nif (CollUtil.isEmpty(idList)) {\n    exit 400, \'请选择删除的文件或文件夹\'\n}\n\nif (idList.size() > 100) {\n    exit 400, \'一次最多只能删除100个文件或文件夹\'\n}\n\nvar idSet = new HashSet(idList);\n// 权限检测：只有所有者或者创建者才能删除\nvar num = db.table(\'files\')\n    .where()\n    .in(\'id\', idSet)\n    .isNull(\'deleted_at\')\n    .and(it => it.eq(\'userid\', userId).or().eq(\'created_id\', userId))\n    .count();\n\n// 说明当前用户不是文件（夹）的所有者或创建这\nif (idSet.size() != num) {\n    exit 400, \'仅限所有者或创建者操作\';\n}\n\n// 如果是文件夹，递归删除，并删除权限信息和文件内容信息\nconst idPathList = db.table(\'files\')\n    .column(\'id_path\')\n    .where()\n    .in(\'id\', idSet)\n    .isNull(\'deleted_at\')\n    .select();\n\n\nif (CollUtil.isEmpty(idPathList)) {\n    exit 400, \'删除失败\';\n}\n\n// 开启一个事物\nvar deletedAt = new Date();\nvar val = db.transaction(() => {\n    // 删除文件内容\n    var v1 = db.update(\"\"\"\n        UPDATE file_contents fc\n        INNER JOIN (SELECT DISTINCT id FROM files WHERE deleted_at is null and\n            <foreach collection=\"idPathList\" item=\"item\" separator=\" OR \" open=\"(\" close=\")\">\n                id_path LIKE CONCAT(#{item.get(\'id_path\')}, \'%\')\n            </foreach>\n        ) sub ON fc.fid = sub.id\n        SET fc.deleted_at = #{deletedAt}\n        \"\"\")\n    // 删除文件权限\n    var v2 = db.update(\"\"\"\n        DELETE FROM file_users\n        WHERE file_id IN (\n            SELECT DISTINCT id FROM files\n            WHERE deleted_at IS NULL \n            AND (\n                <foreach collection=\"idPathList\" item=\"idPath\" separator=\" OR \" open=\"(\" close=\")\">\n                    id_path LIKE CONCAT(#{idPath.get(\'id_path\')}, \'%\')\n                </foreach>\n            )\n        )\n    \"\"\")\n\n    // 删除文件链接\n    var v3 = db.update(\"\"\"\n        DELETE FROM file_links\n        WHERE file_id IN (\n            SELECT DISTINCT id FROM files\n            WHERE deleted_at IS NULL \n            AND (\n                <foreach collection=\"idPathList\" item=\"idPath\" separator=\" OR \" open=\"(\" close=\")\">\n                    id_path LIKE CONCAT(#{idPath.get(\'id_path\')}, \'%\')\n                </foreach>\n            )\n        )\n    \"\"\")\n\n    // 删除文件\n    var v4 = db.update(\"\"\"\n        UPDATE files f\n        INNER JOIN (SELECT DISTINCT id FROM files WHERE deleted_at is null and\n            <foreach collection=\"idPathList\" item=\"item\" separator=\" OR \" open=\"(\" close=\")\">\n                id_path LIKE CONCAT(#{item.get(\'id_path\')}, \'%\')\n            </foreach>\n        ) sub ON f.id = sub.id\n        SET f.deleted_at = #{deletedAt}\n        \"\"\")\n\n    return v4;\n});\n\n\nreturn \"删除成功\"');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/复制文件(夹).ms', '{\n  \"properties\" : { },\n  \"id\" : \"bcdc82d0048644398e76f5e5a5d88d23\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"复制文件(夹)\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720950407360,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/copy\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"13\",\n    \"description\" : \"文件ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": 0,\\n    \\\"timestamp\\\": 1711036551973,\\n    \\\"executeTime\\\": 2\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"id\",\n          \"value\" : \"16\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"file_id\",\n          \"value\" : \"19\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"userid\",\n          \"value\" : \"1\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"permission\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"created_at\",\n          \"value\" : \"null\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"updated_at\",\n          \"value\" : \"null\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711035730814\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"2\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport org.springframework.core.ReactiveAdapter\nimport org.junit.jupiter.params.provider.NullAndEmptySource\nimport cn.dev33.satoken.stp.StpUtil;\nimport com.alibaba.fastjson.JSONObject;\nimport org.ssssssss.magicboot.utils.MinioUtil;\nimport log;\n\nvar userId = StpUtil.getLoginId();\nlog.info(\"执行到这里-1\")\n// var userId = 6;\n//根据文件id和userid去file_users表查询，是否有复制权限\nvar fileUsers = db.table(\"file_users\").where().eq(\"file_id\", id).eq(\"userid\", userId).select();\nlog.info(\"执行到这里0：：：\" + fileUsers)\nif (fileUsers.size() == 0) {\n    exit \'没有找到可以复制的文件\'\n}\nlog.info(\"执行到这里0\")\n//重新保存一份\nvar nowAt = new Date();\nvar val = db.transaction(() => {\n    log.info(\"执行到这里1\")\n    var fileCopy = db.table(\"files\").where().eq(\"id\", id).selectOne();\n    //原始的对象\n    var file_url = fileCopy.url;\n    //对象名\n    let fileName = file_url.substring(0, file_url.lastIndexOf(\'.\'));\n    //对象后缀\n    let fileExtension = file_url.substring(file_url.lastIndexOf(\'.\'));\n    //新的对象要加copy\n    // 构建新文件名，添加_copy并在末尾保留原始扩展名\n    // let newObjectName = fileName + \'_copy\' + fileExtension;\n\n    let counter = 1\n\n    let tempObjectName = fileName + \'_copy\' + counter + fileExtension;\n    log.info(\"tempObjectName is --->\" + tempObjectName)\n\n    log.info(\"执行到这里2\")\n    //检查是否存在，如果存在就再加\n    while (MinioUtil.isObjectExists(tempObjectName)) {\n        counter++;\n        log.info(\"counter is --->\" + counter)\n        tempObjectName = fileName + \'_copy\' + counter + fileExtension;\n        log.info(\"tempObjectName is --->\" + tempObjectName)\n    }\n\n\n    //复制对象的名称\n    MinioUtil.copyObject(fileCopy.url, tempObjectName);\n    //检查文件是否存在\n    var isExis = MinioUtil.isObjectExists(tempObjectName)\n\n    if (isExis) {\n        log.info(\"文件已拷贝成功\");\n    } else {\n        log.info(\"文件不存在，可能拷贝异常了\");\n    }\n\n    log.info(\"tempObjectName is --->\" + tempObjectName)\n    //存储files\n    var data = {\n        pid: fileCopy.pid,\n        url: tempObjectName,\n        name: fileCopy.name + \'_copy\' + counter,\n        type: fileCopy.type,\n        ext: fileCopy.ext,\n        size: fileCopy.size,\n        userid: userId,\n        //TODO 还有share、cid\n        pshare: fileCopy.pshare, //父目录的分享权限\n        created_id: userId,\n        created_at: nowAt,\n        updated_at: nowAt,\n        deleted_at: null,\n    }\n    var fileid = db.table(\"files\").insert(data);\n    log.info(\"执行到这里3\")\n    //\n    var pids = \'\';\n\n    log.info(\"pid value\" + pid)\n    var pid = fileCopy.pid //等于原来软件的pid\n\n    if (pid == 0 || pid == \'0\') { //特殊处理了\n        pids = \"/\" + fileid + \"/\";\n\n    } else {\n        // 获取父级的pids\n        var idPath = db.table(\'files\')\n            .where()\n            .eq(\"id\", pid)\n            .isNull(\'deleted_at\')\n            .selectOne();\n        log.info(\"idPath value\", idPath)\n        pids = idPath.idPath + fileid + \"/\"\n    }\n    db.table(\'files\').primary(\'id\').update({\n        id: fileid,\n        pids: pids,\n        id_path: pids\n    })\n    log.info(\"执行到这里4\")\n\n    //存储file_content \n    var content = {\n        \'from\': \'\',\n        \'type\': fileCopy.type,\n        \'ext\': fileCopy.ext,\n        \'url\': newObjectName\n    }\n    // 新增fileContent\n    var fileContentMap = {\n        fid: fileid,\n        content: JSONObject.toJSONString(content),\n        text: null, //TODO 这里应该都是null\n        size: fileCopy.fileSize,\n        userid: userId,\n        created_at: nowAt,\n        updated_at: nowAt\n    }\n\n    log.info(\"执行到这里5\")\n    var result = db.table(\'file_contents\')\n        .primary(\'id\', null)\n        .save(fileContentMap);\n    return result;\n});');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/打包文件.ms', '{\n  \"properties\" : { },\n  \"id\" : \"0d19b7e1121c4c8189e1871ae2739fb2\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"打包文件\",\n  \"createTime\" : 1720519095726,\n  \"updateTime\" : 1712671741459,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/download/pack\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"ids\",\n    \"value\" : null,\n    \"description\" : \"文件ID，格式: id, id2, id3\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : null,\n    \"description\" : \"下载文件名\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport cn.hutool.core.util.StrUtil;\n\n\nvar userId = StpUtil.getLoginId()\nvar fileName = null;\nif (StrUtil.isNotEmpty(name)) {\n    fileName = name.replaceAll(\"[/\\\\\\\\:*?\\\"<>|]\", \"\");\n}\nif (StrUtil.isEmpty(fileName)) {\n    fileName = \'Package_\' + userId;\n}\n\nfileName = fileName + \'_\' + date_format(new Date); + \'.zip\';\n\nif (StrUtil.isEmpty(ids)) {\n    exit 400, \'请选择下载的文件或文件夹\';\n}\nif (StrUtil.split(ids, \',\') > 100) {\n    exit 400, \'一次最多可以下载100个文件或文件夹\';\n}\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/搜索文件列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"6a75097a11534d4993c32b089060a090\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"搜索文件列表\",\n  \"createTime\" : 1720519095736,\n  \"updateTime\" : 1711870420274,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/search\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"link\",\n    \"value\" : null,\n    \"description\" : \"通过分享地址搜索（如：https://t.hitosea.com/single/file/ODcwOCwzOSxpa0JBS2lmVQ==）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"key\",\n    \"value\" : \"知识\",\n    \"description\" : \"关键词\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"id\\\": 17,\\n            \\\"pid\\\": 13,\\n            \\\"cid\\\": 0,\\n            \\\"NAME\\\": \\\"设计知识\\\",\\n            \\\"type\\\": \\\"folder\\\",\\n            \\\"ext\\\": \\\"\\\",\\n            \\\"size\\\": 0,\\n            \\\"userid\\\": 0,\\n            \\\"pshare\\\": 0,\\n            \\\"SHARE\\\": 1,\\n            \\\"created_id\\\": 0,\\n            \\\"created_at\\\": 1709741719000,\\n            \\\"url\\\": null,\\n            \\\"permission\\\": 1\\n        }\\n    ],\\n    \\\"timestamp\\\": 1711787038066,\\n    \\\"executeTime\\\": 3\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.util.StrUtil\nimport cn.hutool.core.util.ObjectUtil\nimport cn.hutool.core.util.StrUtil;\nimport cn.hutool.core.util.ReUtil;\nimport log;\nimport \'@/file/getFileListByPermission\' as getFileListByPermission;\n// 通过分享地址搜索（如：https://t.hitosea.com/single/file/ODcwOCwzOSxpa0JBS2lmVQ==）\n// 根据文件夹或者文件的名称来模糊匹配\n\n//TODO 这里需要处理\n// var userId = StpUtil.getLoginId()\nvar userId = \'1\';\n\n// 从请求中获取文件链接和搜索关键词，并去除空白字符\nvar linkStr = StrUtil.trim(link);\nvar name = StrUtil.trim(key);\n\n// 初始化文件ID和获取数量\nvar id = 0;\nvar take = 50;\n\n// 通过分享地址搜索\nvar fileId = null;\nif (StrUtil.isNotEmpty(linkStr)) {\n    // https://t.hitosea.com/single/file/ODcwOCwzOSxpa0JBS2lmVQ==\n    // 提取分享码:ODcwOCwzOSxpa0JBS2lmVQ==\n    String regex = \'/\\/single\\/file\\/(.*?)$/i\';\n    var code = ReUtil.get(regex, linkStr, 1);\n    var fileLink = db.table(\'file_links\')\n        .column(\'file_id\')\n        .where()\n        .eq(\'code \', code)\n        .selectOne();\n\n    if (ObjectUtil.isEmpty(fileLink) || StrUtil.isEmpty(fileLink.get(\'file_id\'))) {\n        return \'success\';\n    }\n    fileId = fileLink.get(\'file_id\');\n}\n\n// 搜索自己有权限看到的\nvar fileList = getFileListByPermission(name, fileId, userId, null);\nreturn fileList;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/添加或修改文件(夹).ms', '{\n  \"properties\" : { },\n  \"id\" : \"545553628b37411aa66cdf6a8979e5c9\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"添加或修改文件(夹)\",\n  \"createTime\" : 1720519095744,\n  \"updateTime\" : 1716776108999,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/add\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"name\",\n    \"value\" : \"测试文件3\",\n    \"description\" : \"项目名称\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : \"document\",\n    \"description\" : \"文件类型\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"id\",\n    \"value\" : \"0\",\n    \"description\" : \"文件ID（赋值修改文件名称）\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"pid\",\n    \"value\" : \"0\",\n    \"description\" : \"父级ID\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"url\",\n    \"value\" : null,\n    \"description\" : \"文件url\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"添加成功\\\",\\n    \\\"timestamp\\\": 1711943269761,\\n    \\\"executeTime\\\": 4222\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.util.ObjectUtil\nimport cn.hutool.core.util.StrUtil;\nimport \'@/file/handleDuplicateName\' as handleDuplicateName;\nimport \'@/file/permissionFind\' as permissionFind;\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log;\n\nvar userId = StpUtil.getLoginId();\n\nString trimmedName = StrUtil.trim(name);\nString trimmedType = StrUtil.trim(type);\n\nif (trimmedName.length() < 2) {\n    exit 400, \'文件名称不可以少于2个字\';\n} else if (trimmedName.length() > 32) {\n    exit 400, \'文件名称最多只能设置32个字\';\n}\n\nvar tmpName = trimmedName.replaceAll(\"[\\\\\\\\/:*?\\\"<>|]\", \"\");\nif (!tmpName.equals(trimmedName)) {\n    exit 400, \'\"文件名称不能包含这些字符：\\/:*?\\\"<>|\"\';\n}\n\nif (id > 0) {\n    // 修改\n    var file = permissionFind(userId, id, 1);\n    //  处理重名\n    var newName = handleDuplicateName(pid, userId, ext, trimmedName);\n    // 更新\n    var result = {\n        id: id,\n        name: newName\n    }\n    db.table(\'files\').primary(\'id\').update(result);\n    // todo 推送更新消息\n    return result;\n} else {\n    // 添加\n    if (![\n            \'folder\',\n            \'document\',\n            \'mind\',\n            \'drawio\',\n            \'word\',\n            \'excel\',\n            \'ppt\',\n        ].contains(trimmedType)) {\n        exit 400, \'类型错误\';\n    }\n\n    var extMap = {\n        \'folder\': null,\n        \'document\': \'md\',\n        \'mind\': \'mind\',\n        \'drawio\': \'drawio\',\n        \'word\': \'docx\',\n        \'excel\': \'xlsx\',\n        \'ppt\': \'pptx\',\n    }\n    var ext = extMap.get(trimmedType);\n    if (pid > 0) {\n        var fileNum = db.table(\"files\")\n            .where()\n            .eq(\'pid\', pid)\n            .isNull(\'deleted_at\')\n            .count();\n        if (fileNum > 300) {\n            exit 400, \'每个文件夹里最多只能创建300个文件或文件夹\';\n        }\n        // 在文件夹里面创建的文件或者文件夹，所有者都是上一级文件夹的\n        var file = permissionFind(userId, pid, 1);\n        userId = file.userid;\n    } else {\n        var fileNum = db.table(\"files\")\n            .where()\n            .eq(\'pid\', 0)\n            .isNull(\'deleted_at\')\n            .eq(\'userid\', userId)\n            .count();\n        if (fileNum >= 300) {\n            exit 400, \'每个文件夹里最多只能创建300个文件或文件夹\';\n        }\n    }\n\n    //  处理重名\n    var newName = handleDuplicateName(pid, userId, ext, trimmedName);\n    var result = db.transaction(() => {\n        var pshare = 0;\n        // pid !=0才去看父级共享状态\n        if (pid != 0) {\n            var pfolder = db.table(\'files\').where().isNull(\'deleted_at\').eq(\'id\', pid).selectOne();\n            if (ObjectUtil.isNotEmpty(pfolder)) {\n                if (pfolder.share == 1) {\n                    // 如果父级是共享的，那么就把父级的id带过来\n                    pshare = pfolder.id;\n                } else if (pfolder.pshare != 0) {\n                    // 如果父级的也是有pshare，那么就带过来\n                    pshare = pfolder.pshare;\n                }\n            }\n        }\n\n        // 保存\n        Date createdAt = new Date();\n        var id = db.table(\'files\')\n            .primary(\'id\')\n            .insert({\n                created_id: userId,\n                name: newName,\n                type: trimmedType,\n                pid: pid,\n                url: url,\n                ext: ext,\n                userid: userId,\n                created_at: createdAt,\n                updated_at: createdAt,\n                pshare: pshare\n            })\n        // 更新 pids和id_path字段\n        var pids = \'\';\n\n        if (pid == 0) {\n            pids = \"/\" + id + \"/\";\n        } else {\n            // 获取父级的pids\n            var idPath = db.table(\'files\')\n                .where()\n                .eq(\"id\", pid)\n                .isNull(\'deleted_at\')\n                .selectOne();\n            pids = idPath.id_path + id + \"/\"\n        }\n\n        db.table(\'files\').primary(\'id\').update({\n            id: id,\n            pids: pids,\n            id_path: pids\n        })\n\n        //TODO 插入文件用户表\n        res = db.table(\"file_users\").insert({\n            file_id: id,\n            userid: userId,\n            permission: 1\n        })\n        log.info(\"插入文件用户表\" + res)\n\n        return result = {\n            id: id,\n            created_id: userId,\n            name: newName,\n            type: trimmedType,\n            pid: pid,\n            url: url,\n            ext: ext,\n            userid: userId,\n            created_at: createdAt,\n            updated_at: createdAt,\n            deleted_at: null,\n            pshare: pshare,\n            pids: pids,\n            id_path: pids\n        };\n\n    });\n\n    // todo 发送添加成功消息\n    return result;\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/确认下载.ms', '{\n  \"properties\" : { },\n  \"id\" : \"a8df45d7cff74619a51d2b41fefcafbe\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"确认下载\",\n  \"createTime\" : 1720519095761,\n  \"updateTime\" : 1711282260454,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/download/confirm\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"name\",\n    \"value\" : null,\n    \"description\" : \"\\t 下载文件名\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/移动文件(夹).ms', '{\n  \"properties\" : { },\n  \"id\" : \"11942a42c5b5480f82aa3ccfd940d8e3\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"移动文件(夹)\",\n  \"createTime\" : 1720519095768,\n  \"updateTime\" : 1716773736027,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/move\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"pid\",\n    \"value\" : null,\n    \"description\" : \"移动到的文件夹ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"ids\",\n    \"value\" : null,\n    \"description\" : \"移动的文件夹ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"expression\",\n    \"error\" : \"请选择移动的文件或文件夹\",\n    \"expression\" : \"ids == null ||ids == \\\"\\\"\",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.util.StrUtil;\r\nimport \'@/file/permissionFind\' as permissionFind;\r\nimport \'@/file/handleDuplicateName\' as handleDuplicateName;\r\n\r\n// 检查一次移动的文件或文件夹数量是否超过限制（100个）\r\nvar idList = StrUtil.split(ids, \',\');\r\nif (idList.size() > 100) {\r\n    exit 400, \'一次最多只能移动100个文件或文件夹\';\r\n}\r\n\r\n// 判断是否移动到共享文件夹\r\nvar toShareFile = false;\r\nvar tmpShareFile = null;\r\nif (pid > 0) {\r\n    // 检查目标文件夹是否存在以及用户是否有权限\r\n    tmpShareFile = permissionFind(pid, userId, 1);\r\n    // 如果目标是一个共享文件夹，则获取共享信息\r\n    toShareFile = tmpFile.share == 1;\r\n}\r\n\r\n// 定义一个数组用于存储移动的文件对象\r\nvar files = [];\r\n// 使用数据库事务处理移动操作\r\nvar val = db.transaction(() => {\r\n    for (id in idList) {\r\n        // 获取文件对象并检查用户是否有权限\r\n        var file = permissionFind(id, userId, 1000);\r\n\r\n        if (pid > 0) {\r\n            // 如果移动到的是一个共享文件夹\r\n            if (toShareFile) {\r\n                // 检查文件是否已经在共享中或者包含共享文件\r\n                if (file.share == 1) {\r\n                    exit 400, \'当前正在共享，无法移动到另一个共享文件夹内\';\r\n                }\r\n\r\n                // 如果当前是文件夹，就检查当前文件夹下面是否有子项（文件或文件夹）被共享。\r\n                if (\"folder\".equals(file.type)) {\r\n                    var currIdPath = file.id_path;\r\n                    var subShareNum = db.selectInt(\"\"\"\r\n                    select count(*) from files where share=1 and id_path LIKE CONCAT( #{currIdPath}, \'%\' ) \r\n                    \"\"\")\r\n\r\n                    if (subShareNum > 0) {\r\n                        exit 400, file.name + \'内含有共享文件，无法移动到另一个共享文件夹内\';\r\n                    }\r\n\r\n                }\r\n\r\n                // 更新当前文件以及所有子文件的用户ID为共享文件夹的用户ID\r\n                var userid = tmpShareFile.userid;\r\n                var currIdPath = file.id_path;\r\n                db.update(\"\"\"update files set userid = #{userid} where id_path LIKE CONCAT( #{currIdPath}, \'%\' )\"\"\")\r\n            }\r\n\r\n            // 确保文件不是移动到自己的子文件夹中\r\n            var tmpId = pid;\r\n            while (tmpId > 0) {\r\n                if (id == tmpId) {\r\n                    exit 400, \'移动位置错误\';\r\n                }\r\n                tmpId = db.table(\'magic_api_info\')\r\n                    .column(\'pid\')\r\n                    .where()\r\n                    .eq(\'id\', tmpId)\r\n                    .selectOne()\r\n            }\r\n        } else {\r\n            // 如果移动到的根文件夹\r\n            // 更新当前文件以及所有子文件的用户ID为共享文件夹的用户ID\r\n            var userid = StpUtil.getLoginId();\r\n            var currIdPath = file.id_path;\r\n            db.update(\"\"\"update files set userid = #{userid} where id_path LIKE CONCAT( #{currIdPath}, \'%\' )\"\"\")\r\n        }\r\n\r\n        // 处理重名\r\n        var newName = handleDuplicateName(pid, userId, ext, trimmedName);\r\n        // 更新\r\n        db.table(\'files\').primary(\'id\').update({\r\n            id: file.id,\r\n            pid: pid,\r\n            name: newName\r\n        })\r\n\r\n        var newPshare = 0;\r\n        var currIdPath = file.id_path;\r\n        if (pid != 0) {\r\n            // 如果要移动的文件(夹)处于共享当中或不是共享,移动到的目标是共享的，把当前文件(夹)的pshare变成目标文件夹的id\r\n            if (file.share == 0 && tmpShareFile.share == 1) {\r\n                newPshare = tmpShareFile.id;\r\n            }\r\n            // 如果要移动的文件(夹)处于共享当中或不是共享,移动到的目标是处于共享中，把当前文件(夹)的pshare变成目标文件夹的pshare\r\n            if (file.share == 0 && tmpShareFile.share == 0 && tmpShareFile.pshare != 0) {\r\n                newPshare = tmpShareFile.pshare;\r\n            }\r\n\r\n            // 如果要移动的文件(夹)处于共享当中,移动到的目标是不是共享中，把当前文件(夹)的pshare变成0\r\n            if (file.share == 0 && tmpShareFile.share == 0 && tmpShareFile.pshare == 0) {\r\n                newPshare = 0;\r\n            }\r\n\r\n        } else {\r\n            // 处理文件(夹)处于共享中的，把当前文件(夹)的pshare变成0\r\n            if (file.share == 0 && file.pshare != 0) {\r\n                newPshare = 0;\r\n            }\r\n        }\r\n\r\n        // 批量更新pshare\r\n        db.update(\"\"\" update files set pshare = #{newPshare} where id_path LIKE CONCAT( #{currIdPath}, \'%\' )\"\"\")\r\n\r\n\r\n        // 处理pids和id_path,内存构建，批量更新\r\n        var updateFileList = db.select(\"\"\"\r\n        select id,id_path,pid from files where id_path LIKE CONCAT( #{currIdPath}, \'%\' )\r\n        \"\"\");\r\n\r\n        var updateFiles = [];\r\n        var swapPidStr = \"\";\r\n        if (pid != 0) {\r\n            swapPidStr = tmpShareFile.id_path + file.id + \"/\"\r\n        } else {\r\n            swapPidStr = \"/\" + file.id + \"/\"\r\n        }\r\n\r\n        for (item in updateFileList) {\r\n            // 使用replace方法替换字符串中的指定子串\r\n            var newIdPath = item.id_path.replace(file.id_path, swapPidStr);\r\n            updateFiles.add([newIdPath, newIdPath, item.id]);\r\n        }\r\n\r\n        db.batchUpdate(\"\"\"update files set id_path = ?,pids=? where id = ?\"\"\", updateFiles);\r\n        // 将文件对象添加到数组中\r\n        files.add(file);\r\n\r\n    }\r\n});\r\n\r\nreturn files;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/获取office的token.ms', '{\n  \"properties\" : { },\n  \"id\" : \"4d239358ed414d5193e77d041e4eb536\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"获取office的token\",\n  \"createTime\" : 1720519095777,\n  \"updateTime\" : 1716776089446,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/office/token\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"documentFileType\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"documentTitle\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"documentKey\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"documentUrl\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigMode\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigLang\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigUserId\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigUserName\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigCustomizationUiTheme\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigCustomizationForcesave\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigCustomizationHelp\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"editorConfigCustomizationCallbackUrl\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"eventsOnDocumentReady\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkb2N1bWVudCI6eyJmaWxlVHlwZSI6ImRvY3giLCJ0aXRsZSI6IuacquWRveWQjSAoMykuZG9jeCIsImtleSI6ImRvY3gtMzU4NTMtMTcxMzI0OTQxNCIsInVybCI6Imh0dHA6Ly9uZ2lueC9hcGkvZmlsZS9jb250ZW50Lz9pZD0zNTg1MyZ0b2tlbj1ZSUc4QU5DOHEyUWZRTXE4SlRUTHBTV1pIajB2aGJOMG9sWjJ0bF8xVlo4eW16cFc5b0xKcW9QaGt1cTkxakNOQktXUVZKU2dXX2VRSnpMMV9pZWtQQzVQa0YtZ1hfNTk2Sy1OZXZMaW55Qm9EcXR2d2FWaURzV3VMZlZNUzlTQk9wOC0xc2huakMwIn0sImVkaXRvckNvbmZpZyI6eyJtb2RlIjoiZWRpdCIsImxhbmciOiJ6aCIsInVzZXIiOnsiaWQiOiIyNzE4IiwibmFtZSI6InJvbyoqKkBkb290YXNrLmNvbSJ9LCJjdXN0b21pemF0aW9uIjp7InVpVGhlbWUiOiJ0aGVtZS1jbGFzc2ljLWxpZ2h0IiwiZm9yY2VzYXZlIjoidHJ1ZSIsImhlbHAiOiJmYWxzZSJ9LCJjYWxsYmFja1VybCI6Imh0dHA6Ly9uZ2lueC9hcGkvZmlsZS9jb250ZW50L29mZmljZT9pZD0zNTg1MyZkb290YXNrLXRva2VuPVlJRzhBTkM4cTJRZlFNcThKVFRMcFNXWkhqMHZoYk4wb2xaMnRsXzFWWjh5bXpwVzlvTEpxb1Boa3VxOTFqQ05CS1dRVkpTZ1dfZVFKekwxX2lla1BDNVBrRi1nWF81OTZLLU5ldkxpbnlCb0RxdHZ3YVZpRHNXdUxmVk1TOVNCT3A4LTFzaG5qQzAifSwiZXZlbnRzIjp7Im9uRG9jdW1lbnRSZWFkeSI6ImZ1bmN0aW9uICgpIHsgW25hdGl2ZSBjb2RlXSB9In19.s6NPbLhYL3Aaf3SDct5WX2xU6t1j98ymkDYTQARZzBo\\\",\\n    \\\"timestamp\\\": 1714014539164,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.jwt.JWTUtil;\r\nimport log;\r\nimport request;\r\nvar secret = \"10000\";\r\n\r\nvar payload = {\r\n    \"document\": {\r\n        \"fileType\": documentFileType,\r\n        \"title\": documentTitle,\r\n        \"key\": documentKey,\r\n        \"url\": documentUrl\r\n    },\r\n    \"editorConfig\": {\r\n        \"mode\": editorConfigMode,\r\n        \"lang\": editorConfigLang,\r\n        \"user\": {\r\n            \"id\": editorConfigUserId,\r\n            \"name\": editorConfigUserName\r\n        },\r\n        \"customization\": {\r\n            \"uiTheme\": editorConfigCustomizationUiTheme,\r\n            \"forcesave\": editorConfigCustomizationForcesave,\r\n            \"help\": editorConfigCustomizationHelp\r\n        },\r\n        \"callbackUrl\": editorConfigCustomizationCallbackUrl\r\n    },\r\n    \"events\": {\r\n        \"onDocumentReady\": eventsOnDocumentReady\r\n    }\r\n};\r\n\r\ntry {\r\n    return {\r\n        \"token\": JWTUtil.createToken(payload, secret.getBytes())\r\n    };\r\n} catch (e) {\r\n    return \"\";\r\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/获取共享信息.ms', '{\n  \"properties\" : { },\n  \"id\" : \"a393d4eb15d94c21813ee3373e4a3513\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"获取共享信息\",\n  \"createTime\" : 1720519095784,\n  \"updateTime\" : 1712152187435,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/share\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : null,\n    \"description\" : \"文件id\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\'; \nimport cn.hutool.core.util.ObjectUtil;\nimport log;\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\nvar userId = StpUtil.getLoginId();\n\n//文件复制\nvar file = db.table(\"files\").where().eq(\"id\",id).selectOne();\nif (ObjectUtil.isEmpty(file)) {\n    exit 400, \'文件不存在或已被删除\';\n}\nif(file.userid!=userId){\n    exit 400, \'仅限所有者操作\';\n}\nvar list = db.table(\"file_users\").where().eq(\"file_id\",id).select();\n//返回的信息需要处理，暂时不知道怎么弄\nvar result = {}\nresult.id = file.id;\nresult.list = list;\nreturn result;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/获取单条数据.ms', '{\n  \"properties\" : { },\n  \"id\" : \"42dcd423e3cc4a679714ec89595d9ec1\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"获取单条数据\",\n  \"createTime\" : 1720519095791,\n  \"updateTime\" : 1712148573052,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/one\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"18\",\n    \"description\" : \"Number 文件ID（需要登录） String 链接码（不需要登录，用于预览）\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"id\\\": 18,\\n            \\\"pid\\\": 17,\\n            \\\"id_path\\\": \\\"/13/17/18\\\",\\n            \\\"cid\\\": 0,\\n            \\\"NAME\\\": \\\"文件1\\\",\\n            \\\"type\\\": \\\"picture\\\",\\n            \\\"ext\\\": \\\"png\\\",\\n            \\\"size\\\": 0,\\n            \\\"userid\\\": 0,\\n            \\\"pshare\\\": 17,\\n            \\\"SHARE\\\": 0,\\n            \\\"created_id\\\": 0,\\n            \\\"created_at\\\": null,\\n            \\\"url\\\": null,\\n            \\\"permission\\\": 1\\n        }\\n    ],\\n    \\\"timestamp\\\": 1711935320433,\\n    \\\"executeTime\\\": 8\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.util.ObjectUtil;\nimport cn.hutool.core.collection.CollUtil;\nimport cn.hutool.core.util.StrUtil;\nimport cn.hutool.core.util.NumberUtil;\nimport \'@/file/permissionFind\' as permissionFind;\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\nif (NumberUtil.isNumber(id)) {\n   var userId = StpUtil.getLoginId()\n    // 根据文件ID查询（需要登录）\n    return permissionFind(id, userId, 0);\n} else if (StrUtil.isNotEmpty(id)) {\n    // 根据链接码查询（不需要登录，用于预览）\n    var fileId = db.selectValue(\"\"\"\n    select file_id from file_links where code = #{id}\n    \"\"\");\n\n    if (ObjectUtil.isEmpty(fileId)) {\n        exit 400, \'链接不存在\';\n    }\n\n    var file = db.table(\'files\')\n        .where()\n        .isNull(deleted_at)\n        .eq(\'id\', fileId)\n        .selectOne();\n\n    if (ObjectUtil.isEmpty(file)) {\n        exit 400, \'链接不存在\';\n    }\n\n    // 默认给查看权限\n    if (ObjectUtil.isNotEmpty(file)) {\n        file.put(\'permission\', 0)\n    }\n\n    return file;\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/获取文件内容.ms', '{\n  \"properties\" : { },\n  \"id\" : \"d8a0a799c09a4a408177200f5d576175\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"获取文件内容\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720634979473,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/content\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"110\",\n    \"description\" : \"Number: 文件ID（需要登录） String: 链接码（不需要登录，用于预览）\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"only_update_at\",\n    \"value\" : null,\n    \"description\" : \"仅获取update_at字段  no (默认) yes\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : \"\",\n    \"children\" : null\n  }, {\n    \"name\" : \"down\",\n    \"value\" : \"\",\n    \"description\" : \"直接下载  no: 浏览（默认） yes: 下载（office文件直接下载，除非是preview） preview: 转预览地址\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"history_id\",\n    \"value\" : null,\n    \"description\" : \"读取历史记录ID\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport org.ssssssss.magicboot.utils.MinioUtil\n// import org.ssssssss.magicboot.utils.WatermarkUtil\n// import org.ssssssss.magicboot.utils.WatermarkUtils\nimport com.google.gson.JsonObject\nimport cn.hutool.core.util.NumberUtil;\nimport cn.hutool.core.util.ObjectUtil;\nimport cn.hutool.core.collection.CollUtil;\nimport cn.hutool.core.util.StrUtil;\nimport response;\nimport java.net.URLEncoder;\nimport \'@/file/permissionFind\' as permissionFind;\nimport cn.dev33.satoken.stp.StpUtil;\nimport cn.hutool.core.io.FileUtil;\nimport log;\n\nvar file = null;\nvar userId\nvar fileId\n// var id = 107::int\n// if (NumberUtil.isNumber(id)) {\nif (id !== null) {\n    fileId = id::int\n    //根据token获取是哪个用户\n    if (token !== null) {\n        userId = StpUtil.getLoginIdByToken(token)\n    } else {\n        userId = StpUtil.getLoginId();\n    }\n    // userId = 6; //测试时候打开\n    // 根据文件ID查询（需要登录）\n    log.info(\"id.......------------------------------------------》\" + id);\n    log.info(\"token.......------------------------------------------》\" + token);\n    log.info(\"userId.......------------------------------------------》\" + userId);\n    file = permissionFind(userId, fileId, \"yes\".equals(down) ? 1 : 0);\n} else if (StrUtil.isNotEmpty(id)) {\n    // 如果参数不为空，根据链接码查找文件id\n    var fileId = db.selectValue(\"\"\"\n    select file_id from file_links where code = #{id}\n    \"\"\");\n    if (StrUtil.isEmpty(fileId)) {\n        exit 400, \'文件链接不存在\';\n    }\n    // 根据文件id查出文件\n    file = db.table(\'files\')\n        .where()\n        .isNull(\'deleted_at\')\n        .eq(\'id\', fileId)\n        .selectOne();\n\n    if (ObjectUtil.isEmpty(file)) {\n        exit 400, \'文件链接不存在\';\n    }\n\n    // 默认给查看权限\n    if (ObjectUtil.isNotEmpty(file)) {\n        file.put(\'permission\', 0)\n    }\n\n} else {\n    exit 400, \'参数错误\';\n}\n\n\n// 如果请求仅为更新时间，则返回文件更新时间和文件id\nif (\"yes\".equals(only_update_at)) {\n    var result = {\n        \"id\": file.id,\n        \"update_at\": file.updated_at\n    };\n    return result;\n}\n\n// 否则，获取文件内容\nvar fileContent = db.table(\'file_contents\')\n    .where()\n    .isNull(\'deleted_at\')\n    .eq(\'fid\', file.id)\n    .orderByDesc(\'id\')\n    .selectOne();\nlog.info(\"fileContent-->\" + fileContent)\n\n// 设置文件名，如果存在文件扩展名，则将扩展名添加到文件名中\nString fileName = StrUtil.isNotEmpty(file.ext) ? (file.name + \'.\' + file.ext) : \"\";\n// 确保文件名正确地包含扩展名\nif (StrUtil.isNotEmpty(fileName) && !fileName.contains(\'.\')) {\n    fileName += \'.\';\n}\n\n// 检查文件类型是否为word、excel或ppt\nvar fileTypeArray = [\'word\', \'excel\', \'ppt\'];\nvar fileTypeMap = {\n    \'word\': \'docx\',\n    \'excel\': \'xlsx\',\n    \'ppt\': \'pptx\'\n};\nconst codeExt = [\n    \'txt\',\n    \'htaccess\', \'htgroups\', \'htpasswd\', \'conf\', \'bat\', \'cmd\', \'cpp\', \'c\', \'cc\', \'cxx\', \'h\', \'hh\', \'hpp\', \'ino\', \'cs\', \'css\',\n    \'dockerfile\', \'go\', \'golang\', \'html\', \'htm\', \'xhtml\', \'vue\', \'we\', \'wpy\', \'java\', \'js\', \'jsm\', \'jsx\', \'json\', \'jsp\', \'less\', \'lua\', \'makefile\', \'gnumakefile\',\n    \'ocamlmakefile\', \'make\', \'mysql\', \'nginx\', \'ini\', \'cfg\', \'prefs\', \'m\', \'mm\', \'pl\', \'pm\', \'p6\', \'pl6\', \'pm6\', \'pgsql\', \'php\',\n    \'inc\', \'phtml\', \'shtml\', \'php3\', \'php4\', \'php5\', \'phps\', \'phpt\', \'aw\', \'ctp\', \'module\', \'ps1\', \'py\', \'r\', \'rb\', \'ru\', \'gemspec\', \'rake\', \'guardfile\', \'rakefile\',\n    \'gemfile\', \'rs\', \'sass\', \'scss\', \'sh\', \'bash\', \'bashrc\', \'sql\', \'sqlserver\', \'swift\', \'ts\', \'typescript\', \'str\', \'vbs\', \'vb\', \'v\', \'vh\', \'sv\', \'svh\', \'xml\',\n    \'rdf\', \'rss\', \'wsdl\', \'xslt\', \'atom\', \'mathml\', \'mml\', \'xul\', \'xbl\', \'xaml\', \'yaml\', \'yml\',\n    \'asp\', \'properties\', \'gitignore\', \'log\', \'bas\', \'prg\', \'python\', \'ftl\', \'aspx\', \'plist\'\n];\n\nconst officeExt = [\n    \'doc\', \'docx\',\n    \'xls\', \'xlsx\',\n    \'ppt\', \'pptx\',\n];\n\n// 将文件内容解析为json对象,这里是fileContent的content字段\nvar contentJsonObject = ObjectUtil.isNotEmpty(fileContent) && StrUtil.isNotEmpty(fileContent.content) ? fileContent.content::json : null;\n\n// if (fileContent!=null){\n//     contentJsonObject = fileContent.content    \n// }\n\n// 转到预览地址\nif (\'preview\'.equals(down)) {\n    var filePath = fileContent.url;\n    // 针对word，excel，ppt的处理\n    if (fileTypeArray.contains(file.type)) {\n        if (ObjectUtil.isEmpty(contentJsonObject) || StrUtil.isEmpty(contentJsonObject)) {\n            log.info(\"preview-contentJsonObject--->\", contentJsonObject);\n            filePath = \'empty.\' + fileTypeMap.get(file.type);\n        }\n        // todo 这里还需要做预览处理\n    }\n}\n\n// 针对word，excel，ppt的处理\nif (fileTypeArray.contains(file.type)) {\n    // 如果文件内容为空，则返回包含空白文件的下载响应\n    if (ObjectUtil.isEmpty(contentJsonObject)) {\n        log.info(\"contentJsonObject--->\", contentJsonObject);\n        return response.download(null, \'empty.\' + fileTypeMap.get(file.type));\n    }\n\n    log.info(\"否则，返回包含文件内容的下载响应--->\");\n    //要区分是docx\n    var fileUrl = file.url\n    var firstIndex = fileUrl.indexOf(\".\")\n    var prefix = fileUrl.substring(0, firstIndex)\n    var suffix = fileUrl.substring(firstIndex, fileUrl.length())\n    log.info(\"prefix-->\" + prefix)\n    log.info(\"suffix-->\" + suffix)\n    File tempFile = FileUtil.createTempFile(prefix, suffix, FileUtil.getTmpDir());\n    FileUtil.writeBytes(MinioUtil.download(fileUrl), tempFile);\n\n    log.info(\"tempFile url -->\" + tempFile.getAbsolutePath())\n    log.info(\"FileUtil.getTmpDir() url -->\" + FileUtil.getTmpDir())\n    const outPath = FileUtil.getTmpDir() + \"/out\" + suffix\n    log.info(\"outPath url -->\" + outPath)\n    // if (file.ext = \"docx\") {\n    //     WatermarkUtil.waterMarkDocXDocument(tempFile.getAbsolutePath(), outPath, \"一级受控文件\");\n    //     let bytes = FileUtil.readBytes(outPath);\n    //     return response.download(bytes, fileName); \n    // } else {\n    return response.download(MinioUtil.download(file.url), fileName);\n    // }\n\n\n}\n\n// 如果文件内容为空\nif (ObjectUtil.isEmpty(contentJsonObject)) {\n    contentJsonObject = {};\n    // 根据文件类型为document，则设置默认内容\n    if (\"document\".equals(file.type)) {\n        contentJsonObject = {\n            type: file.ext,\n            content: \"\"\n        }\n    }\n\n    // 可能网络异常，没存成功，不给下载\n    if (\"yes\".equals(down)) {\n        exit 403, \'This file is empty.\';\n    }\n\n} else {\n    // 如果文件存在扩展名\n    if (StrUtil.isNotEmpty(file.ext)) {\n        // 设置文件内容,格式化内容数据\n        if (\"md\".equals(file.ext) || \"text\".equals(file.ext)) {\n            // 文本\n            contentJsonObject = {\n                \'type\': file.ext,\n                \'content\': ObjectUtil.isNotEmpty(contentJsonObject) && StrUtil.isNotEmpty(contentJsonObject.get(\'content\')) ? contentJsonObject.get(\'content\') : \'Content deleted\'\n            }\n        } else if (\"drawio\".equals(file.ext)) { // 图表\n            contentJsonObject = contentJsonObject;\n        } else if (\"mind\".equals(file.ext)) { // 思维导图\n            contentJsonObject = ObjectUtil.isNotEmpty(contentJsonObject) ? contentJsonObject : {};\n        } else {\n            // 其他预览\n            // 检查文件扩展名是否在允许的代码文件扩展名数组中，并且文件大小小于2MB\n            if (codeExt.contains(file.ext) && file.size << 2 * 1024 * 1024) {\n                contentJsonObject = {\n                    \'content\': ObjectUtil.isNotEmpty(contentJsonObject) && StrUtil.isNotEmpty(contentJsonObject.get(\'content\')) ? contentJsonObject : \'Content deleted\'\n                }\n            } else if (officeExt.contains(file.ext)) {\n                // office预览\n                contentJsonObject = {\n                    \'content\': {}\n                }\n            } else {\n                // 其他预览\n                contentJsonObject = {\n                    \'preview\': true,\n                    \'name\': fileName,\n                    \'key\': file.id\n                }\n                // todo file_mode?  $data[\'file_mode\'] = \'preview\';\n            }\n        }\n\n\n    } else {\n        // 如果文件没有扩展名，则设置预览标志为false\n        content[\'preview\'] = false;\n    }\n\n    // 如果请求下载文件\n    if (\"yes\".equals(down)) {\n        // 如果文件路径存在\n        if (StrUtil.isNotEmpty(file.url)) {\n            log.info(\"file.url={}\", file.url);\n            // 返回文件下载响应\n            log.info(\"返回文件下载响应--->\");\n            //要区分是docx\n            var fileUrl = file.url\n            var firstIndex = fileUrl.indexOf(\".\")\n            var prefix = fileUrl.substring(0, firstIndex)\n            var suffix = fileUrl.substring(firstIndex, fileUrl.length())\n            log.info(\"prefix-->\" + prefix)\n            log.info(\"suffix-->\" + suffix)\n            File tempFile = FileUtil.createTempFile(prefix, suffix, FileUtil.getTmpDir());\n            FileUtil.writeBytes(MinioUtil.download(fileUrl), tempFile);\n\n            log.info(\"tempFile url -->\" + tempFile.getAbsolutePath())\n            log.info(\"FileUtil.getTmpDir() url -->\" + FileUtil.getTmpDir())\n            const outPath = FileUtil.getTmpDir() + \"/out\" + suffix\n            log.info(\"outPath url -->\" + outPath)\n            //WatermarkUtil.waterMarkDocXDocument(tempFile.getAbsolutePath(), outPath, \"一级受控文件\");\n\n            // if (file.ext == \'pdf\') {\n            //     WatermarkUtils.addPDFWaterMark(tempFile.getAbsolutePath(), outPath, \"一级受控文件\");\n            // } else if (file.ext == \'docx\') {\n            //     WatermarkUtil.waterMarkDocXDocument(tempFile.getAbsolutePath(), outPath, \"一级受控文件\");\n            // }\n\n        }\n\n\n        // let bytes = FileUtil.readBytes(outPath);\n        // return response.download(bytes, fileName);\n\n        return response.download(MinioUtil.download(file.url), fileName);\n    } else {\n        // 否则，返回403错误\n        exit 403, \'This file not support download.\';\n    }\n}\n\nvar result = {\n    content: contentJsonObject\n}\nreturn result;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/获取文件列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"cbcf20b412f54f62907a7d31287c533e\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"获取文件列表\",\n  \"createTime\" : 1720519095805,\n  \"updateTime\" : 1717055458144,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"lists\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"pid\",\n    \"value\" : \"0\",\n    \"description\" : \"父级id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"0\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [],\\n    \\\"timestamp\\\": 1717055443713,\\n    \\\"executeTime\\\": 203\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'@/file/getFileListByPermission\' as getFileListByPermission;\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport org.ssssssss.magicboot.utils.MinioUtil;\nimport log;\nimport env;\n\nvar userId = StpUtil.getLoginId()\n\n//检查文件并创建桶\nvar bucketName = env.get(\'minio.bucketName\')\nlog.info(\"env bucketName-->\"+bucketName)\nMinioUtil.checkBucket(bucketName)\n\n\nvar fileList = getFileListByPermission(null, null, userId,pid);\nlog.info(\'fileList:\' + fileList);\nreturn fileList;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/获取链接.ms', '{\n  \"properties\" : { },\n  \"id\" : \"4ec2689bd2f14c24842d9cd1f02531ce\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"获取链接\",\n  \"createTime\" : 1720519095811,\n  \"updateTime\" : 1716521617975,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/link\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : null,\n    \"description\" : \"文件ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"refresh\",\n    \"value\" : null,\n    \"description\" : \"刷新链接  no: 只获取（默认） yes: 刷新链接，之前的将失效\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 400,\\n    \\\"message\\\": \\\"参数[id]为必填项\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711468246717,\\n    \\\"executeTime\\\": 0\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport \'@/file/permissionFind\' as permissionFind;\nimport log;\n//TODO 这里需要处理\n//var userId = StpUtil.getLoginId();\nvar userId = 0;\n\n// 权限校验\nvar file = permissionFind(id, userId, 0);\nif (\"folder\".equals(file.type)) {\n    exit 400, \'文件夹不支持分享\';\n}\n\n// var fileLinks = db.table(\"file_links\").where().eq(\"userid\", userId).select();\n// var result = {};\n// result.fileLinks = fileLinks;\nreturn result;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/设置共享.ms', '{\n  \"properties\" : { },\n  \"id\" : \"74037d02388944a8bb8019b84cea45c8\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"设置共享\",\n  \"createTime\" : 1720519095818,\n  \"updateTime\" : 1712199271453,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/share/update\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"\",\n    \"description\" : \"\\t 文件ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"userids\",\n    \"value\" : \"\",\n    \"description\" : \"共享成员，格式: userid1, userid2, userid3(-1代表所有人)\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"permission\",\n    \"value\" : \"\",\n    \"description\" : \"共享方式  0：只读 1：读写 -1: 删除\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"force\",\n    \"value\" : null,\n    \"description\" : \"\\t 设置共享时是否忽略提醒  0：如果子文件夹已存在共享则ret返回-3001（默认） 1：忽略提醒\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 58,\\n        \\\"pid\\\": 0,\\n        \\\"id_path\\\": \\\"/58/\\\",\\n        \\\"url\\\": null,\\n        \\\"pids\\\": \\\"/58/\\\",\\n        \\\"cid\\\": 0,\\n        \\\"name\\\": \\\"文件架子\\\",\\n        \\\"type\\\": \\\"folder\\\",\\n        \\\"ext\\\": null,\\n        \\\"size\\\": 0,\\n        \\\"userid\\\": 1,\\n        \\\"share\\\": 0,\\n        \\\"pshare\\\": 0,\\n        \\\"created_id\\\": 1,\\n        \\\"created_at\\\": 1711794059000,\\n        \\\"updated_at\\\": null,\\n        \\\"deleted_at\\\": null\\n    },\\n    \\\"timestamp\\\": 1711805851305,\\n    \\\"executeTime\\\": 63\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport org.apache.poi.hpsf.Date\nimport cn.hutool.core.util.StrUtil\nimport cn.hutool.core.util.ObjectUtil;\nimport \'@/file/updataShare\' as updataShare\nimport java.util.Date;\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\nvar userId = StpUtil.getLoginId()\n\nif (![-1, 0, 1].contains(permission)) {\n    exit 400, \'参数错误\';\n}\n\nvar file = db.table(\'files\')\n    .where()\n    .isNull(deleted_at)\n    .eq(\'id\', id)\n    .selectOne();\n\nif (ObjectUtil.isEmpty(file)) {\n    exit 400, \'文件不存在或已被删除\';\n}\n\nif (ObjectUtil.isEmpty(userId) || userId.equals(file.userid)) {\n    exit 400, \'仅限所有者操作\';\n}\n// 如果当前文件（夹）的父级文件已经被共享，那么当前文件（夹）无法重复共享\nif (file.pshare != 0) {\n    String fileTypeMessage = \'folder\'.equals(file.type) ? \'文件夹\' : \'文件\';\n    var pfolder = db.table(\'files\')\n        .where()\n        .isNull(deleted_at)\n        .eq(\'id\', file.pshare)\n        .selectOne();\n    exit 400, \"此\" + fileTypeMessage + \"已经处于【\" + pfolder.name + \"】共享文件夹中，无法重复共享\";\n}\n\nif (StrUtil.isEmpty(userids)) {\n    exit 400, \'请选择共享对象\';\n}\n\nif (-1 == permission) {\n    // 取消某些人的共享,开启事务\n    var val = db.transaction(() => {\n        // 删除指定共享成员\n        db.table(\'file_users\')\n            .where()\n            .eq(\'file_id\', file.id)\n            .in(\'userid\', StrUtil.split(userids, \',\'))\n            .delete();\n        // 同时删除成员分享的链接\n        db.table(\'file_links\')\n            .where()\n            .eq(\'file_id\', file.id)\n            .in(\'userid\', StrUtil.split(userids, \',\'))\n            .delete();\n        updataShare(file);\n    });\n} else {\n    // 设置共享\n    // 此文件夹内已有共享文件夹,就不能共享了\n    var isSubShare = db.select(\"\"\"\n    select EXISTS (\n        select 1 from files \n        where id_path LIKE CONCAT(#{file.id_path}, \'%\') \n        and share = 1 \n        and deleted_at is null\n        and id <>#{id}\n        ) as isSubShare\n    \"\"\");\n\n    if (isSubShare.isSubShare == 1) {\n        exit - 3001, \'此文件夹内已有共享文件夹\';\n    }\n\n    // 共享人数上限100个成员\n    var shareNum = db.table(\'file_users\').where().eq(\'file_id\', file.id).count() + StrUtil.split(userids, \',\').size();\n    if (shareNum > 100) {\n        exit 400, \'共享人数上限100个成员\';\n    }\n\n    var val = db.transaction(() => {\n        // 增加或者更新权限\n        for (userid in StrUtil.split(userids, \',\')) {\n            var fileUser = db.table(\'file_users\')\n                .where()\n                .eq(\'file_id\', id)\n                .eq(\'userid\', userid)\n                .selectOne();\n            // 数据库有的就是更新，没有就是新增\n            Date created = (ObjectUtil.isNull(fileUser) || ObjectUtil.isNull(fileUser.created_at) )? new Date() : fileUser.created_at;\n            db.table(\'file_users\')\n                .primary(\'id\')\n                .save({\n                    id: ObjectUtil.isNull(fileUser) ? null : fileUser.id,\n                    file_id: file.id,\n                    userid: userid,\n                    permission: permission,\n                    created_at: created\n                });\n        }\n        updataShare(file);\n    });\n}\n\n// todo 推送消息\n\nreturn file;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/退出共享.ms', '{\n  \"properties\" : { },\n  \"id\" : \"9ebe9929409943c09805c4ee55943ac5\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"退出共享\",\n  \"createTime\" : 1720519095826,\n  \"updateTime\" : 1711870423933,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/share/out\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"58\",\n    \"description\" : \"\\t 文件ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"退出成功\\\",\\n    \\\"timestamp\\\": 1711796619542,\\n    \\\"executeTime\\\": 55\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'@/file/updataShare\' as updataShare;\nimport \'@/file/permissionFind\' as permissionFind;\n\n//TODO 这里需要处理\n// var userId = StpUtil.getLoginId()\nvar userId = \'3\';\n\n// 验证权限\nvar file = permissionFind(id, userId, 0);\n\nif (userId.equals(file.userid)) {\n    exit 400, \'不能退出自己共享的文件\';\n}\n\n// 无法退出共享所有人的文件或文件夹\nvar num = db.table(\'file_users\').where().eq(\'userid\', -1).eq(\'file_id\', file.id).count()\nif (num > 0) {\n    exit 400, \'无法退出共享所有人的文件或文件夹\';\n}\n\ndb.transaction(() => {\n    db.table(\'file_users\')\n        .where()\n        .eq(\'file_id\', file.id)\n        .eq(\'userid\', userId)\n        .delete();\n    // 同时删除成员分享的链接\n    db.table(\'file_links\')\n        .where()\n        .eq(\'file_id\', file.id)\n        .eq(\'userid\', userId)\n        .delete();\n    updataShare(file);\n});\n\n\nreturn \'退出成功\';');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/文件/预览图片.ms', '{\n  \"properties\" : { },\n  \"id\" : \"c87e3a0463684f0ca79a2b1299d1f491\",\n  \"script\" : null,\n  \"groupId\" : \"7cc0839b044d4ab3a208aaf2142fbd7f\",\n  \"name\" : \"预览图片\",\n  \"createTime\" : 1720519095838,\n  \"updateTime\" : 1712649651388,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/preview/{id}\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"fileName\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport cn.hutool.core.util.ObjectUtil\nimport log;\nimport request;\nimport response;\nimport org.ssssssss.magicboot.utils.MinioUtil;\n\nlog.info(\"id={}\", path.id);\nlog.info(\"fileName={}\", fileName);\n\nvar file = db.table(\'files\')\n    .where()\n    .isNull(deleted_at)\n    .eq(\'id\', path.id)\n    .selectOne();\n\nif (ObjectUtil.isEmpty(file)) {\n    exit 400, \'预览失败\';\n}\n\nMinioUtil.previewfile(file.url, file.name + \".\" + file.ext, response.getOutputStream())\n\nresponse.end();');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"用户\",\n  \"type\" : \"api\",\n  \"parentId\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"path\" : \"/users\",\n  \"createTime\" : 1720519095306,\n  \"updateTime\" : 1713024589759,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/会员列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"10fc52dac0b44738ab40cc3705f6c0c2\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"会员列表\",\n  \"createTime\" : 1720519095847,\n  \"updateTime\" : 1713325114397,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/lists\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"keys[department]\",\n    \"value\" : \"27\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"d625f2aa-4130-40d6-9e8a-7d89f44422a6\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"data\\\": [\\n            {\\n                \\\"userid\\\": 2,\\n                \\\"identity\\\": \\\",\\\",\\n                \\\"department\\\": [\\n                    \\\"27\\\"\\n                ],\\n                \\\"az\\\": \\\"T\\\",\\n                \\\"pinyin\\\": \\\"\\\",\\n                \\\"email\\\": \\\"test@autoo.com\\\",\\n                \\\"tel\\\": \\\"\\\",\\n                \\\"nickname\\\": \\\"测试人员\\\",\\n                \\\"profession\\\": \\\"测试员\\\",\\n                \\\"userimg\\\": \\\"\\\",\\n                \\\"encrypt\\\": \\\"18cZzh\\\",\\n                \\\"password\\\": \\\"7eedd4cbf70da996d21f641bcc6cb412\\\",\\n                \\\"changepass\\\": 0,\\n                \\\"login_num\\\": 63,\\n                \\\"last_ip\\\": \\\"127.0.0.1\\\",\\n                \\\"last_at\\\": 1704952511000,\\n                \\\"line_ip\\\": \\\"127.0.0.1\\\",\\n                \\\"line_at\\\": 1704952511000,\\n                \\\"task_dialog_id\\\": 16,\\n                \\\"created_ip\\\": \\\"\\\",\\n                \\\"disable_at\\\": null,\\n                \\\"email_verity\\\": true,\\n                \\\"bot\\\": 0,\\n                \\\"created_at\\\": \\\"2024-01-11 07:58:45\\\",\\n                \\\"updated_at\\\": 1704952531000,\\n                \\\"nickname_original\\\": \\\"测试人员\\\"\\n            }\\n        ]\\n    },\\n    \\\"timestamp\\\": 1709028657874,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\n//TODO 搜索部分未完成\nimport log\nimport request;\n\nvar dbBuilder = db.table(\"users\").where().isNull(\"disable_at\").eq(\"bot\", 0).orderByDesc(\"userid\")\n\n//只能这样子处理了\n// let department = request.getValues(\'keys[department]\')\n// log.info(\"keys11111111：\" + par)\nif (department != null && department != \"\") {\n    dbBuilder.like(\"department\", \'%\' + depa + \'%\')\n}\n\nvar users = dbBuilder.select()\n\nfor (item in users) {\n    log.info(\"item\" + item)\n    item.nickname_original = item.nickname\n    if (item.department == \"\" || item.department == null) {\n        log.info(\"item.department is null\")\n        item.department = []\n        //显示部门id\n    } else { //处理成数组\n        log.info(\"item department\" + item.department)\n        item.department = item.department.split(\',\')\n    }\n\n    if (item.identity == \"\") {\n        log.info(\"item.department is null\")\n        item.identity = []\n        //显示部门id \n    }\n\n\n    // if (item.identity = \"\") {\n    //     item.identity = identity\n\n    // }\n}\n\n\n// if (isset($keys[\'department\'])) {\n//                 if ($keys[\'department\'] == \'0\') {\n//                     $builder->where(function($query) {\n//                         $query->where(\"department\", \"\")->orWhere(\"department\", \",,\");\n//                     });\n//                 } else {\n//                     // 关联user_departments表中owner_userid查询出负责人，重新排序，部门负责人始终在前面\n//                     $builder->where(function($query) use ($keys) {\n//                         $query->where(\"department\", \"like\", \"%,{$keys[\'department\']},%\");\n//                         $query->orWhereIn(\'userid\', function ($query) use ($keys) {\n//                             $query->select(\'owner_userid\')->from(\'user_departments\')->where(\"id\", \"=\", trim($keys[\'department\'], \',\'));\n//                         });\n//                     });\n//                     $prefix = \\DB::getTablePrefix();\n//                     $builder->selectRaw(\"if(EXISTS(select id from {$prefix}user_departments where owner_userid = userid and id={$keys[\'department\']}),1,0) as is_principal\");\n//                     $builder->orderBy(\"is_principal\",\"desc\");\n//                 }\n//             }\n\n\nvar result = {}\nresult.data = users\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/修改自己的密码.ms', '{\n  \"properties\" : { },\n  \"id\" : \"36a61e05ad9e47d2b7d348c564123c66\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"修改自己的密码\",\n  \"createTime\" : 1720519095853,\n  \"updateTime\" : 1713325119691,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/editpass\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"oldpass\",\n    \"value\" : \"d5073d1ab6e1a1e5\",\n    \"description\" : \"旧密码\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"newpass\",\n    \"value\" : \"123456\",\n    \"description\" : \"新密码\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"4e372647-874d-4421-90d7-0913fefec368\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711455078427,\\n    \\\"executeTime\\\": 9\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\nimport \'cn.dev33.satoken.secure.SaSecureUtil\';\n\nvar userid = StpUtil.getLoginId()\nlog.info(\"userids is-->\" + userids)\n\nif (oldpass == newpass) {\n    exit 400, \'新旧密码一致\';\n}\n//检查密码的策略\n//验证旧密码\n// var oldPwd = oldpass\n\nuser = db.table(\"users\").where().eq(\"userid\", userid).selectOne()\nif (user == null) {\n    exit 400, \"用户不存在\";\n}\n\nencrypt = user.encrypt\noldPwd = SaSecureUtil.md5(SaSecureUtil.md5(oldpass) + encrypt)\n\nresult = db.table(\"users\").where().eq(\"userid\", userid).eq(\"password\", oldPwd).selectOne()\nif (result == null) {\n    exit 400, \'请填写正确的旧密码\';\n}\n\n//生成新密码\nnewpwd = SaSecureUtil.md5(SaSecureUtil.md5(newpass) + encrypt)\n//更新新密码\nresult = db.table(\"users\").primary(\"userid\").update({\n    userid: userid,\n    password: newpwd,\n    changepass:0\n})\n\n//刷新 token 暂时不考虑\n\nuser = db.table(\"users\").where().eq(\"userid\", userid).selectOne()\n// StpUtil.login(userInfo.userid)\n// var token = StpUtil.getTokenValueByLoginId(userInfo.userid)\nreturn  user');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/修改自己的资料.ms', '{\n  \"properties\" : { },\n  \"id\" : \"5a9452fa68994a2e8706f8ffffdadbd1\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"修改自己的资料\",\n  \"createTime\" : 1720519095859,\n  \"updateTime\" : 1713325121898,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"editdata\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"tel\",\n    \"value\" : \"18681529205\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"nickname\",\n    \"value\" : \"昵称\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"profession\",\n    \"value\" : \"职位/职称\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"userimg\",\n    \"value\" : \"会员头像（地址）\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\nvar userid = StpUtil.getLoginId()\nlog.info(\"userids is-->\" + userids)\n\nvar builder = db.table(\"users\").primary(\"id\")\nvar data = {}\n\nuser = db.table(\"users\").where().eq(\"id\", userid).selectOne()\n\n//TODO 用户头像的更改\nif (tel != null) {\n    if (tel.getLength() < 6 || tel.getLength() > 20) {\n        exit 400, \'联系电话长度错误\';\n    }\n    if (user.mobile == tel) {\n        exit 400, \'联系电话已存在\';\n    }\n    data.tel = tel\n}\nif (nickname != null) {\n    if (nickname.getLength() < 2) {\n        exit 400, \'昵称不可以少于2个字\';\n    }\n    if (nickname.getLength() > 20) {\n        exit 400, \'昵称最多只能设置20个字\';\n    }\n    //  $user->az = Base::getFirstCharter($nickname);\n    //  $user->pinyin = Base::cn2pinyin($nickname);\n    //TODO 首写字母\n    data.az = \'\'\n    // TODO 拼音\n    data.pinyin = \'\'\n\n    data.nickname = nickname\n}\nif (profession != null) {\n    if (profession.getLength() < 2) {\n        exit 400, \'职位/职称不可以少于2个字\';\n    }\n    if (profession.getLength() > 20) {\n        exit 400, \'职位/职称最多只能设置20个字\';\n    }\n    data.profession = profession\n}\n\n\n\nuser = db.table(\"users\").where().eq(\"id\", userid).selectOne()\n//生成新的token\nvar token = StpUtil.getTokenValueByLoginId(user.userid)\nuser.token = token\n\nif (use != null) {\n    return user\n}\n\n//生成新的token\n\n\n\nexit 400, \'修改错误\';');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/搜索会员列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"08d8b48f8479497dbdc5f490eff966a1\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"搜索会员列表\",\n  \"createTime\" : 1720519095866,\n  \"updateTime\" : 1713325118042,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/search\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"35\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"dialog_id\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"bot\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"take\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"state\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"sorts.az\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"page\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"d625f2aa-4130-40d6-9e8a-7d89f44422a6\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"userid\\\": 17,\\n            \\\"identity\\\": null,\\n            \\\"department\\\": null,\\n            \\\"az\\\": \\\"\\\",\\n            \\\"pinyin\\\": \\\"\\\",\\n            \\\"email\\\": \\\"admin7@autoo.com\\\",\\n            \\\"tel\\\": \\\"\\\",\\n            \\\"nickname\\\": null,\\n            \\\"profession\\\": null,\\n            \\\"userimg\\\": null,\\n            \\\"encrypt\\\": \\\"ys95k1\\\",\\n            \\\"password\\\": \\\"8a52ac7cb78bb2bbe35707c2fbc98db1\\\",\\n            \\\"changepass\\\": 0,\\n            \\\"login_num\\\": 0,\\n            \\\"last_ip\\\": \\\"\\\",\\n            \\\"last_at\\\": null,\\n            \\\"line_ip\\\": \\\"\\\",\\n            \\\"line_at\\\": null,\\n            \\\"task_dialog_id\\\": 0,\\n            \\\"created_ip\\\": \\\"\\\",\\n            \\\"disable_at\\\": null,\\n            \\\"email_verity\\\": false,\\n            \\\"bot\\\": 0,\\n            \\\"created_at\\\": null,\\n            \\\"updated_at\\\": null\\n        },\\n        {\\n            \\\"userid\\\": 21,\\n            \\\"identity\\\": null,\\n            \\\"department\\\": null,\\n            \\\"az\\\": \\\"A\\\",\\n            \\\"pinyin\\\": \\\"\\\",\\n            \\\"email\\\": \\\"admin12@autoo.com\\\",\\n            \\\"tel\\\": \\\"\\\",\\n            \\\"nickname\\\": \\\"admin12\\\",\\n            \\\"profession\\\": null,\\n            \\\"userimg\\\": null,\\n            \\\"encrypt\\\": \\\"dwz4sf\\\",\\n            \\\"password\\\": \\\"2bdb0a7851289c0472f917edc004a8cb\\\",\\n            \\\"changepass\\\": 0,\\n            \\\"login_num\\\": 1,\\n            \\\"last_ip\\\": \\\"180.141.67.27\\\",\\n            \\\"last_at\\\": 1711102119000,\\n            \\\"line_ip\\\": \\\"180.141.67.27\\\",\\n            \\\"line_at\\\": 1711102119000,\\n            \\\"task_dialog_id\\\": 0,\\n            \\\"created_ip\\\": \\\"\\\",\\n            \\\"disable_at\\\": null,\\n            \\\"email_verity\\\": false,\\n            \\\"bot\\\": 0,\\n            \\\"created_at\\\": null,\\n            \\\"updated_at\\\": null\\n        }\\n    ],\\n    \\\"timestamp\\\": 1711111277529,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711110402906\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"6\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n// var builder = db.table(\"users\").where()\n\nvar users = db.select(\"\"\"\n  SELECT * FROM users \n    <if test=\"project_id != 0 and project_id != \'\'\">\n    WHERE userid IN (SELECT userid FROM project_users WHERE project_id = #{project_id})\n    </if>\n\n\"\"\")\n\n// //默认排除机器人\n// if (bot == null) {\n//     builder.eq(\"bot\", 0)\n// } else {\n\n// }\n// // 默认排除已离职\n// if (disable == null) {\n//     builder.isNull(\"disable_at\")\n// }\n\n// //根据传进来的参数进行筛选\n// if (project_id != 0) {\n\n// }\n\n// var users = builder.select()\nlog.info(\"users\" + users)\nreturn users');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/操作会员(管理员).ms', '{\n  \"properties\" : { },\n  \"id\" : \"4ce483fbf60b4aeab2cb70df7f835a37\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"操作会员(管理员)\",\n  \"createTime\" : 1720519095880,\n  \"updateTime\" : 1713325126815,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/operation\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"userid\",\n    \"value\" : \"1\",\n    \"description\" : \"会员ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : \"setadmin\",\n    \"description\" : \"操作\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"email\",\n    \"value\" : null,\n    \"description\" : \"邮箱地址\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"tel\",\n    \"value\" : null,\n    \"description\" : \"联系电话\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"password\",\n    \"value\" : null,\n    \"description\" : \"新的密码\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"nickname\",\n    \"value\" : null,\n    \"description\" : \"昵称\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"profession\",\n    \"value\" : null,\n    \"description\" : \"职位\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"checkin_macs\",\n    \"value\" : null,\n    \"description\" : \"自动签到mac地址\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"department\",\n    \"value\" : null,\n    \"description\" : \"部门\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"disable_time\",\n    \"value\" : null,\n    \"description\" : \"离职时间\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"transfer_userid\",\n    \"value\" : null,\n    \"description\" : \"离职交接人\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"delete_reason\",\n    \"value\" : null,\n    \"description\" : \"删除原因\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 400,\\n    \\\"message\\\": \\\"已经是管理员\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1708613909117,\\n    \\\"executeTime\\\": 13\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708613555723\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"11\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\n// type：\n// setadmin 设为管理员\n// clearadmin 取消管理员\n// settemp 设为临时帐号\n// cleartemp 取消临时身份（取消临时帐号）\n// checkin_macs 修改自动签到mac地址（需要参数 checkin_macs）\n// department 修改部门（需要参数 department）\n// setdisable 设为离职（需要参数 disable_time、transfer_userid）\n// cleardisable 取消离职\n// delete 删除会员（需要参数 delete_reason）\nimport log\n\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\n\n//判断个人项目是否已经存在\nvar loginUserid = StpUtil.getLoginId()\nlog.info(\"loginUserid is\" + loginUserid)\n\nuserInfo = db.table(\"users\").where().eq(\"userid\", userid).selectOne()\nif (userInfo == null) {\n    exit 400, \'成员不存在或已被删除\';\n}\nif (type != null) {\n    if (type == \"setadmin\") { //设置为管理员\n        log.info(\"userInfo\" + userInfo)\n        log.info(\"userInfo.identity\" + userInfo.identity)\n        if (userInfo.identity != null) {\n            log.info(\"userInfo\" + userInfo)\n            let identityArr = userInfo.identity.split(\',\');\n            for (item in identityArr) {\n                log.info(\"identityArr item \" + item)\n            }\n\n            if (identityArr.some(ident => ident === \'admin\')) {\n                log.info(\"包含admin \")\n                exit 400, \'已经是管理员\'\n            } else {\n                log.info(\"不包含admin\")\n            }\n            //TODO 判断原来有没有admin\n            //如果有就直接返回\n            //如果没有就添加 \n            db.table(\"users\").primary(\"userid\").update({\n                userid: userid,\n                identity: (userInfo.identity ? userInfo.identity : \",\") + \'admin,\' //没有则在后面添加\n            })\n        } else {\n            //为空的情况下直接添加\n            log.info(\"userInfo 用户权限为空\")\n            db.table(\"users\").primary(\"userid\").update({\n                userid: userid,\n                identity: (userInfo.identity ? userInfo.identity : \",\") + \'admin,\' //没有则在后面添加\n            })\n        }\n        return \'收到设置为管理员指令\'\n    } else if (type == \"department\") { //修改的部门\n        //判断最多加入10个部门\n        let departmentArr = department.split(\',\');\n        if (departmentArr.size() > 10) {\n            exit 400, \'最多只可加入10个部门\';\n        }\n        //查找部门是否存在\n        for (item in departmentArr) {\n            result = db.table(\"user_departments\").where().eq(\"id\", item).selectOne()\n            if (result == null) {\n                exit 400, \'修改部门不存在\';\n            }\n        }\n        db.table(\"users\").primary(\"userid\").update({\n            userid: userInfo.userid,\n            department: department,\n        })\n        return \"修改部门成功\"\n\n    } else if (type == \"clearadmin\") {\n        log.info(\"userInfo\" + userInfo)\n        log.info(\"userInfo.identity\" + userInfo.identity)\n        if (userInfo.identity != null) {\n            log.info(\"userInfo\" + userInfo)\n            let identityArr = userInfo.identity.split(\',\');\n            for (item in identityArr) {\n                log.info(\"identityArr item \" + item)\n            }\n            //如果是管理员就删除\n            if (identityArr.some(ident => ident === \'admin\')) {\n                log.info(\"包含admin \")\n                //如果有就删除\n                db.table(\"users\").primary(\"userid\").update({\n                    userid: userid,\n                    identity: userInfo.identity.replace(\'admin,\', \'\')\n                })\n                return \'收到取消管理员指令\'\n            } else {\n                log.info(\"不包含admin\")\n                exit 400, \'会员不是管理员，操作失败\';\n            }\n        } else {\n            log.info(\"userInfo 用户权限为空\")\n            exit 400, \'会员不是管理员，操作失败\';\n        }\n    } else if (type == \"setdisable\") { //设为离职\n        //判断是否是自己\n        if (loginUserid == userInfo.userid) {\n            exit 400, \'不能操作自己离职\';\n        }\n        //\n        db.table(\"users\").primary(\"userid\").update({\n            userid: userInfo.userid,\n            identity: (userInfo.identity ? userInfo.identity : \",\") + \'disable,\', //没有则在后面添加\n            disable_at: disable_time //离职时间设为当前\n        }, true)\n\n    } else if (type == \"cleardisable\") { //取消离职\n        db.table(\"users\").primary(\"userid\").update({\n            userid: userInfo.userid,\n            identity: userInfo.identity.replace(\'disable,\', \'\'),\n            disable_at: \"\" //离职时间设为空\n        }, true)\n\n    } else if (type == \"delete\") { //删除\n        //判断是否是自己\n        if (loginUserid == userInfo.userid) {\n            exit 400, \'不能删除自己\';\n        }\n        //判断原因是否为空\n        if (delete_reason == null) {\n            exit 400, \'请填写删除原因\';\n        }\n        //删除用户的操作\n\n        // 删除原因\n        db.table(\"user_deletes\").insert({\n            operator: loginUserid,\n            userid: userid,\n            email: userInfo.email,\n            reason: delete_reason,\n            cache: \"\", //TODO 未完成\n        })\n\n        // 删除未读\n        // 删除待办\n        // 删除邮箱验证记录\n        // 删除用户\n        db.table(\"user_deletes\").primary(\"userid\").update({\n            userid: userInfo.userid\n        })\n        result = db.table(\"user_deletes\").where().eq(\"userid\", userInfo.userid).delete()\n        log.info(\"delete user result is \" + result)\n\n    } else { //TODO 设置和取消临时用户先不管\n        return \'其他指令未支持\'\n    }\n\n}\n\n//TODO 设置权限\n\n\n\n\n\n// db.table(\"users\").primary(\"userid\").update({\n//     userid: userInfo.userid,\n//     department: \'\',\n// })\n\nif (email != null) {\n    users = db.table(\"users\").where().eq(\"email\", email).notLike(\"userid\", loginUserid).select()\n    if (users.size() > 0) {\n        exit 400, \'邮箱已存在\';\n    }\n\n    db.table(\"users\").primary(\"userid\").update({\n        userid: userInfo.userid,\n        email: email,\n    })\n}\n\nif (tel != null) {\n    //判断电话是否已经存在\n    users = db.table(\"users\").where().eq(\"tel\", tel).notLike(\"userid\", loginUserid).select()\n    if (users.size() > 0) {\n        exit 400, \'联系电话已存在\';\n\n    }\n    db.table(\"users\").primary(\"userid\").update({\n        userid: userInfo.userid,\n        tel: tel,\n    })\n}\n\nif (password != null) { //修改密码\n    db.table(\"users\").primary(\"userid\").update({\n        userid: userInfo.userid,\n        encrypt: \'6\', //盐，随机6位数\n        password: \'\', //新升成的密码\n        changepass: 1\n    })\n}\n\nif (nickname != null) { //修改昵称\n\n    if (nickname.length() < 2) {\n        exit 400, \'昵称不可以少于2个字\';\n    }\n\n    if (nickname.length() > 20) {\n        exit 400, \'昵称最多只能设置20个字\';\n\n    }\n    db.table(\"users\").primary(\"userid\").update({\n        userid: userInfo.userid,\n        nickname: nickname, ///修改昵称\n        az: \'\',\n        pinyin: \'\',\n    })\n}\n\nif (profession != null) { //职位/职称\n    if (profession.length() < 2) {\n        exit 400, \'职位/职称不可以少于2个字\';\n    }\n\n    if (profession.length() > 20) {\n        exit 400, \' 职位/职称最多只能设置20个字\';\n\n    }\n    db.table(\"users\").primary(\"userid\").update({\n        userid: userInfo.userid,\n        profession: profession, //职位/职称\n    })\n}\n\n// 取消离职重新加入全员群组');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/用户基本信息-待完善.ms', '{\n  \"properties\" : { },\n  \"id\" : \"bf77047f63c349cfb27bf93a947e3c58\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"用户基本信息-待完善\",\n  \"createTime\" : 1720519095892,\n  \"updateTime\" : 1713325123891,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/basic\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"userids\",\n    \"value\" : \"9,10,11,12,13,14,15,16,17,18,19,20,21\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"satoken\",\n    \"value\" : \"5b57b554-2a1f-4cb9-ae48-1336b58914bc\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711205964237,\\n    \\\"executeTime\\\": 10\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"userid\",\n          \"value\" : \"8\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"identity\",\n          \"value\" : \",admin,\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"department\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"az\",\n          \"value\" : \"A\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"pinyin\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"email\",\n          \"value\" : \"admin@autoo.com\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"tel\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"nickname\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"profession\",\n          \"value\" : \"管理员\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"userimg\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"encrypt\",\n          \"value\" : \"53c95c\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"password\",\n          \"value\" : \"427aacbcc75706da61e654c357549e35\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"changepass\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"loginNum\",\n          \"value\" : \"101\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"lastIp\",\n          \"value\" : \"192.168.8.182\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"lastAt\",\n          \"value\" : \"2024-01-12 23:38:30\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"lineIp\",\n          \"value\" : \"192.168.8.182\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"lineAt\",\n          \"value\" : \"2024-01-12 23:38:30\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"taskDialogId\",\n          \"value\" : \"18\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"createdIp\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"disableAt\",\n          \"value\" : \"null\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"emailVerity\",\n          \"value\" : \"true\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Boolean\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"bot\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"createdAt\",\n          \"value\" : \"2024-01-11 07:58:45\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"updatedAt\",\n          \"value\" : \"2024-01-12 14:47:11\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"online\",\n          \"value\" : \"true\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Boolean\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1705080097027\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"93\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n//TODO sharekey 分享链接的处理\nvar userid = StpUtil.getLoginId()\n// log.info(\"userids is-->\"+userids)\n//拆分userids的数据，逗号分割\n//判断单词最多获取50个用户的用户信息\n//获取用户的信息\n\nlet useridArr = userids.split(\',\');\n\nvar user = db.table(\"users\").where().in(\"userid\",useridArr).select()\n\nlog.info(\"user-->\" + user)\nreturn user\n\n\n//TODO 需要用逗号隔开，拆分出来\n// var user = db.table(\"users\").where().eq(\"userid\", userids).selectOne()\n// log.info(\"user-->\" + user)\n//从缓存中缓存最后在线时间\n// user.online = true\n//从部门表中获取部门名称\n// user.department_name = user.department\n\n// log.info(\"user-->\" + user)\n// list userids = userid\n// for (index,item in userid[]) {\n//    log.info(\"v\"+index+\"|\"+item)\n// }\n// var userId = StpUtil.getLoginId()\n// log.info(\"userId is\"+userId)\n// return [user]');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/登录注册.ms', '{\n  \"properties\" : { },\n  \"id\" : \"55130f4531c44b069a2671e7c5565caa\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"登录注册\",\n  \"createTime\" : null,\n  \"updateTime\" : 1721044711955,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/login\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"type\",\n    \"value\" : \"reg\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"login\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"email\",\n    \"value\" : \"admin1222233322@autoo.com\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"password\",\n    \"value\" : \"123456\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"code\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"code_key\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"invite\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ {\n    \"name\" : \"require_login\",\n    \"value\" : \"false\",\n    \"description\" : \"该接口需要登录才允许访问\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"userid\\\": 33,\\n        \\\"identity\\\": null,\\n        \\\"department\\\": null,\\n        \\\"az\\\": \\\"A\\\",\\n        \\\"pinyin\\\": \\\"\\\",\\n        \\\"email\\\": \\\"admin1222233322@autoo.com\\\",\\n        \\\"tel\\\": \\\"\\\",\\n        \\\"nickname\\\": \\\"admin1222233322\\\",\\n        \\\"profession\\\": null,\\n        \\\"userimg\\\": null,\\n        \\\"encrypt\\\": \\\"pm4o4e\\\",\\n        \\\"password\\\": \\\"c8ab5077b0e06f84b72b49c6c74c79ed\\\",\\n        \\\"changepass\\\": 0,\\n        \\\"login_num\\\": 0,\\n        \\\"last_ip\\\": \\\"\\\",\\n        \\\"last_at\\\": null,\\n        \\\"line_ip\\\": \\\"\\\",\\n        \\\"line_at\\\": null,\\n        \\\"task_dialog_id\\\": 0,\\n        \\\"created_ip\\\": \\\"\\\",\\n        \\\"disable_at\\\": null,\\n        \\\"email_verity\\\": false,\\n        \\\"bot\\\": 0,\\n        \\\"created_at\\\": null,\\n        \\\"updated_at\\\": null,\\n        \\\"token\\\": \\\"3318803d-06b1-48a9-9eb3-c8a938420582\\\"\\n    },\\n    \\\"timestamp\\\": 1721044676008,\\n    \\\"executeTime\\\": 92\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"type\",\n      \"value\" : \"login\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"email\",\n      \"value\" : \"admin@autoo.com\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"expression\",\n      \"error\" : \"账号最多可输入32位字符\",\n      \"expression\" : \"value.length()<32\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"password\",\n      \"value\" : \"8d95ebceaaeb2f95\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"expression\",\n      \"error\" : \"密码最多可输入32位字符\",\n      \"expression\" : \"value.length()<32\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"code\",\n      \"value\" : \"12331\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"code_key\",\n      \"value\" : \"12331\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"invite\",\n      \"value\" : \"10086\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"userid\",\n        \"value\" : \"32\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"identity\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"department\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"az\",\n        \"value\" : \"A\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"pinyin\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"email\",\n        \"value\" : \"admin222233322@autoo.com\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"tel\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"nickname\",\n        \"value\" : \"admin222233322\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"profession\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"userimg\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"encrypt\",\n        \"value\" : \"diwfaa\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"password\",\n        \"value\" : \"88481d95b3c8ebc3526f356a003513a9\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"changepass\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"login_num\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"last_ip\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"last_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"line_ip\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"line_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"task_dialog_id\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"created_ip\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"disable_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"email_verity\",\n        \"value\" : \"false\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Boolean\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"bot\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"created_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"updated_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"token\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1721044598047\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"87\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport cn.hutool.core.util.StrUtil\nimport cn.hutool.core.util.RandomUtil\nimport cn.hutool.core.util.ReUtil;\nimport log\nimport \'cn.dev33.satoken.secure.SaSecureUtil\';\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport \'cn.hutool.core.lang.Validator\';\nimport \'cn.hutool.core.util.StrUtil\';\nimport \'cn.hutool.extra.pinyin.PinyinUtil\';\nimport env;\nimport request;\nimport http;\nimport org.ssssssss.magicboot.utils.MinioUtil;\n\n//登录的时候检测\nvar bucketName = env.get(\'minio.bucketName\')\nlog.info(\"env bucketName-->\" + bucketName)\nMinioUtil.checkBucket(bucketName)\n\nvar user\nlog.info(\"type is\" + type)\n\nif (type == \'reg\') {\n    log.info(\"注册逻辑\")\n    var system = db.table(\"settings\").where().eq(\"name\", \"system\").selectOne()\n    log.info(\'system value \' + system)\n    //TODO 默认都给注册\n    if (system != null) {\n        var result = system.setting::json\n        log.info(\'system value result \' + result)\n        // if (result == null) {\n        //     exit 400, \'未开放注册\';\n        // }\n\n        // regSetting = result.reg || \'open\'\n        // if (regSetting == \'close\') {\n        //     exit 400, \'未开放注册\';\n        // }\n        // 邀请流程先不考虑\n        //验证邮箱环节先不考虑\n    }\n    if (!Validator.isEmail(email)) {\n        exit 400, \'请输入正确的邮箱地址\';\n\n    } else {\n        log.info(\"邮箱地址正确\")\n    }\n\n    userInfo = db.table(\"users\").where().eq(\"email\", email).selectOne()\n    log.info(\"userInfo\" + userInfo)\n    if (userInfo != null) {\n        exit 400, \'用户已存在\';\n    }\n\n    encrypt = RandomUtil.randomString(6)\n    pwd = SaSecureUtil.md5(SaSecureUtil.md5(password) + encrypt)\n\n    before = StrUtil.subBefore(email, \"@\", false)\n    log.info(\"before-->\" + before)\n    pinyin = before //获取纯字母部分\n    log.info(\"pinyin-->\" + pinyin)\n    az = StrUtil.upperFirst(pinyin.substring(0, 1))\n    nickname = pinyin\n\n    result = db.table(\"users\").insert({\n        email: email,\n        encrypt: encrypt,\n        Password: pwd,\n        // pinyin:pinyin, //暂时先不管\n        az: az,\n        nickname,\n        nickname,\n    })\n\n    //加入全员群组\n    // 设置不为机器人\n\n    userInfo = db.table(\"users\").where().eq(\"email\", email).selectOne()\n    log.info(\"userInfo--->\" + userInfo)\n    StpUtil.login(userInfo.userid)\n    var token = StpUtil.getTokenValueByLoginId(userInfo.userid)\n    userInfo.token = token\n    log.info(\"添加后userInfo\" + userInfo)\n    return userInfo\n\n    //获取系统设置，判断是否开启注册，如果开启邀请码方式则验证邀请码是否正确\n    //执行用户注册(加入全员群组)\n\n    // PinyinUtil.getPinyin()\n\n    // az\n    //  pinyin\n    //  created_ip\n    //判断是否需要验证邮箱，如果需要则需要进入邮箱激活\n} else {\n    log.info(\"登录逻辑\")\n    //检查文件并创建桶\n\n    //位数限制\n\n    //判断是否需要显示验证码，如果需要，则需要去验证\n    //判断账号是否被停用\n    //判断系统设置是否需要验证邮箱，如果需要则提示验证去验证邮箱 \n    //获取登录的ip 和当前的当前的时间\n    userInfo = db.table(\"users\").where().eq(\"email\", email).selectOne()\n    if (userInfo == null) {\n        exit 400, \'用户不存在\';\n    }\n    log.info(\"userInfo---->\" + userInfo)\n    log.info(\"userInfo.encrypt---->\" + userInfo.encrypt)\n    pwd = SaSecureUtil.md5(SaSecureUtil.md5(password) + userInfo.encrypt)\n    if (userInfo.password != pwd) {\n        exit 0, \'用户名或密码错误\'\n    }\n    //更新用户id和最后登录时间\n    ip = request.getClientIP()\n    var data = {\n        userid,\n        login_num,\n        last_ip,\n        last_at,\n        line_ip,\n        line_at,\n    }\n\n    data.userid = userInfo.userid\n    data.login_num = (userInfo.loginNum ? userInfo.loginNum : 0) + 1\n    data.last_ip = ip\n    data.last_at = now()\n    data.line_ip = ip\n    data.line_at = now()\n    db.table(\'users\').primary(\'userid\').update(data, true)\n\n    // var token = StpUtil.login(user.userid) \n\n    // var token = StpUtil.getTokenValueByLoginId(user.userid)\n    // log.info(\"token-->\"+token)\n    // log.info(\"user：-->\"+user)\n    // return user\n\n    StpUtil.login(userInfo.userid)\n    var token = StpUtil.getTokenValueByLoginId(userInfo.userid)\n    userInfo.token = token\n    let useridStr = userInfo.userid::string\n    log.info(\"userid\" + useridStr)\n    // loginLog.token = token\n    // db.table(\"sys_login_log\").primary(\"id\").save(loginLog);\n    // CodeCacheMap.remove(body.uuid)\n    // return StpUtil.getTokenValueByLoginId(user.id)\n    //TODO 执行悟空IM用户注册登录，只有登录才会执行\n    var wukongIMUrl = env.get(\"wukongim.endpoint\")\n    log.info(\"wukongIMUrl\" + wukongIMUrl);\n    var responseEntity = http.connect(wukongIMUrl + \'/user/token\').contentType(\'application/json\').body({\n        uid: useridStr, // 通信的用户唯一ID，可以随机uuid （建议自己服务端的用户唯一uid） （WuKongIMSDK需要）\n        token: token, // 校验的token，随机uuid（建议使用自己服务端的用户的token）（WuKongIMSDK需要）\n        device_flag: 1, // 设备标识  0.app 1.web （相同用户相同设备标记的主设备登录会互相踢，从设备将共存）\n        device_level: 1, // 设备等级 0.为从设备 1.为主设备\n    }).post().getBody();\n    log.info(\"执行悟空IM用户登录\" + responseEntity)\n    // userInfo = db.table(\"users\").columns(\"\").where().eq(\"column\",userInfo.userid).selectOne()\n    //TODO 要去除密码等字段\n    userInfo.password = \"\"\n    var bucketName = env.get(\'minio.bucketName\')\n    log.info(\"env bucketName-->\" + bucketName)\n    MinioUtil.checkBucket(bucketName)\n    return userInfo\n}\n\n// return user');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/获取我的信息.ms', '{\n  \"properties\" : { },\n  \"id\" : \"1d82a14a40884ed39a49e497d1f1a1f6\",\n  \"script\" : null,\n  \"groupId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"name\" : \"获取我的信息\",\n  \"createTime\" : 1720519095915,\n  \"updateTime\" : 1713325116297,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/info\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"52fbbf24-17c6-4825-96a3-8cd04a437dc1\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"userid\\\": 6,\\n        \\\"identity\\\": [\\n            \\\"\\\",\\n            \\\"admin\\\"\\n        ],\\n        \\\"department\\\": \\\"\\\",\\n        \\\"az\\\": \\\"A\\\",\\n        \\\"pinyin\\\": \\\"\\\",\\n        \\\"email\\\": \\\"admin@autoo.com\\\",\\n        \\\"tel\\\": \\\"\\\",\\n        \\\"nickname\\\": \\\"Admin\\\",\\n        \\\"profession\\\": \\\"管理员\\\",\\n        \\\"userimg\\\": null,\\n        \\\"encrypt\\\": \\\"67f88b\\\",\\n        \\\"password\\\": \\\"148ae4c922bc4d5ae4126f65cd268478\\\",\\n        \\\"changepass\\\": 0,\\n        \\\"login_num\\\": 1,\\n        \\\"last_ip\\\": \\\"117.181.99.49\\\",\\n        \\\"last_at\\\": 1712598269000,\\n        \\\"line_ip\\\": \\\"117.181.99.49\\\",\\n        \\\"line_at\\\": 1712598269000,\\n        \\\"task_dialog_id\\\": 18,\\n        \\\"created_ip\\\": \\\"\\\",\\n        \\\"disable_at\\\": null,\\n        \\\"email_verity\\\": true,\\n        \\\"bot\\\": 0,\\n        \\\"created_at\\\": \\\"2024-03-06 21:13:04\\\",\\n        \\\"updated_at\\\": 1709798907000,\\n        \\\"nickname_original\\\": \\\"\\\",\\n        \\\"department_name\\\": \\\"\\\",\\n        \\\"department_owner\\\": \\\"\\\"\\n    },\\n    \\\"timestamp\\\": 1712598417183,\\n    \\\"executeTime\\\": 3\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\n\nif (!StpUtil.isLogin()) {\n    exit - 1, \"请登录后继续...\";\n}\n\nvar userid = StpUtil.getLoginId()\nlog.info(\"userids is-->\" + userids)\n\n//TODO 移动端token还剩7天到期时获取新的token\n\nvar user = db.table(\"users\").where().eq(\"userid\", userid).selectOne()\nuser.nickname_original = \'\'\nuser.department_name = \'\'\nuser.department_owner = \'\'\n///判断是否是管理员\nif (user.identity != null && user.identity.length() > 0) {\n    user.identity = user.identity.split(\',\');\n}\n\nlog.info(\"user-->\" + user)\nreturn user');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/邮箱/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/邮箱/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"5b45cadb3b994384a354e61195f34f2e\",\n  \"name\" : \"邮箱\",\n  \"type\" : \"api\",\n  \"parentId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"path\" : \"/email\",\n  \"createTime\" : 1720519095314,\n  \"updateTime\" : 1713024589826,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/邮箱/发送邮箱验证码.ms', '{\n  \"properties\" : { },\n  \"id\" : \"aa142860164849e487d834651cb9482a\",\n  \"script\" : null,\n  \"groupId\" : \"5b45cadb3b994384a354e61195f34f2e\",\n  \"name\" : \"发送邮箱验证码\",\n  \"createTime\" : 1720519095934,\n  \"updateTime\" : 1713024591472,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"send\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"type\",\n    \"value\" : null,\n    \"description\" : \"邮件类型\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"email\",\n    \"value\" : null,\n    \"description\" : \"邮箱地址\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : \"请输入新邮箱地址\",\n    \"expression\" : \"value.length()>0\",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 400,\\n    \\\"message\\\": \\\"请输入新邮箱地址\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1708496610762,\\n    \\\"executeTime\\\": 1\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\n//判断是否是正常的邮箱地址\n//不能与旧邮箱一致\n//与当前登录邮箱不一致\n//邮箱地址已存在\n//发送邮箱验证码\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/部门/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/部门/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"95e5c1dbf9144c9590e70cc8b304f1a2\",\n  \"name\" : \"部门\",\n  \"type\" : \"api\",\n  \"parentId\" : \"731c0f0eb0fd4dd792004009271d66fa\",\n  \"path\" : \"/department\",\n  \"createTime\" : 1720519095339,\n  \"updateTime\" : 1713024589898,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/部门/删除部门-待测试更多.ms', '{\n  \"properties\" : { },\n  \"id\" : \"d36f1163b6e54a98a9239c115008050b\",\n  \"script\" : null,\n  \"groupId\" : \"95e5c1dbf9144c9590e70cc8b304f1a2\",\n  \"name\" : \"删除部门-待测试更多\",\n  \"createTime\" : 1720519095945,\n  \"updateTime\" : 1713325132710,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/del\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"25\",\n    \"description\" : \"部门id\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : \"部门id必填\",\n    \"expression\" : \"value > 0 \",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 400,\\n    \\\"message\\\": \\\"部门不存在或已被删除\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1708509216081,\\n    \\\"executeTime\\\": 3\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708506507334\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"13\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\n//TODO 判断当前用户是否是管理员 \nimport log\nimport \'@/users/deleteDepartment\' as deleteDepartment\n\nlog.info(\"这里1\")\ndepart = db.table(\"user_departments\").where().eq(\"id\", id).selectOne()\nif (depart != null) {\n    deleteDepartment(id)\n    log.info(\"这里2\")\n    // //删除子部门\n    // list = db.table(\"user_departments\").where().eq(\"parent_id\", id).select()\n    // if (list.size() > 0) {\n    //     log.info(\"这里3\")\n    //     for (item in list) {\n    //         deleteDepartment(item.id)\n    //     }\n    // }\n    return []\n} else {\n    exit 400, \'部门不存在或已被删除\';\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/部门/新建和修改部门.ms', '{\n  \"properties\" : { },\n  \"id\" : \"0cda503c44174e67a0b8a12e290944fd\",\n  \"script\" : null,\n  \"groupId\" : \"95e5c1dbf9144c9590e70cc8b304f1a2\",\n  \"name\" : \"新建和修改部门\",\n  \"createTime\" : 1720519095955,\n  \"updateTime\" : 1713325130975,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/add\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : \"0\",\n    \"description\" : \"部门id，留空为创建部门\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : \"测试部门22231332423424\",\n    \"description\" : \"部门名称\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"parent_id\",\n    \"value\" : \"27\",\n    \"description\" : \"上级部门ID\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : \"0\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"owner_userid\",\n    \"value\" : \"1\",\n    \"description\" : \"部门负责人ID\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : \"0\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"dialog_group\",\n    \"value\" : \"new\",\n    \"description\" : \"部门群（仅创建部门时有效）new: 创建（默认）use: 使用现有群\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"dialog_useid\",\n    \"value\" : \"\",\n    \"description\" : \"使用现有群ID（dialog_group=use时有效）\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 49,\\n        \\\"name\\\": \\\"测试部门22231332423424\\\",\\n        \\\"dialog_id\\\": 0,\\n        \\\"parent_id\\\": 27,\\n        \\\"owner_userid\\\": 1,\\n        \\\"created_at\\\": null,\\n        \\\"updated_at\\\": null\\n    },\\n    \\\"timestamp\\\": 1708957472947,\\n    \\\"executeTime\\\": 17\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"id\",\n        \"value\" : \"49\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"name\",\n        \"value\" : \"测试部门22231332423424\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"dialog_id\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"parent_id\",\n        \"value\" : \"27\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"owner_userid\",\n        \"value\" : \"1\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"created_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"updated_at\",\n        \"value\" : \"null\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708957472947\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"17\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\nif (name.length() < 2 || name.length() > 20) {\n    exit 400, \'部门名称长度限制2-20个字\';\n}\n//TODO 特殊字符不允许出现\nvar userDepartment\nif (id != 0) {\n    userDepartment = db.table(\"user_departments\").where().eq(\"id\", id).selectOne()\n    if (userDepartment == null) {\n        exit 400, \'部门不存在或已被删除\';\n    }\n    if (userDepartment.size() > 200) {\n        exit 400, \'最多只能创建200个部门\';\n    }\n}\n\nlog.info(\"parent_id::\" + parent_id)\n//判断上级部门\nif (parent_id !== null && parent_id > 0) {\n    parentDepartment = db.table(\"user_departments\").where().eq(\"id\", parent_id).selectOne()\n\n    if (parentDepartment == null) {\n        exit 400, \'上级部门不存在或已被删除\';\n    }\n\n    if (parentDepartment.parent_id > 0) {\n        exit 400, \'上级部门层级错误\';\n    }\n    //查找有多少个同是父部门的\n    departments = db.table(\"user_departments\").where().eq(\"parent_id\", parent_id).select()\n\n    if (departments != null && departments.size() > 20) {\n        exit 400, \'每个部门最多只能创建20个子部门\';\n    }\n    \n    departments = db.table(\"user_departments\").where().eq(\"parent_id\", id).select()\n    if (id > 0 && departments != null) {\n        exit 400, \'含有子部门无法修改上级部门\';\n    }\n}\n\nlog.info(\"parent_id::\" + parent_id)\nlog.info(\"owner_userid::\" + owner_userid)\n\n// !User::whereUserid($owner_userid)->exists() TODO 这个没看懂什么意思\nif (owner_userid == 0) {\n    exit 400, \'请选择正确的部门负责人\';\n}\n\nif (userDepartment != null) { //保存操作\n    var result = db.table(\"user_departments\").primary(\"id\").update({\n        id: id,\n        name: name,\n        parent_id: parent_id,\n        owner_userid: owner_userid\n    })\n    log.info(\"更新部门\" + result)\n    return db.table(\"user_departments\").where().eq(\"id\", id).selectOne()\n    // return result\n} else { //新建操作\n    var result = db.table(\"user_departments\").insert({\n        name: name,\n        parent_id: parent_id,\n        owner_userid: owner_userid\n    })\n\n    log.info(\"新建部门\" + result)\n    return db.table(\"user_departments\").where().eq(\"id\", result).selectOne()\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/用户/部门/部门列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"36b4a3a2c84849cfb019bb0240522957\",\n  \"script\" : null,\n  \"groupId\" : \"95e5c1dbf9144c9590e70cc8b304f1a2\",\n  \"name\" : \"部门列表\",\n  \"createTime\" : 1720519096005,\n  \"updateTime\" : 1713325134792,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/list\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"data\\\": []\\n    },\\n    \\\"timestamp\\\": 1708192625710,\\n    \\\"executeTime\\\": 3\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708192605468\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"4\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\nuserDepartments = db.table(\"user_departments\").select()\n\n\nreturn userDepartments');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/知识库/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/知识库/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"ad93dd4a8cb64462bec9a526ffa2f368\",\n  \"name\" : \"知识库\",\n  \"type\" : \"api\",\n  \"parentId\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"path\" : \"/know\",\n  \"createTime\" : 1720519095352,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/知识库/测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"19e6d0ad67cf42cfa0f4274f810550d5\",\n  \"script\" : null,\n  \"groupId\" : \"ad93dd4a8cb64462bec9a526ffa2f368\",\n  \"name\" : \"测试\",\n  \"createTime\" : 1720519096018,\n  \"updateTime\" : 1716867995049,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/test\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"fileUrl\",\n    \"value\" : \"2024-04-28/a96b119cfedd4b6a9a265a4dc8e8dab7.docx\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1716867981830,\\n    \\\"executeTime\\\": 41\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"code\",\n        \"value\" : \"200\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"message\",\n        \"value\" : \"成功\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"data\",\n        \"value\" : \"eyJ1c2VybmFtZSI6ImFkbWluIiwiaWQiOiJmMGRkOGY3MS1lNGVlLTExZWUtOGM4NC1hOGExNTk1ODAxYWIiLCJlbWFpbCI6IiIsInR5cGUiOiJVU0VSIn0:1sBWBo:-pMyWbymyVRCHqt2QOgrJXbX6j2LMsTM-Gq7xKDFDg4\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1716800324725\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"611\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport env;\nvar firstIndex = fileUrl.indexOf(\".\")\nvar prefix = fileUrl.substring(0, firstIndex)\nvar suffix = fileUrl.substring(firstIndex, fileUrl.length() - 1)\nlog.info(\"prefix-->\"+prefix)\nlog.info(\"suffix-->\"+suffix)\n\n\nvar port = env.get(\'server.port\')\nlog.info(\"env port-->\"+port)');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"系统\",\n  \"type\" : \"api\",\n  \"parentId\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"path\" : \"/system\",\n  \"createTime\" : 1720519095376,\n  \"updateTime\" : 1713024589973,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/优先级.ms', '{\n  \"properties\" : { },\n  \"id\" : \"9c3e7968f93547d698696cae226d1baf\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"优先级\",\n  \"createTime\" : 1720519096029,\n  \"updateTime\" : 1713325158243,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/priority\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"type\",\n    \"value\" : \"save\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"list\\\": [\\n    {\\n      \\\"name\\\": \\\"googd\\\",\\n      \\\"priority\\\": 1,\\n      \\\"days\\\": 1,\\n      \\\"color\\\": \\\"#4B70F3\\\"\\n    }\\n  ]\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711667522557,\\n    \\\"executeTime\\\": 5\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"type\",\n      \"value\" : \"get\",\n      \"description\" : \"get: 获取（默认）save: 保存（限管理员）\",\n      \"required\" : true,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : \"get\",\n      \"validateType\" : \"pass\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"name\",\n          \"value\" : \"googd\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"priority\",\n          \"value\" : \"1\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"days\",\n          \"value\" : \"1\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"color\",\n          \"value\" : \"#4B70F3\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711667142676\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"8\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\n//管理员保存\nif (type == \"save\") { \n    var list = body.list\n    var result = db.table(\'settings\').primary(\'name\').update({\n        name: \'priority\',\n        setting: list::stringify\n    })\n    //这里还有去修改所有对应的颜色\n    //TODO 修改\n\n    if (result != null) {\n        return list //原路返回\n    }\n} else { //获取列表\n    var priority = db.table(\"settings\").where().eq(\"name\", \"priority\").selectOne()\n    if (priority != null && priority.setting) {\n        var result = priority.setting::json\n        return result\n    }\n    return []\n}\n\nreturn []');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/图片上传-未完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"189374073fb84270875dde4c0f4976bc\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"图片上传-未完成\",\n  \"createTime\" : 1720519096041,\n  \"updateTime\" : 1713325150720,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/imgupload\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"image\",\n    \"value\" : { },\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"MultipartFile\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"url\\\": \\\"http://127.0.0.1:9000/task/2024-04-01/9d940100928b44e88c93cea9e2279b6a.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=admin%2F20240401%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20240401T074345Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=e52f53d38000d4d397eb5ae0a382000ac6750858f4c1ee04db889c5e93cdbc81\\\"\\n    },\\n    \\\"timestamp\\\": 1711957425208,\\n    \\\"executeTime\\\": 128\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport request;\nimport log\nimport org.ssssssss.magicboot.utils.MinioUtil\n\nvar file = request.getFile(\'image\');\nlog.info(\'---------file--\')\n\nif (file != null) {\n    log.info(\'---------file have value--\')\n} else {\n    log.info(\'---------file is null--\')\n}\n//检查桶是否存在\n// var check = MinioUtil.bucketExists(\'task\')\nvar check = true;\nlog.info(\'check value  \' + check)\nif (check) {\n    // upload里面已经检查了，如果不存在桶，会自动创建一个名为task的桶\n    var result = MinioUtil.upload(file)\n    return {\n        url: MinioUtil.preview(result)\n    }\n    return\n}\nreturn \'服务器存储异常\'\n\n// {\n//     \"ret\": 1,\n//     \"msg\": \"success\",\n//     \"data\": {\n//         \"name\": \"\\u622a\\u5c4f2024-02-27 20.29.41.png\",\n//         \"size\": 111.36,\n//         \"file\": \"\\/var\\/www\\/public\\/uploads\\/user\\/picture\\/1\\/202402\\/ac89c6e77ecfeb11bac7e2bd85c7cb5d.png\",\n//         \"path\": \"uploads\\/user\\/picture\\/1\\/202402\\/ac89c6e77ecfeb11bac7e2bd85c7cb5d.png\",\n//         \"url\": \"http:\\/\\/autoo.com\\/uploads\\/user\\/picture\\/1\\/202402\\/ac89c6e77ecfeb11bac7e2bd85c7cb5d.png\",\n//         \"thumb\": \"http:\\/\\/autoo.com\\/uploads\\/user\\/picture\\/1\\/202402\\/ac89c6e77ecfeb11bac7e2bd85c7cb5d.png_thumb.png\",\n//         \"width\": 1300,\n//         \"height\": 501,\n//         \"ext\": \"png\"\n//     }\n// }');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/知识库管理.ms', '{\n  \"properties\" : { },\n  \"id\" : \"4b38de2f260945599630496e4f0b20d7\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"知识库管理\",\n  \"createTime\" : 1720519096051,\n  \"updateTime\" : 1716567478821,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/know\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"type\",\n    \"value\" : \"save\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"know\\\": {\\n    \\\"linkUrl\\\": \\\"123131313\\\",\\n    \\\"user\\\": \\\"123131313\\\",\\n    \\\"pwd\\\": \\\"13131313\\\",\\n    \\\"appid\\\": \\\"13131313\\\",\\n    \\\"iframeUrl\\\": \\\"1313131313\\\",\\n    \\\"auto_upload\\\": \\\"open\\\"\\n  }\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"linkUrl\\\": \\\"123131313\\\",\\n        \\\"user\\\": \\\"123131313\\\",\\n        \\\"pwd\\\": \\\"13131313\\\",\\n        \\\"appid\\\": \\\"13131313\\\",\\n        \\\"iframeUrl\\\": \\\"1313131313\\\",\\n        \\\"auto_upload\\\": \\\"open\\\"\\n    },\\n    \\\"timestamp\\\": 1716546498679,\\n    \\\"executeTime\\\": 14\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport log;\nif (type == \"save\") { \n    var know = body.know\n    var result = db.table(\'settings\').primary(\'name\').update({\n        name: \'know\',\n        setting: know::stringify\n    })\n    if (result != null) {\n        return know //原路返回\n    }\n} else { //获取列表\n    var know = db.table(\"settings\").where().eq(\"name\", \"know\").selectOne()\n    if (know != null && know.setting) {\n        var result = know.setting::json\n        return result\n    }\n    return []\n}\nreturn []\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/系统设置.ms', '{\n  \"properties\" : { },\n  \"id\" : \"7d313a7fa3344e948b85f46ca2efe4c8\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"系统设置\",\n  \"createTime\" : 1720519096059,\n  \"updateTime\" : 1713325152360,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/setting\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [],\\n    \\\"timestamp\\\": 1710030455179,\\n    \\\"executeTime\\\": 18\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1710030333535\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"11\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\nif (type == \"save\") { //TODO 保存未实现\n    //判断当前是否是管理员\n    //判断自动归档时长\n    \n} else {\n    var system = db.table(\"settings\").where().eq(\"name\", \"system\").selectOne()\n    log.info(\'system value \' + system)\n    if (system != null) { //    全部走默认\n        if (system.setting != null) {\n            log.info(\'result value: \' + system.setting::json)\n            var result = system.setting::json\n            // if (result.task_default_time == null) {\n            //     log.info(\'task_default_time\' + task_default_time)\n            //     var time = [\n            //         \'09:00\', \'18:00\'\n            //     ]\n            //     result.task_default_time = time\n            // } else {\n            //     log.info(\'task_default_time no null\')\n            // }\n            result.reg = result.reg || \'open\';\n            result.reg_identity = result.reg_identity || \'normal\';\n            result.login_code = result.login_code || \'auto\';\n            result.password_policy = result.password_policy || \'simple\';\n            result.chat_information = result.chat_information || \'open\';\n            result.anon_message = result.anon_message || \'open\';\n            result.auto_archived = result.auto_archived || \'close\';\n            result.archived_day = result.archived_day || 7;\n            result.task_visible = result.task_visible || \'close\';\n            result.task_default_time = result.task_default_time || [\'09:00\', \'18:00\'];\n            result.all_group_mute = result.all_group_mute || \'open\';\n            result.all_group_autoin = result.all_group_autoin || \'yes\';\n            result.image_compress = result.image_compress || \'open\';\n            result.image_save_local = result.image_save_local || \'open\';\n            result.start_home = result.start_home || \'close\';\n            result.file_upload_limit = result.file_upload_limit || \'\';\n            result.unclaimed_task_reminder = result.unclaimed_task_reminder || \'close\';\n            result.unclaimed_task_reminder_time = result.unclaimed_task_reminder_time || \'\';\n            return result\n        }\n        var result = {}\n        result.reg =  \'open\';\n        result.reg_identity = \'normal\';\n        result.login_code =  \'auto\';\n        result.password_policy = \'simple\';\n        result.chat_information =  \'open\';\n        result.anon_message = \'open\';\n        result.auto_archived = \'close\';\n        result.archived_day =  7;\n        result.task_visible = \'close\';\n        result.task_default_time =  [\'09:00\', \'18:00\'];\n        result.all_group_mute =  \'open\';\n        result.all_group_autoin =  \'yes\';\n        result.image_compress =  \'open\';\n        result.image_save_local =  \'open\';\n        result.start_home =   \'close\';\n        result.file_upload_limit =  \'\';\n        result.unclaimed_task_reminder =  \'close\';\n        result.unclaimed_task_reminder_time =  \'\';\n\n        return result\n    }\n    return []\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/获取当前系统版本号.ms', '{\n  \"properties\" : { },\n  \"id\" : \"895f8050e8c7481b89861f0eac2208b3\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"获取当前系统版本号\",\n  \"createTime\" : 1720519096067,\n  \"updateTime\" : 1713325145525,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/version\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nvar result = {\n    version:\'0.0.1\',\n    publish:{\n        provider:\'generic\',\n        url:\'\'\n    }\n}\nreturn result\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/获取演示的账号密码.ms', '{\n  \"properties\" : { },\n  \"id\" : \"c598aa9a719742ac800fb7a364d74d40\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"获取演示的账号密码\",\n  \"createTime\" : 1720519096082,\n  \"updateTime\" : 1713325147277,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/demo\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"account\\\": \\\"admin@autoo.com\\\",\\n        \\\"password\\\": \\\"123456\\\"\\n    },\\n    \\\"timestamp\\\": 1712138710802,\\n    \\\"executeTime\\\": 3\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nreturn {\n    \"account\":\"admin@autoo.com\",\n    \"password\":\"123456\"\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/邮箱管理.ms', '{\n  \"properties\" : { },\n  \"id\" : \"bdb87361e519436f845da605a0447396\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"邮箱管理\",\n  \"createTime\" : 1720519096106,\n  \"updateTime\" : 1713325160606,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/setting/email\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"smtp_server\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"port\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"smtp_server\\\": \\\"\\\",\\n        \\\"port\\\": \\\"\\\",\\n        \\\"account\\\": \\\"\\\",\\n        \\\"password\\\": \\\"\\\",\\n        \\\"reg_verify\\\": \\\"close\\\",\\n        \\\"notice_msg\\\": \\\"close\\\",\\n        \\\"msg_unread_user_minute\\\": \\\"-1\\\",\\n        \\\"msg_unread_group_minute\\\": \\\"-1\\\",\\n        \\\"ignore_addr\\\": \\\"\\\"\\n    },\\n    \\\"timestamp\\\": 1706607921540,\\n    \\\"executeTime\\\": 5\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport log\n\nif (type == \"save\") { //TODO 邮箱保存未实现\n   //判断当前用户是否是管理员\n   \n} else {\n    var system = db.table(\"settings\").where().eq(\"name\", \"emailSetting\").selectOne()\n    log.info(\'email value \' + system)\n    log.info(\'email value: \' + system::json)\n    var result = system.setting::json\n    return result\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/系统/项目模板.ms', '{\n  \"properties\" : { },\n  \"id\" : \"copy1711683059966d16020\",\n  \"script\" : null,\n  \"groupId\" : \"a0d32feaa58a4d318032215149d5cf40\",\n  \"name\" : \"项目模板\",\n  \"createTime\" : 1720519096114,\n  \"updateTime\" : 1713325156497,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/column/template\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"type\",\n    \"value\" : \"save\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"list\\\": [\\n    {\\n      \\\"name\\\": \\\"googd\\\",\\n      \\\"priority\\\": 1,\\n      \\\"days\\\": 1,\\n      \\\"color\\\": \\\"#4B70F3\\\"\\n    }\\n  ]\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"name\\\": \\\"googd\\\",\\n            \\\"priority\\\": 1,\\n            \\\"days\\\": 1,\\n            \\\"color\\\": \\\"#4B70F3\\\"\\n        }\\n    ],\\n    \\\"timestamp\\\": 1711683690657,\\n    \\\"executeTime\\\": 8\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"type\",\n      \"value\" : \"get\",\n      \"description\" : \"get: 获取（默认）save: 保存（限管理员）\",\n      \"required\" : true,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : \"get\",\n      \"validateType\" : \"pass\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"name\",\n          \"value\" : \"googd\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"priority\",\n          \"value\" : \"1\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"days\",\n          \"value\" : \"1\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"color\",\n          \"value\" : \"#4B70F3\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711667142676\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"8\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\n//管理员保存\nif (type == \"save\") { \n    var list = body.list\n    var result = db.table(\'settings\').primary(\'name\').update({\n        name: \'columnTemplate\',\n        setting: list::stringify\n    })\n    if (result != null) {\n        return list //原路返回\n    }\n} else { //获取列表\n    var template = db.table(\"settings\").where().eq(\"name\", \"columnTemplate\").selectOne()\n    if (template != null && template.setting) {\n        var result = template.setting::json\n        return result\n    }\n    return []\n}\n\nreturn []');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"项目\",\n  \"type\" : \"api\",\n  \"parentId\" : \"4fd0586ad07146a4bc84aeb71b8ec638\",\n  \"path\" : \"/project\",\n  \"createTime\" : 1720519095388,\n  \"updateTime\" : 1713024590055,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"任务\",\n  \"type\" : \"api\",\n  \"parentId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"path\" : \"/task\",\n  \"createTime\" : 1720519095401,\n  \"updateTime\" : 1713024590151,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/下载任务文件.ms', '{\n  \"properties\" : { },\n  \"id\" : \"6b147d91fbca4179ad5b7f320f1479a3\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"下载任务文件\",\n  \"createTime\" : 1720519096286,\n  \"updateTime\" : 1713024593344,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/filedown\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"file_id\",\n    \"value\" : null,\n    \"description\" : \"文件ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"down\",\n    \"value\" : null,\n    \"description\" : \"直接下载  yes: 下载（默认） preview: 转预览地址\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"yes\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/任务工作流信息-已完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"55977ef77c294cb3abe54ea2c4333420\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"任务工作流信息-已完成\",\n  \"createTime\" : 1720519096294,\n  \"updateTime\" : 1713024593421,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/flow\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : \"85\",\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"project_id\",\n    \"value\" : null,\n    \"description\" : \"项目ID - 存在时只返回这个项目的\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"id\\\": 21,\\n            \\\"project_id\\\": 7,\\n            \\\"flow_id\\\": 6,\\n            \\\"name\\\": \\\"待处理\\\",\\n            \\\"status\\\": \\\"start\\\",\\n            \\\"turns\\\": \\\"[21,22,23,24,25]\\\",\\n            \\\"userids\\\": \\\"[]\\\",\\n            \\\"usertype\\\": \\\"add\\\",\\n            \\\"userlimit\\\": 0,\\n            \\\"columnid\\\": 0,\\n            \\\"sort\\\": 0,\\n            \\\"created_at\\\": \\\"2024-01-11 09:24:43\\\",\\n            \\\"updated_at\\\": \\\"2024-01-11 09:24:43\\\"\\n        },\\n        {\\n            \\\"id\\\": 22,\\n            \\\"project_id\\\": 7,\\n            \\\"flow_id\\\": 6,\\n            \\\"name\\\": \\\"进行中\\\",\\n            \\\"status\\\": \\\"progress\\\",\\n            \\\"turns\\\": \\\"[21,22,23,24,25]\\\",\\n            \\\"userids\\\": \\\"[]\\\",\\n            \\\"usertype\\\": \\\"add\\\",\\n            \\\"userlimit\\\": 0,\\n            \\\"columnid\\\": 0,\\n            \\\"sort\\\": 1,\\n            \\\"created_at\\\": \\\"2024-01-11 09:24:43\\\",\\n            \\\"updated_at\\\": \\\"2024-01-11 09:24:43\\\"\\n        },\\n        {\\n            \\\"id\\\": 23,\\n            \\\"project_id\\\": 7,\\n            \\\"flow_id\\\": 6,\\n            \\\"name\\\": \\\"已完成\\\",\\n            \\\"status\\\": \\\"end\\\",\\n            \\\"turns\\\": \\\"[21,22,23,24,25]\\\",\\n            \\\"userids\\\": \\\"[]\\\",\\n            \\\"usertype\\\": \\\"add\\\",\\n            \\\"userlimit\\\": 0,\\n            \\\"columnid\\\": 0,\\n            \\\"sort\\\": 3,\\n            \\\"created_at\\\": \\\"2024-01-11 09:24:43\\\",\\n            \\\"updated_at\\\": \\\"2024-01-11 09:24:43\\\"\\n        },\\n        {\\n            \\\"id\\\": 24,\\n            \\\"project_id\\\": 7,\\n            \\\"flow_id\\\": 6,\\n            \\\"name\\\": \\\"已取消\\\",\\n            \\\"status\\\": \\\"end\\\",\\n            \\\"turns\\\": \\\"[21,22,23,24,25]\\\",\\n            \\\"userids\\\": \\\"[]\\\",\\n            \\\"usertype\\\": \\\"add\\\",\\n            \\\"userlimit\\\": 0,\\n            \\\"columnid\\\": 0,\\n            \\\"sort\\\": 4,\\n            \\\"created_at\\\": \\\"2024-01-11 09:24:43\\\",\\n            \\\"updated_at\\\": \\\"2024-01-11 09:24:43\\\"\\n        },\\n        {\\n            \\\"id\\\": 25,\\n            \\\"project_id\\\": 7,\\n            \\\"flow_id\\\": 6,\\n            \\\"name\\\": \\\"待测试\\\",\\n            \\\"status\\\": \\\"test\\\",\\n            \\\"turns\\\": \\\"[21,22,23,24,25]\\\",\\n            \\\"userids\\\": \\\"[]\\\",\\n            \\\"usertype\\\": \\\"add\\\",\\n            \\\"userlimit\\\": 0,\\n            \\\"columnid\\\": 0,\\n            \\\"sort\\\": 2,\\n            \\\"created_at\\\": \\\"2024-01-11 09:24:43\\\",\\n            \\\"updated_at\\\": \\\"2024-01-11 09:24:43\\\"\\n        }\\n    ],\\n    \\\"timestamp\\\": 1706609118845,\\n    \\\"executeTime\\\": 9\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport org.ssssssss.script.parsing.ast.statement.Return\nimport log\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\n// var userid = StpUtil.getLoginId()\n\n//添加统计信息\nvar task = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\nlog.info(\"task is.  \" + task)\nif (task == null) {\n    exit 400, \'任务不存在\'\n}\n\nvar projectFlow = db.table(\"project_flows\").where().eq(\"project_id\", task.project_id).selectOne()\nlog.info(\"projectFlow is.  \" + projectFlow)\nif (projectFlow == null) {\n    exit 400, \'任务工作流不存在\'\n}\n\nvar projectFlowItem =   db.table(\'project_flow_items\').where().eq(\"project_id\", task.project_id).eq(\"flow_id\", projectFlow.id).select()\nlog.info(\"projectFlowItem is.  \" + projectFlowItem)\nif (projectFlowItem == null) {\n    exit 400, \'任务工作流项不存在\'\n}\n\nvar data = {\n    task_id,\n    flow_item_id,\n    turns\n}\n\ndata.task_id= task.id\ndata.flow_item_id = task.flow_item_id\ndata.turns = projectFlowItem\n\n\nreturn data\n\n\n\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/任务移动-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"069277c0c6d6413fa53d55015cb1ac71\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"任务移动-待测试\",\n  \"createTime\" : 1720519096302,\n  \"updateTime\" : 1713024593499,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/move\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : null,\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"project_id\",\n    \"value\" : null,\n    \"description\" : \"项目ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"column_id\",\n    \"value\" : null,\n    \"description\" : \"列ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"flow_item_id\",\n    \"value\" : null,\n    \"description\" : \"工作流id\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"owner\",\n    \"value\" : null,\n    \"description\" : \"负责人\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"assist\",\n    \"value\" : null,\n    \"description\" : \"协助人\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\n//判断新列表是否存在\ncolumn = db.table(\"project_columns\").where().eq(\"id\", column_id).selectOne()\nif (column == null) {\n    exit 400, \'列表不存在\';\n}\n\n//\nuseTask = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\nif (useTask == null) {\n    exit 400, \'任务不存在\';\n\n}\noldColumn = db.table(\"project_columns\").where().eq(\"id\", useTask.column_id).selectOne()\n\nif (oldColumn.id != column.id) { //id不一样的时候执行移动\n    result = db.table(\"projects_tasks\").primary(\"id\").update({\n        id: task_id,\n        column_id: column_id\n    })\n    if (result) {\n        task = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\n        return task\n    }\n}\nexit 400, \'移动异常\';\n//返回无操作啊');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/修改任务-完善中.ms', '{\n  \"properties\" : { },\n  \"id\" : \"9a5d652698364f8f8a98a404342c2727\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"修改任务-完善中\",\n  \"createTime\" : null,\n  \"updateTime\" : 1721045412457,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/update\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"a9fc5b73-bbcd-47e9-803a-989822150fe2\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"task_id\\\": 205,\\n  \\\"assist\\\": [\\n    7\\n  ]\\n}\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"58d97f3f-b00b-4050-b6d6-7e31e391ab7d\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 205,\\n        \\\"parent_id\\\": 0,\\n        \\\"project_id\\\": 104,\\n        \\\"column_id\\\": 146,\\n        \\\"dialog_id\\\": \\\"f55e2438470b41e58558a61d2ed0a596\\\",\\n        \\\"flow_item_id\\\": 331,\\n        \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n        \\\"name\\\": \\\"111\\\",\\n        \\\"color\\\": \\\"\\\",\\n        \\\"desc\\\": \\\"1\\\",\\n        \\\"start_at\\\": 1713920400000,\\n        \\\"end_at\\\": 1714039200000,\\n        \\\"archived_at\\\": null,\\n        \\\"archived_userid\\\": 0,\\n        \\\"archived_follow\\\": 0,\\n        \\\"complete_at\\\": null,\\n        \\\"userid\\\": 6,\\n        \\\"visibility\\\": 1,\\n        \\\"p_level\\\": 1,\\n        \\\"p_name\\\": \\\"重要且紧急\\\",\\n        \\\"p_color\\\": \\\"#ED4014\\\",\\n        \\\"sort\\\": 0,\\n        \\\"loop\\\": \\\"\\\",\\n        \\\"loop_at\\\": null,\\n        \\\"created_at\\\": null,\\n        \\\"updated_at\\\": null,\\n        \\\"deleted_at\\\": null,\\n        \\\"deleted_userid\\\": 0,\\n        \\\"task_user\\\": [\\n            {\\n                \\\"id\\\": 108,\\n                \\\"project_id\\\": 104,\\n                \\\"task_id\\\": 205,\\n                \\\"task_pid\\\": 205,\\n                \\\"userid\\\": 7,\\n                \\\"owner\\\": 0,\\n                \\\"created_at\\\": 1713976503000,\\n                \\\"updated_at\\\": null\\n            },\\n            {\\n                \\\"id\\\": 267,\\n                \\\"project_id\\\": 104,\\n                \\\"task_id\\\": 205,\\n                \\\"task_pid\\\": 205,\\n                \\\"userid\\\": 6,\\n                \\\"owner\\\": 1,\\n                \\\"created_at\\\": 1713970132000,\\n                \\\"updated_at\\\": null\\n            }\\n        ],\\n        \\\"task_tag\\\": []\\n    },\\n    \\\"timestamp\\\": 1713976503505,\\n    \\\"executeTime\\\": 56\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"task_id\",\n      \"value\" : \"202\",\n      \"description\" : \"任务id\",\n      \"required\" : true,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"assist\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"7\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1713975515290\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"41\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport cn.hutool.core.util.EscapeUtil;\nimport log\nimport env\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\n//判断任务能不能操作，比如是否已归档\n//判断个人项目是否已经存在\n// var userid = StpUtil.getLoginId()\nvar userid = 6\n// var userid = 1\n//更新备注\nvar updateMarking = {}\n\nvar data = {}\n\n//TODO 判断当前用户是否是项目负责人或者协助人 或者项目负责人\n\n//任务负责人列表\nvar oldOwners = db.table(\"project_task_users\").where().eq(\"task_id\", body.task_id).eq(\"owner\", 1).select()\n//任务协助人列表\nvar oldAssists = db.table(\"project_task_users\").where().eq(\"task_id\", body.task_id).eq(\"owner\", 0).select()\nfor (item in oldAssists) {\n    log.info(\"oldAssists selece value item \" + item)\n\n}\n\n//任务负责人userid列表\nlet oldOwnerUserIds = []\n//任务协助人userid列表\nlet oldAssistUserIds = []\n\n//任务负责人列表\nif (oldOwners.size() > 0) {\n    log.info(\"oldOwners size ------>\" + oldOwners.size())\n    for (item in oldOwners) {\n        oldOwnerUserIds.push(item.userid)\n        log.info(\"oldOwners22------>\" + item)\n    }\n} else {\n    log.info(\"历史项目负责人为空------>\")\n}\n//任务协助人列表\nif (oldAssists.size() > 0) {\n    for (item in oldAssists) {\n        oldAssistUserIds.push(item.userid)\n        log.info(\"oldAssists1------>\" + item)\n    }\n} else {\n    log.info(\"历史项目协助人为空------>\")\n}\n\n//构建任务基础查询\nvar builder = db.table(\'project_tasks\').where().eq(\"id\", body.task_id)\n\n// 查询项目负责人\n\nvar projectOwner\nvar useTask\n\nvar result = builder.selectOne()\nuseTask = result\nvar projectId\n\nif (result !== null) {\n    projectId = result.project_id\n    log.info(\"projectId--->\" + projectId)\n    if (projectId !== null) {\n        useProject = db.table(\'projects\').where().eq(\"id\", projectId).selectOne()\n        log.info(\"result--->\" + useProject)\n        if (useProject !== null) {\n            log.info(\"result.userid--->\" + useProject.userid)\n            projectOwner = useProject.userid\n        }\n    }\n}\n\nfor (item in oldOwnerUserIds) {\n    log.info(\"item \" + \"oldOwnerUserIds\" + item)\n}\n\nlog.info(\"-------------\")\nlog.info(\"userid---> \" + userid)\nlog.info(\"projectOwne---> \" + projectOwner)\nlog.info(\"projectOwne---> \" + (userid::int != projectOwner))\nlog.info(\"contains --->\" + !oldOwnerUserIds.contains(userid))\nlog.info(\"-------------\")\n//查看是否是项目负责人或者任务负责人，如果不是则不能修改任务状态\nif (userid::int != projectOwner && !oldOwnerUserIds.contains(userid)) {\n    exit 400, \'仅限任务负责人或项目负责人操作\'\n}\n\n//对比原来的工作流和现在的工作流id\nif (body.flow_item_id !== null) {\n    //flowData 作为记录插入使用的\n    var flowData = {}\n    if (useTask.flow_item_id == body.flow_item_id) {\n        exit 400, \'任务状态未发生改变\'\n    } else { // 更新到新的工作流\n        newFlowItem = db.table(\"project_flow_items\").where().eq(\"project_id\", useTask.project_id).eq(\'id\', body.flow_item_id).selectOne()\n        log.info(\"newFlowItem-->\" + newFlowItem)\n        if (newFlowItem == null) { //判断任务状态是否存在\n            exit 400, \'任务状态不存在\'\n        }\n        if (useTask.flow_item_id != \'\') { //判断当前工作流id不为空\n            currentFlowItem = db.table(\"project_flow_items\").where().eq(\"project_id\", useTask.project_id).eq(\'id\', useTask.flow_item_id).selectOne()\n            //判断符合流转 \n            turnStr = currentFlowItem.turns.substring(1, currentFlowItem.turns.length() - 1)\n            log.info(\"currentFlowItem.id turnStr\" + turnStr)\n            let turnArr2 = turnStr.split(\', \'); //TODO 这里需要处理\n            //判断是否能变更\n            if (!turnArr2.some(e => e == currentFlowItem.id::string)) {\n                exit 400, \'当前状态[\' + currentFlowItem.name + \']不可流转到[\' + newFlowItem.name + \']\'\n            }\n\n            //TODO  userlimit 这里处理也不行\n            if (currentFlowItem.userlimit) {\n                //判断是否是当前状态的负责人或者项目负责人\n                if (userid != projectOwner || !currentFlowItem.userids.contains(userid)) {\n                    exit 400, \'当前状态[\' + currentFlowItem.name + \']仅限状态负责人或项目负责人修改\'\n                }\n            }\n        }\n        data.flow_item_id = newFlowItem.id\n        data.flow_item_name = newFlowItem.status + \'|\' + newFlowItem.name\n\n        //判断状态为完成状态，则修改任务的完成时间\n        if (newFlowItem.status == \'end\') {\n            //判断原来的任务完成时间为空\n            if (useTask.complete_at == null) {\n                data.complete_at = now() //更新任务的完成时间\n            }\n        } else {\n            log.info(\"任务状态变更3\")\n            if (useTask.complete_at != null) {\n                log.info(\"任务状态变更1\")\n                data.complete_at = null //更新任务的完成时间为空\n                log.info(\"任务状态变更2\")\n            }\n        }\n        //根据工作流自动添加负责人\n        log.info(currentFlowItem.userids)\n        if (newFlowItem.userids.length() > 0) {\n            log.info(\"状态负责人已设置\")\n            //判断自动添加负责人\n            //获取任务当前的负责人userid数组\n            var taskUser = db.table(\"project_task_users\").where().eq(\"task_id\", body.task_id).eq(\"owner\", 1).select()\n            //当前的负责人\n            let userids = [];\n            for (item in taskUser) {\n                userids.push(item.userid)\n            }\n            //流转模式   \n            if (newFlowItem.usertype.contains(\'replace\')) {\n                if (useTask.parent_id == 0) { //现阶段应该还没有父任务\n                    //原本的任务负责人移至协助人员\n                    for (item in userids) {\n                        result = db.table(tableName).primary(\"task_id\").primary(\"project_id\").primary(\"userid\") update({\n                            userid: item,\n                            task_id: useTask.id,\n                            project_id: useTask.project_id,\n                            owner: 0,\n                        })\n                        log.info(\'原本的任务负责人移至协助人员\' + result)\n                    }\n\n\n                    let useridArr = newFlowItem.userids.substring(1, newFlowItem.userids.length() - 1).split(\', \')\n\n                    //改变任务负责人为状态负责人\n                    for (item in useridArr) {\n                        result = db.table(\'project_task_users\').insert({\n                            project_id: useTask.project_id,\n                            task_id: useTask.id,\n                            task_pid: useTask.id,\n                            userid: item,\n                            owner: 1,\n                            created_at: now(),\n                        })\n                        log.info(\'改变任务负责人为状态负责人\' + result)\n                    }\n                }\n            } else if (newFlowItem.usertype.contains(\'merge\')) { //剔除模式\n                if (useTask.parent_id == 0) { //现阶段应该还没有父任务\n                    //改变任务负责人为状态负责人（并保留操作状态的人员），原本的任务负责人移至协助人员。\n                    //当前用户保留\n                    //起一个数组记录要修改任务人员属性的\n                    var updateData = {}\n                    //将状态负责人都设为状态负责人\n                    for (item in newFlowItem.userid) {\n                        updateData.push({\n                            userid: item,\n                            owner: 1,\n                        })\n                    }\n                    //当前操作人员也保留是任务负责人\n                    updateData.push({\n                        userid: userid,\n                        owner: 1,\n                    })\n\n                    //更新为协助人的userid\n                    let assistUpdateList = userids.filter(userid => !updateData.some(data => data.userid === userid));\n                    log.info(\'-------------------------------\')\n                    log.info(\'assistUpdateList\')\n                    log.info(\'-------------------------------\')\n                    //将协助人列表添加到更新数据中去\n                    for (item in assistUpdateList) {\n                        updateData.push({\n                            userid: item,\n                            owner: 0,\n                        })\n                    }\n                    // 更新数据\n                    for (item in updateData) {\n                        result = db.table(\'project_task_users\').primary(\"project_id\").primary(\"task_id\").save({ //这里估计会有问题\n                            project_id: useTask.project_id,\n                            task_id: useTask.id,\n                            task_pid: useTask.id,\n                            userid: updateData.usedid,\n                            owner: updateData.owner\n                        })\n                    }\n                    //任务负责人中不是状态负责人设为任务协助人（设置owner为0）\n                }\n            } else { //添加模式\n                // 添加状态负责人至任务负责人。\n                let useridArr = newFlowItem.userids.substring(1, newFlowItem.userids.length() - 1).split(\', \')\n                for (item in useridArr) {\n                    result = db.table(\'project_task_users\')\n                        .primary(\"project_id\").primary(\"task_id\").primary(\'userid\').save({\n                            project_id: useTask.project_id,\n                            task_id: useTask.id,\n                            task_pid: useTask.id,\n                            userid: item,\n                            owner: 1,\n                            created_at: now(),\n                        })\n                }\n            }\n            //修改任务状态的日志\n            var logDetail = \'修改任务状态,change[\' + currentFlowItem.name + \',\' + newFlowItem.name + \']\'\n            var project_log = db.table(\'project_logs\').insert({\n                project_id: useTask.project_id,\n                column_id: 0,\n                task_id: useTask.id,\n                userid: userid,\n                detail: logDetail\n            })\n\n            //TODO 流程改变的记录\n            result = db.table(\'project_task_flow_changes\').insert({\n                task_id: useTask.id,\n                userid: userid,\n                before_flow_item_id: useTask.flow_item_id,\n                before_flow_item_name: useTask.flow_item_name,\n                after_flow_item_id: body.flow_item_id,\n                after_flow_item_name: body.flow_item_name,\n\n            })\n            log.info(\"流程改变的记录插入\" + result)\n        } else {\n            log.info(\"状态负责人未设置\")\n        }\n    }\n}\n\ndata.id = body.task_id\nlog.info(\'data ->task_id \' + data);\n\n//TODO  loop、visibility_appointor 重复周期先不管\n\nif (body.complete_at !== null) {\n    if (useTask.complete_at != null) {\n        exit 400, \'任务已完成\'\n    }\n\n    data.complete_at = body.complete_at\n    updateMarking.is_update_project = true;\n}\n//名称修改\nif (body.name !== null) {\n    if (body.name == \'\') {\n        exit 400, \'任务描述不能为空\'\n    }\n\n    if (body.name.length() > 255) {\n        exit 400, \'任务描述最多只能设置255个字\'\n    }\n    data.name = body.name\n    //添加日志\n    var logDetail = \'修改任务标题,change[\' + useTask.name + \',\' + body.name + \']\'\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: useTask.project_id,\n        column_id: 0,\n        task_id: useTask.id,\n        userid: userid,\n        detail: logDetail\n    })\n\n    //更新聊天室的标题\n    dialog = db.table(\'web_socket_dialogs\').primary(\'channel_id\').update({\n        channel_id: useProject.dialogId,\n        name: body.name\n    })\n\n    //更新聊天室的标题\n    // if (useTask.dialog_id) {\n    //     result = db.table(\"web_socket_dialogs\").primary(\"id\").update({\n    //         id: useTask.dialog_id,\n    //         name: body.name\n    //     })\n    // }\n}\n\n//任务负责人的修改逻辑\nif (body.owner !== null) {\n    log.info(\"body.owner value\" + body.owner)\n    // data.owner = body.owner\n    newOwner = body.owner\n    if (newOwner != \"\") {\n        if (newOwner.size() > 10) {\n            exit 400, \'任务负责人最多不能超过10个\'\n        }\n\n    }\n\n    if(newOwner==\"\"){\n        newOwner = []  //临时设为空数组\n    }\n\n\n    //强转成 string\n    let subscribers = []\n    for (item in newOwner) {\n        subscribers.push(item::string)\n    }\n\n    //TODO newOwner 要强转成 string \n    //更新频道，直接挪出去直接不见人，消息也不发了。\n    var channelId = useTask.dialog_id\n    log.info(\'subscribers value+\' + newOwner);\n    log.info(\'--------------------->\' + newOwner.size())\n    if (chanelId) {\n        var responseEntity = http.connect(wukongIMUrl + \'/channel/subscriber_add\').contentType(\'application/json\').body({\n            channel_id: channelId, // 频道的唯一ID，如果是群聊频道，建议使用群聊ID\n            channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道（个人与个人聊天不需要创建频道，系统将自动创建）\n            reset: 1, // 是否重置订阅者 （0.不重置 1.重置），选择重置，则删除旧的订阅者，选择不重置则保留旧的订阅者   \n            subscribers: subscribers, //订阅者集合\n        }).post().getBody();\n        log.info(\"更新频道返回结果\" + responseEntity)\n        if (responseEntity.status == 200) {\n            log.info(\"频道更新成功\")\n        } else {\n            log.info(\"频道更新失败\")\n            exit 400, \"频道更新失败\";\n        }\n    }\n\n\n\n\n    //原本的负责人\n    var taskUser = db.table(\"project_task_users\").where().eq(\"task_id\", body.task_id).eq(\"owner\", 1).select()\n    //找出新负责人中不在原负责人列表中的人员，然后删除\n    // let filteredTaskUser = taskUser.filter(obj => newOwner.contains(obj.userid));\n    for (item in taskUser) {\n        log.info(\"原本的负责人---------->\" + item)\n    }\n    //这句还是得改\n\n    let filteredTaskUser = taskUser.filter(obj => newOwner.contains(obj.userid));\n\n    // let filteredTaskUser = taskUser.filter(obj => newOwner.contains(obj.userid));\n    if (filteredTaskUser.size() > 0) {\n        for (item in filteredTaskUser) {\n            log.info(\'负责人不在旧列表中的->\' + item)\n        }\n    }\n\n    //先删后加\n    for (item in taskUser) {\n        db.table(\"project_task_users\").where().eq(\"id\", item.id).delete()\n    }\n\n    //TODO 如果旧的任务中已经有了就不管了\n    for (item in newOwner) {\n        log.info(\'newOwner list->\' + item)\n        result = db.table(\'project_task_users\').insert({\n            project_id: useTask.project_id,\n            task_id: useTask.id,\n            task_pid: useTask.id,\n            userid: item,\n            owner: 1,\n            created_at: now(), //TODO 考虑使用全局添加的方式\n        })\n        // result = db.table(\'project_task_users\').primary(\"project_id\").primary(\"task_id\").primary(\'userid\').save({\n        //     project_id: useTask.project_id,\n        //     task_id: useTask.task_id,\n        //     task_pid: useTask.task_pid,\n        //     userid: item, \n        //     owner: 1,\n        //     created_at: now(), //TODO 考虑使用全局添加的方式\n        // })\n\n        // db.update(\"\"\"\n        //     update project_task_users set owner = 1,created_at = now()  where project_id = #{useTask.project_id} and task_id =  #{useTask.task_id} and  userid =  #{item} \n        // \"\"\")\n    }\n\n    //删除不是负责人的\n    for (item in filteredTaskUser) {\n        result = db.table(\'project_task_users\').where().eq(\'userid\', item.userid).eq(\'project_id\', useTask.project_id).eq(\'task_id\', useTask.id).eq(\"owner\", 1).delete()\n        log.info(\'result\' + result)\n    }\n\n    //TODO 同步聊天室成员\n}\n\n//任务协助人的修改逻辑\n//  协助人\nif (body.assist !== null) {\n    log.info(\"body.assist value\" + body.assist)\n    //赋值newAssist\n    newAssist = body.assist\n\n    //强转成 string\n    let subscribers = []\n    for (item in newAssist) {\n        subscribers.push(item::string)\n    }\n    //更新频道，直接挪出去直接不见人，消息也不发了。\n    var channelId = useTask.dialog_id\n    log.info(\'subscribers value+\' + newAssist);\n    log.info(\'--------------------->\' + newAssist.size())\n    if (chanelId) {\n        var responseEntity = http.connect(wukongIMUrl + \'/channel/subscriber_add\').contentType(\'application/json\').body({\n            channel_id: channelId, // 频道的唯一ID，如果是群聊频道，建议使用群聊ID\n            channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道（个人与个人聊天不需要创建频道，系统将自动创建）\n            reset: 1, // 是否重置订阅者 （0.不重置 1.重置），选择重置，则删除旧的订阅者，选择不重置则保留旧的订阅者   \n            subscribers: subscribers, //订阅者集合\n        }).post().getBody();\n        log.info(\"任务协助人-》更新频道返回结果\" + responseEntity)\n        if (responseEntity.status == 200) {\n            log.info(\"任务协助人-》频道更新成功\")\n        } else {\n            log.info(\"任务协助人-》频道更新失败\")\n            exit 400, \"频道更新失败\";\n        }\n    } else {\n        log.info(\"chanelId为空！\")\n    }\n\n    var taskUser = db.table(\"project_task_users\").where().eq(\"task_id\", body.task_id).eq(\"owner\", 0).select()\n    //找出新协助人中不在协助人人列表中的人员，然后删除\n\n\n    let filteredTaskUser = taskUser.filter(obj => newAssist.contains(obj.userid));\n\n    // let filteredTaskUser = taskUser.filter(obj => !newAssist.includes(obj.userid)); //报错了\n\n    if (filteredTaskUser != null) {\n        log.info(\'协助人在旧列表中的\' + filteredTaskUser)\n        for (item in filteredTaskUser) {\n            log.info(\'旧的协助人列表\' + item)\n        }\n    }\n\n    //更新协助人\n    for (item in newAssist) {\n        result = db.table(\'project_task_users\').primary(\"project_id\").primary(\"task_id\").primary(\'userid\').save({\n            project_id: useTask.project_id,\n            task_id: useTask.id,\n            task_pid: useTask.id,\n            userid: item,\n            owner: 0,\n            created_at: now(), //TODO 考虑使用全局添加的方式\n        })\n    }\n\n    //删除旧的协助人\n    for (item in filteredTaskUser) {\n        result = db.table(\'project_task_users\').where().eq(\'userid\', item.userid).eq(\'project_id\', useTask.project_id).eq(\'task_id\', useTask.id).eq(\"owner\", 0).delete()\n        log.info(\'删除旧的协助人\' + result)\n    }\n\n}\n\n\n//计划时间\nif (body.times !== null) {\n    log.info(\'修改计划时间--\')\n    time = body.times\n    // data.start_at = time[0]\n    // data.end_at = time[1]\n    // log.info(data)\n\n    result = db.table(\'project_tasks\').where().eq(\'project_id\', useTask.project_id).eq(\'id\', useTask.id).update({\n        project_id: useTask.project_id,\n        id: useTask.id,\n        start_at: time[0],\n        end_at: time[1]\n    })\n\n    log.info(\"更新任务时间返回\", project_log)\n    var desc = body.desc ? \'(备注：\' + desc + \')\' : \'\'\n    var logDetail = \'修改任务时间\' + desc + \'[\' + useTask.start_at + \'~\' + useTask.end_at + \',\' + time[0] + \'~\' + time[1] + \']\'\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: useTask.project_id,\n        column_id: 0,\n        task_id: useTask.id,\n        userid: userid,\n        detail: logDetail\n    })\n    log.info(\"插入修改任务时间的日志\", project_log)\n    //TODO 还有修改备注\n\n}\nvar p = false\n//优先级相关\nvar oldPname = useTask.p_name\nif (body.p_level !== null && body.p_level != useTask.p_level) {\n    data.p_level = body.p_level\n    p = true\n}\n\nif (body.p_color !== null && body.p_color != useTask.p_color) {\n    data.p_color = body.p_color\n    p = true\n}\n\nif (body.p_name !== null && body.p_name != useTask.p_name) {\n    data.p_name = body.p_name\n    p = true\n}\n\nif (p) {\n\n    var logDetail = \'修改任务时间\' + desc + \'[\' + useTask.start_at + \'~\' + useTask.end_at + \',\' + time[0] + \'~\' + time[1] + \']\'\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: useTask.project_id,\n        column_id: 0,\n        task_id: useTask.id,\n        userid: userid,\n        detail: logDetail\n    })\n    log.info(\"修改任务优先级\" + \',change=>[\' + p_name + \',\' + \']\')\n}\n\n//颜色\nif (body.color !== null && body.color != useTask.color) {\n    data.color = body.color\n}\n\n//列表\nvar column\n\nif (body.column_id !== null) {\n    if (body.column_id != useTask.column_id) {\n        log.info(\'新列表-----\')\n        //判断列表是否存在\n        oldName = db.table(\"project_columns\").where().eq(\'project_id\', useTask.project_id).eq(\'id\', useTask.column_id).selectOne().name\n        column = db.table(\"project_columns\").where().eq(\'project_id\', useTask.project_id).eq(\'id\', body.column_id).selectOne()\n        if (column == null) {\n            exit 400, \'请选择正确的列表\'\n        }\n\n        log.info(column)\n        var logDetail = \'修改任务列表,change=>[\' + oldName + \',\' + column.name + \']\'\n        var project_log = db.table(\'project_logs\').insert({\n            project_id: useTask.project_id,\n            column_id: 0,\n            task_id: useTask.id,\n            userid: userid,\n            detail: logDetail\n        })\n        log.info(\"插入列表的日志\", project_log)\n        data.column_id = body.column_id\n\n    } else { //如果和之前一样则不考虑\n        exit 400, \'列表无变化\'\n    }\n}\n\nimport \'@/task/saveContent\' as saveContent\nimport \'cn.hutool.http.HtmlUtil\';\n//详细描述空值是允许的\nif (body.content !== null) {\n    log.info(\"进入这里\")\n    //保存html在这里先 \n    let textWithoutHtml = HtmlUtil.cleanHtmlTag(body.content);\n    log.info(textWithoutHtml)\n    //直接插入保存了，应为data不能留着\n    // data.desc = textWithoutHtml\n    //直接插入了\n    // res = db.table(\"project_tasks\").primary(\"id\").update({\n    //     id: body.task_id,\n    //     \'desc\': textWithoutHtml,\n    // })\n    db.update(\"\"\"\n        update project_tasks set `desc` = #{textWithoutHtml} where id = #{body.task_id}\n    \"\"\")\n    // log.info(\"插入desc的value\" + res)\n\n    saveUrl = saveContent(body.content, \'update\')\n    log.info(\" saveContent url --->\" + saveUrl)\n    var contentValue = {}\n    contentValue.url = saveUrl\n    if (url != \"\") {\n        log.info(\"project_id--->\" + useTask.project_id)\n        log.info(\"task_id--->\" + useTask.id)\n        log.info(\"content--->\" + contentValue::stringify)\n        // var result = db.table(\'project_task_contents\').where(\'project_id\').primary(\'task_id\').update({\n        //     project_id: project_id,\n        //     task_id: task_id,\n        //     content: contentValue::json //  这里存json\n        // })\n        //TODO 直接按插入\n        var result = db.table(\'project_task_contents\').insert({\n            project_id: useTask.project_id,\n            task_id: useTask.id,\n            content: contentValue::stringify //  这里存json\n        })\n\n        log.info(\"insert project_task_contents ->result:\", result)\n    } else {\n        exit 400, \'内容保存异常\';\n    }\n}\n\nlog.info(\'要更新的数据\' + data);\nvar result = builder.update(data, true)\nlog.info(\'result is\' + result)\n\n\n\n\n//重新查询\nuseTask = db.table(\"project_tasks\").where().eq(\"id\", body.task_id).selectOne();\n\n//任务成员列表\nvar taskUser = db.table(\"project_task_users\").where().eq(\"task_id\", body.task_id).select()\nuseTask.task_user = taskUser\n\n//任务标签 \nuseTask.task_tag = []\nreturn useTask');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"a49ed7f46073479cbf64fe8cba420d98\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"列表\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720545669791,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/lists\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"keys\",\n    \"value\" : \"\",\n    \"description\" : \"搜索条件  keys.name: ID、任务名称\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"project_id\",\n    \"value\" : \"\",\n    \"description\" : \"项目ID\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : \"0\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"parent_id\",\n    \"value\" : null,\n    \"description\" : \"主任务ID\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"timerange\",\n    \"value\" : null,\n    \"description\" : \"时间范围（如：1678248944,1678248944）  第一个时间: 读取在这个时间之后更新的数据 第二个时间: 读取在这个时间之后删除的数据ID（第1页附加返回数据: deleted_id）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"archived\",\n    \"value\" : null,\n    \"description\" : \"归档状态  all：所有（parent_id > 0 时强制 all） yes：已归档 no：未归档（默认）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"deleted\",\n    \"value\" : null,\n    \"description\" : \"是否读取已删除  all：所有 yes：已删除 no：未删除（默认）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"sorts\",\n    \"value\" : null,\n    \"description\" : \"排序方式  sorts.complete_at 完成时间：asc|desc sorts.archived_at 归档时间：asc|desc sorts.end_at 到期时间：asc|desc\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"ba3b1eb0-ecd8-4baa-8424-0efb7612b3e0\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"data\\\": [\\n            {\\n                \\\"id\\\": 127,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 127,\\n                \\\"dialog_id\\\": \\\"52ffec73044645c580c3e5fa927c21bc\\\",\\n                \\\"flow_item_id\\\": 283,\\n                \\\"flow_item_name\\\": \\\"test|待测试\\\",\\n                \\\"name\\\": \\\"仪表盘数据不正确\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462086000,\\n                \\\"end_at\\\": 1712548486000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 147,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 127,\\n                        \\\"task_pid\\\": 127,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462101000,\\n                        \\\"updated_at\\\": null\\n                    },\\n                    {\\n                        \\\"id\\\": 162,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 127,\\n                        \\\"task_pid\\\": 127,\\n                        \\\"userid\\\": 0,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712621461000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 128,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 127,\\n                \\\"dialog_id\\\": \\\"d16423fa1deb4ead912e8ad0e172142b\\\",\\n                \\\"flow_item_id\\\": 283,\\n                \\\"flow_item_name\\\": \\\"test|待测试\\\",\\n                \\\"name\\\": \\\"重新进入系统偶尔出现不正常\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"http://localhost:3000/manage/dashboard\\\",\\n                \\\"start_at\\\": 1712462100000,\\n                \\\"end_at\\\": 1712548500000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 148,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 128,\\n                        \\\"task_pid\\\": 128,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462143000,\\n                        \\\"updated_at\\\": null\\n                    },\\n                    {\\n                        \\\"id\\\": 161,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 128,\\n                        \\\"task_pid\\\": 128,\\n                        \\\"userid\\\": 0,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712597757000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 129,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 127,\\n                \\\"dialog_id\\\": \\\"131d7dd57bfb4d2d85aba94bb6e432cc\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"获取任务的聊天条数显示到任务卡片上\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462100000,\\n                \\\"end_at\\\": 1712548500000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 149,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 129,\\n                        \\\"task_pid\\\": 129,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462179000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 130,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 127,\\n                \\\"dialog_id\\\": \\\"0e1cef51ed4749b9a322eb121df68e23\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"新建任务弹窗回车键响应\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462148000,\\n                \\\"end_at\\\": 1712548548000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 150,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 130,\\n                        \\\"task_pid\\\": 130,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462220000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 131,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 127,\\n                \\\"dialog_id\\\": \\\"8b88c1481e524b5ea92c3e3896e8990c\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"新建任务的时候，是swtich按钮替换下拉选择\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462233000,\\n                \\\"end_at\\\": 1712548633000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 151,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 131,\\n                        \\\"task_pid\\\": 131,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462266000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 132,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 127,\\n                \\\"dialog_id\\\": \\\"715d431d147e40f9a2abd14f94931544\\\",\\n                \\\"flow_item_id\\\": 284,\\n                \\\"flow_item_name\\\": \\\"end|已完成\\\",\\n                \\\"name\\\": \\\"推送一版前端代码到gitee仓库\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462272000,\\n                \\\"end_at\\\": 1712548672000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": 1712469652000,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 152,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 132,\\n                        \\\"task_pid\\\": 132,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462288000,\\n                        \\\"updated_at\\\": null\\n                    },\\n                    {\\n                        \\\"id\\\": 155,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 132,\\n                        \\\"task_pid\\\": 132,\\n                        \\\"userid\\\": 0,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712469652000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 133,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 130,\\n                \\\"dialog_id\\\": \\\"b468e20948304c6a80a9038dc14d6e0c\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"新注册一个github账号\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462335000,\\n                \\\"end_at\\\": 1712548735000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 153,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 133,\\n                        \\\"task_pid\\\": 133,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462348000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 134,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 130,\\n                \\\"dialog_id\\\": \\\"3849289adf0844c09aa09b04ad60be95\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"发布项目到github\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712462357000,\\n                \\\"end_at\\\": 1712548757000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 154,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 134,\\n                        \\\"task_pid\\\": 134,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712462372000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 136,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 95,\\n                \\\"column_id\\\": 135,\\n                \\\"dialog_id\\\": \\\"dad90e0eb29d42fa9b157ae16eeeef73\\\",\\n                \\\"flow_item_id\\\": 291,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"12312\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712574415000,\\n                \\\"end_at\\\": 1712660815000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 157,\\n                        \\\"project_id\\\": 95,\\n                        \\\"task_id\\\": 136,\\n                        \\\"task_pid\\\": 136,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712574418000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 140,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 128,\\n                \\\"dialog_id\\\": \\\"fb9415b4054d4939bb76041c09da51bf\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"使用action发布安装包\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712621573000,\\n                \\\"end_at\\\": 1712707973000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 163,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 140,\\n                        \\\"task_pid\\\": 140,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712621586000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 141,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 97,\\n                \\\"column_id\\\": 139,\\n                \\\"dialog_id\\\": \\\"e19954dbd86c4f4e915cb596b5e6fc97\\\",\\n                \\\"flow_item_id\\\": 296,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"收藏夹整理\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712621607000,\\n                \\\"end_at\\\": 1712708007000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 164,\\n                        \\\"project_id\\\": 97,\\n                        \\\"task_id\\\": 141,\\n                        \\\"task_pid\\\": 141,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712621614000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 142,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 129,\\n                \\\"dialog_id\\\": \\\"469ff25665e1462085232b4740a436c2\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"标题修改报异常\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712621646000,\\n                \\\"end_at\\\": 1712708046000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 165,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 142,\\n                        \\\"task_pid\\\": 142,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712621674000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 143,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 129,\\n                \\\"dialog_id\\\": \\\"1c550e3311ad44c391275b647b890653\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"新建任务+图片异常\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712621728000,\\n                \\\"end_at\\\": 1712708128000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 166,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 143,\\n                        \\\"task_pid\\\": 143,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712621736000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 144,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 129,\\n                \\\"dialog_id\\\": \\\"0cbf2280b9324b32958ab5c52d99ebc2\\\",\\n                \\\"flow_item_id\\\": 284,\\n                \\\"flow_item_name\\\": \\\"end|已完成\\\",\\n                \\\"name\\\": \\\"删除列表报错\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712625970000,\\n                \\\"end_at\\\": 1712712370000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": 1712626138000,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 167,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 144,\\n                        \\\"task_pid\\\": 144,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712625979000,\\n                        \\\"updated_at\\\": null\\n                    },\\n                    {\\n                        \\\"id\\\": 168,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 144,\\n                        \\\"task_pid\\\": 144,\\n                        \\\"userid\\\": 0,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712626138000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 145,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 93,\\n                \\\"column_id\\\": 130,\\n                \\\"dialog_id\\\": \\\"dff73693558542fabd117055ccdd9d73\\\",\\n                \\\"flow_item_id\\\": 281,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"autoopm 在gitee搜索不到\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712626241000,\\n                \\\"end_at\\\": 1712712641000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 169,\\n                        \\\"project_id\\\": 93,\\n                        \\\"task_id\\\": 145,\\n                        \\\"task_pid\\\": 145,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712626258000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 146,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 97,\\n                \\\"column_id\\\": 139,\\n                \\\"dialog_id\\\": \\\"767bda589b474e1a95f93b2e63f98a4d\\\",\\n                \\\"flow_item_id\\\": 296,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"备忘录整理\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712626266000,\\n                \\\"end_at\\\": 1712712666000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 170,\\n                        \\\"project_id\\\": 97,\\n                        \\\"task_id\\\": 146,\\n                        \\\"task_pid\\\": 146,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712626270000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 147,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 97,\\n                \\\"column_id\\\": 139,\\n                \\\"dialog_id\\\": \\\"07f2214c603f4295a185cf6dcef91d4c\\\",\\n                \\\"flow_item_id\\\": 296,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"百度云整理\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712626271000,\\n                \\\"end_at\\\": 1712712671000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 171,\\n                        \\\"project_id\\\": 97,\\n                        \\\"task_id\\\": 147,\\n                        \\\"task_pid\\\": 147,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712626277000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 148,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 97,\\n                \\\"column_id\\\": 139,\\n                \\\"dialog_id\\\": \\\"7936c790dae641b99d2605e9ea5cc5fc\\\",\\n                \\\"flow_item_id\\\": 296,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"天翼云整理\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712626278000,\\n                \\\"end_at\\\": 1712712678000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 22,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0,\\n                \\\"task_tag\\\": [],\\n                \\\"msg_num\\\": 0,\\n                \\\"task_user\\\": [\\n                    {\\n                        \\\"id\\\": 172,\\n                        \\\"project_id\\\": 97,\\n                        \\\"task_id\\\": 148,\\n                        \\\"task_pid\\\": 148,\\n                        \\\"userid\\\": 22,\\n                        \\\"owner\\\": 1,\\n                        \\\"created_at\\\": 1712626283000,\\n                        \\\"updated_at\\\": null\\n                    }\\n                ]\\n            }\\n        ]\\n    },\\n    \\\"timestamp\\\": 1712635299683,\\n    \\\"executeTime\\\": 51\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"400\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"获取频道信息失败\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1712635212061\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"9\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\nimport env\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\n\nvar userid = StpUtil.getLoginId()\n\n//project_id为 0 时查全部\nif (project_id != 0) {\n    //判断项目是否已归档，自己在不在项目中\n    var useProject = db.table(\"projects\").where().eq(\"id\", project_id).notNull(\"archived_at\").selectOne()\n    if (useProject == null) {\n        exit 400, \'项目不存在或已归档\'\n    }\n}\n\nvar builder = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\')\n\nif (archived == \'yes\') { //已归档\n    builder.isNotNull(\"archived_at\")\n} else { //未归档\n    builder.isNull(\"archived_at\")\n}\n\n//project_id 不为 0 时这里需要判断一下\nif (project_id != 0) {\n    builder.eq(\"project_id\", project_id)\n} else {\n    // 只查询自己有权限的项目\n    var projects = db.select(\"\"\"\n        SELECT\n            p.id\n        FROM\n            project_users pu \n        JOIN\n            projects p  ON p.id = pu.project_id\n        WHERE\n            pu.userid = #{userid} \n        AND \n            p.deleted_at IS NULL\n    \"\"\")\n\n    if (projects.size() > 0) {\n        let projectList = []\n        for (item in projects) {\n            log.info(\"projects-->\", item)\n            projectList.push(item.id)\n        }\n        log.info(\"projectList-->\"+ projectList)\n        builder.in(\"project_id\",projectList)  \n    }else{\n        return []\n    }\n\n    //如果没有项目id，那就是首页，只查询和自己相关的任务\n\n    // 只查询有自己的任务\n    var tasks = db.select(\"\"\"\n        SELECT\n            p.id\n        FROM\n            project_task_users pu \n        JOIN\n            project_tasks p  ON p.id = pu.task_id\n        WHERE\n            pu.userid = #{userid} \n        AND \n            p.deleted_at IS NULL\n    \"\"\")\n\n    if (tasks.size() > 0) {\n        let taskList = []\n        for (item in tasks) {\n            taskList.push(item.id)\n        }\n        log.info(\"task_id taskList-->\"+ taskList)\n        builder.in(\"id\",taskList)  \n    }else {\n        return []\n    }\n\n}\n\nif (keys == null) {\n    log.info(\"关键词为空\")\n} else {\n    // builder.like(\"name\",keys)\n}\n\nif (timerange == null) {\n    log.info(\"timerange为空\")\n} else {\n    //时间范围\n}\n\n//TODO 删除的任务是否要看到\n\n// 时间范围 timerange\n//TODO 子任务先不考虑\n//TODO 已归档不考虑\n\n//TODO 分页暂时不考虑\nvar taskList = builder.select()\n// task.sss = 111\n\nvar taskData = [];\nimport http;\n\nfor (item in taskList) {\n    let users = []\n    var taskUserbuilder = db.table(\"project_task_users\").where().eq(\"task_id\", item.id).orderBy(\'id\')\n    //项目id为0则查所有，实际不查也没问题\n    if (project_id != 0) {\n        taskUserbuilder.eq(\"project_id\", project_id)\n    }else{\n        //如果没有项目id，那就是首页，只查询和自己相关的任务\n    }\n    taskUsers = taskUserbuilder.select()\n    item.task_tag = [] //TODO tag先不管\n    //获取频道数量\n    var useridStr = userid::string\n    // channelId = \"1213\" //频道id\n     channelId = item.dialog_id //频道id\n\n    var responseEntity = http.connect(wukongIMUrl+\'/channel/messagesync\').contentType(\'application/json\').body({\n        channel_id: channelId, // 频道的唯一ID，如果是群聊频道，建议使用群聊ID\n        channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道（个人与个人聊天不需要创建频道，系统将自动创建）\n        start_message_seq: 0,\n        end_message_seq: 10000,\n        limit:100,\n        pull_mode:1,\n    }).post().getBody();\n\n    log.info(\"获取频道信息列表responseEntity\" + responseEntity)\n\n    // if (responseEntity.status == 200) {\n    //     log.info(\"获取频道信息成功\")\n    // } else {\n    //     log.info(\"获取频道信息失败\")\n    //     exit 400, \"获取频道信息失败\";\n    // }\n\n    \n\n    item.msg_num = responseEntity.messages.size() //数量\n    //item.file_num = 99 //文件数量\n    // log.info(\"-----------\")\n    if (taskUsers != null) {\n        if (taskUsers.size() > 0) {\n            users.push(taskUsers)\n            // log.info(\"-----------taskUsers size >0\")\n            item.task_user = users\n        } else {\n            item.task_user = []\n        }\n        // item.task_user = []\n\n    } else {\n        log.info(\"-----------taskUsers size =0\")\n        item.task_user = []\n    }\n\n    // log.info(\"taskUsers is:::\"+taskUsers)\n    // log.info(taskUsers)\n    // taskList.task_user = users\n}\nvar data = {\n    data\n}\ndata.data = taskList\n\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/创建或获取聊天室.ms', '{\n  \"properties\" : { },\n  \"id\" : \"df886e402ace4dfe97f877cabd29c07b\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"创建或获取聊天室\",\n  \"createTime\" : 1720519096351,\n  \"updateTime\" : 1713024593761,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/dialog\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : null,\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\ntask = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\nif (task == null) {\n    exit 400, \'任务不存在\';\n}\n\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/删除任务-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"ab852a29e8614b089e27c0dcad1430da\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"删除任务-待测试\",\n  \"createTime\" : 1720519096360,\n  \"updateTime\" : 1713024593833,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/remove\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : \"194\",\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : \"\",\n    \"description\" : \"类型 recovery: 还原 delete: 删除（默认）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"delete\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"5aaaf652-1abb-4213-9709-e99296c8c250\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1712684564102,\\n    \\\"executeTime\\\": 11\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\n//判断个人项目是否已经存在\nvar userid = StpUtil.getLoginId()\nlog.info(\"userid is\" + userid)\n\n\nvar useTask = db.table(\"project_tasks\").where().eq(\"id\",task_id).selectOne()\nif (useTask != null) {\n    //TODO 推送消息\n    if (type == \'recovery\') { //还原操作\n      //暂时不考虑\n\n    } else { //删除操作，软删除\n        //先删除聊天室\n        // db.table(\"WebSocketDialog\").where().eq(\"id\", useTask.dialog_id).delete()\n        // //删除任务，标记删除人\n        db.table(\"project_tasks\").primary(\"id\", task_id).update({\n            id:task_id,\n            deleted_at:now(),\n            deleted_userid:userid, \n        })\n\n        //添加操作日志\n        var logDetail = \'删除任务\' //TODO 应该还带其他的\n        var project_log = db.table(\'project_logs\').insert({\n            project_id: useTask.project_id,\n            column_id: 0,\n            task_id: useTask.id,\n            userid: userid,\n            detail: logDetail\n        })\n        //推送删除消息\n    }\n}\nreturn \'success\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/删除任务文件-待完善.ms', '{\n  \"properties\" : { },\n  \"id\" : \"24e7f553acdd45338192b1b480b7911b\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"删除任务文件-待完善\",\n  \"createTime\" : 1720519096368,\n  \"updateTime\" : 1713024593911,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"filedelete\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"file_id\",\n    \"value\" : null,\n    \"description\" : \"文件id\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\n//确认文件是否还存在\nimport log\nvar builder = db.table(\"project_task_files\").where().eq(\"file_id\", file_id)\nvar file = builder.selectOne()\nif (file == null) {\n    exit 400, \'文件不存在或已被删除\';\n}\n//查找项目名称\nvar useTask = db.table(\"project_tasks\").where().eq(\"id\", file.task_id).selectOne()\nif (useTask != null) {\n    //TODO 推送消息\n}\n\nresult = builder.delete() //TODO 修改成软删除\n\nlog.info(\'删除任务文件---->\' + result)\nreturn \'success\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/归档任务.ms', '{\n  \"properties\" : { },\n  \"id\" : \"1eea8c09693b497497c75307d5977705\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"归档任务\",\n  \"createTime\" : 1720519096400,\n  \"updateTime\" : 1713024593991,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/archived\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : null,\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : null,\n    \"description\" : \"String\\t 类型  add：归档（默认） recovery：还原归档\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"add\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'@/task/archivedTask\' as archivedTask\n\ntask = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\nif (task == null) {\n    exit 400, \'任务不存在\';\n}\n\nif (task.parent_id > 0) {\n    exit 400, \'子任务不支持此功能\';\n}\nif (type == \'add\') { //归档\n    archivedTask(now())\n} else if (type == \'recovery\') { //还原归档\n    archivedTask(null)\n}\n\nreturn \'操作成功\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/添加任务-已废弃.ms', '{\n  \"properties\" : { },\n  \"id\" : \"5039c6a3a36f4eeab48b10476b8728c0\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"添加任务-已废弃\",\n  \"createTime\" : 1720519096415,\n  \"updateTime\" : 1713024594161,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/add\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"cascader\\\": [\\n    84,\\n    181\\n  ],\\n  \\\"name\\\": \\\"12313\\\",\\n  \\\"content\\\": \\\"<p>31313</p>\\\",\\n  \\\"owner\\\": [\\n    1\\n  ],\\n  \\\"assist\\\": [],\\n  \\\"project_id\\\": 84,\\n  \\\"column_id\\\": 181,\\n  \\\"times\\\": [\\n    \\\"2024-01-27 09:00\\\",\\n    \\\"2024-01-28 18:00\\\"\\n  ],\\n  \\\"subtasks\\\": [],\\n  \\\"p_level\\\": 1,\\n  \\\"p_name\\\": \\\"重要且紧急\\\",\\n  \\\"p_color\\\": \\\"#ED4014\\\",\\n  \\\"visibility_appoint\\\": 1,\\n  \\\"visibility_appointor\\\": []\\n}\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"03be7949-9a0f-4a49-be4c-1831527749e0\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"Content-Type\",\n    \"value\" : \"application/json\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1706326527141,\\n    \\\"executeTime\\\": 35\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"cascader\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"84\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"name\",\n      \"value\" : \"12313\",\n      \"description\" : \"\",\n      \"required\" : true,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"content\",\n      \"value\" : \"<p>31313</p>\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"owner\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"1\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"assist\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"project_id\",\n      \"value\" : \"84\",\n      \"description\" : \"\",\n      \"required\" : true,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"column_id\",\n      \"value\" : \"181\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"times\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"2024-01-27 09:00\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"subtasks\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"p_level\",\n      \"value\" : \"1\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"p_name\",\n      \"value\" : \"重要且紧急\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"p_color\",\n      \"value\" : \"#ED4014\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"visibility_appoint\",\n      \"value\" : \"1\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"visibility_appointor\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1706029998978\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"278\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\n//判断个人项目是否已经存在\nvar userid = StpUtil.getLoginId()\nlog.info(\"userid is\" + userid)\n\nvar projectId = body.project_id\nvar columnId = body.column_id\n\n//判断项目是否已归档，自己在不在项目中\nvar useProject = db.table(\"projects\").where().eq(\"id\", projectId).notNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\n\nif (body.name.length() == 0) {\n    exit 400, \'描述不能为空\'\n}\n\nif (body.content.length() > 255) {\n    exit 400, \'描述最多只能设置255个字\'\n}\n\nvar column\nvar newColumn\n//获取列表对应的列表信息\nif (columnId) {\n    log.info(\'进到这里column_id：\' + columnId);\n    if (columnId > 0) {\n        //从项目任务列表中找到那个列表\n        column = db.table(\"project_columns\").where().eq(\"project_id\", projectId).eq(\"id\", columnId).selectOne()\n    }\n    //如果还是找不到列表，试着用column_id作为名字去查找\n    if (column == null) {\n        column = db.table(\"project_columns\").where().eq(\"project_id\", projectId).eq(\"name\", columnId).selectOne()\n    }\n} else {\n    //如果没有则使用第一个任务列表\n    column = db.table(\"project_columns\").where().eq(\"project_id\", projectId).orderBy(\"id\").selectOne()\n}\n//如果再没有则创建新的\nif (column == null) {\n    log.info(\'column is null\')\n    var tempColumnName\n    if (columnId == null) {\n        tempColumnName = \'Default\'\n    }\n    sort = 0\n    //设置排序\n    var columnResult = db.table(\"project_columns\").where().eq(\"id\", projectId).orderByDesc(\'sort\').selectOne()\n    if (columnResult != null) {\n        sort = columnResult.sort + 1\n        log.info(\'sort is\' + sort)\n    }\n    var result = db.table(\'project_columns\').insert({\n        project_id: projectId,\n        name: tempColumnName,\n        sort: sort,\n    })\n    log.info(\'插入任务列表的结果：\' + result)\n    //创建创建列表日志\n    var logDetail = \'创建列表\' + tempColumnName\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: projectId,\n        column_id: 0,\n        task_id: 0,\n        userid: userid,\n        detail: logDetail\n    })\n    newColumn = db.table(\"project_columns\").where().eq(\"id\", result).selectOne()\n    newColumn.project_task = []\n}\nif (newColumn = null) {\n    exit 400, \'任务列表不存在或已被删除\'\n}\n\n\nvar flowItemId\nvar flowItemName\n\n//工作流处理\nvar projectFlow = db.table(\"project_flows\").where().eq(\"project_id\", projectId).selectOne()\nlog.info(\'projectFlow:\' + projectFlow)\n\n\nif (projectFlow != null) { //开启工作流的项目\n    var projectFlowItem = db.table(\"project_flow_items\").where().eq(\"flow_id\", projectFlow.id).select()\n    log.info(\'projectFlowItem:\' + projectFlowItem)\n    //赋开始状态\n    for (item in projectFlowItem) {\n        if (item.status == \'start\') {\n            flowItemId = item.id\n            flowItemName = item.status + \'|\' + item.name\n        }\n    }\n\n} else { //未开始工作流的项目\n\n\n}\n\n//插入任务表\nvar taskResult = db.table(\'project_tasks\').insert({\n    parent_id: 0, //如果有子任务这里要修改\n    project_id: projectId,\n    column_id: column.id,\n    name: body.name,\n    userid: userid,\n    flow_item_id: flowItemId,\n    flow_item_name: flowItemName,\n    //优先级相关\n    p_level: p_level,\n    p_name: p_name,\n    p_color: p_color,\n    //排序\n})\nlog.info(\'taskResult:\' + taskResult)\n//插入任务用户表\nvar val = db.transaction(() => {\n    //TODO 创建者的逻辑\n    var owner = 1\n    var result = db.table(\'project_task_users\').insert({\n        project_id: projectId,\n        task_id: taskResult,\n        task_pid: taskResult,\n        userid: userid,\n        owner: owner\n    })\n\n    //可见性先不考虑了\n    //子任务也先不考虑了\n    log.info(\'插入任务用户表结果\' + result)\n\n})\n\n\nlog.info(\'插入任务表\' + result)\nvar data = db.table(\"project_tasks\").where().eq(\"id\", result).selectOne()\n//TODO 下面这部分应该不会出现，一边创建项目一边创建任务列表\n\n// 可见性设置\n// 首次聊天后才会创建聊天室，所以这里不创建聊天室\n// if(newColumn){\n//      //将data 转成数组\n//      data.new_column = newColumn\n// }\n//推送消息\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/添加任务(get方法)-完善中.ms', '{\n  \"properties\" : { },\n  \"id\" : \"copy1706327758311d38348\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"添加任务(get方法)-完善中\",\n  \"createTime\" : 1720519096405,\n  \"updateTime\" : 1716877593713,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/add\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"cascader\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : \"123123\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"content\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"owner\",\n    \"value\" : \"1\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"assist\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"project_id\",\n    \"value\" : \"29\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"column_id\",\n    \"value\" : \"59\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"times\",\n    \"value\" : \"2024-02-27 11:08:08,2024-02-28 11:08:08\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"subtasks\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"p_level\",\n    \"value\" : \"1\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"p_name\",\n    \"value\" : \"重要且紧急\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"p_color\",\n    \"value\" : \"#ED4014\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"visibility_appoint\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"visibility_appointor\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"top\",\n    \"value\" : \"0\",\n    \"description\" : \"添加的任务排到列表最前面\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"544fe5f6-99c6-4b6f-8cbe-0188b4b82c18\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711017913618,\\n    \\\"executeTime\\\": 13\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"cascader\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"84\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"name\",\n      \"value\" : \"12313\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"content\",\n      \"value\" : \"<p>31313</p>\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"owner\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"1\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"assist\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"project_id\",\n      \"value\" : \"84\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"column_id\",\n      \"value\" : \"181\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"times\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"2024-01-27 09:00\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"subtasks\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"p_level\",\n      \"value\" : \"1\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"p_name\",\n      \"value\" : \"重要且紧急\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"p_color\",\n      \"value\" : \"#ED4014\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"visibility_appoint\",\n      \"value\" : \"1\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"visibility_appointor\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711017691614\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"5\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport cn.hutool.core.util.ReUtil\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\nimport \'@/project/use\' as use\n\nimport \'cn.hutool.core.util.ReUtil\';\nimport \'cn.hutool.core.date.DateUtil\';\nimport \'cn.hutool.core.io.FileUtil\';\nimport \'cn.hutool.core.io.IoUtil\';\nimport \'cn.hutool.core.util.StrUtil\';\nimport \'cn.hutool.http.HttpUtil\';\nimport env\n\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\n\n//判断个人项目是否已经存在\nvar userid = StpUtil.getLoginId()\nlog.info(\"userid is\" + userid)\n\nvar projectId = project_id\nvar columnId = column_id\n\n//判断项目是否已归档，自己在不在项目中\nvar useProject = db.table(\"projects\").where().eq(\"id\", projectId).notNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\n\nif (name.length() == 0) {\n    exit 400, \'描述不能为空\'\n}\n\nvar column\nvar newColumn\n//获取列表对应的列表信息\nif (columnId) {\n    log.info(\'进到这里column_id：\' + columnId);\n    if (columnId > 0) {\n        //从项目任务列表中找到那个列表\n        column = db.table(\"project_columns\").where().eq(\"project_id\", projectId).eq(\"id\", columnId).selectOne()\n    }\n    //如果还是找不到列表，试着用column_id作为名字去查找\n    if (column == null) {\n        column = db.table(\"project_columns\").where().eq(\"project_id\", projectId).eq(\"name\", columnId).selectOne()\n    }\n} else {\n    //如果没有则使用第一个任务列表\n    column = db.table(\"project_columns\").where().eq(\"project_id\", projectId).orderBy(\"id\").selectOne()\n}\n//如果再没有则创建新的\nif (column == null) {\n    log.info(\'column is null\')\n    var tempColumnName\n    if (columnId == null) {\n        tempColumnName = \'Default\'\n    }\n    sort = 0\n    //设置排序\n    var columnResult = db.table(\"project_columns\").where().eq(\"id\", projectId).orderByDesc(\'sort\').selectOne()\n    if (columnResult != null) {\n        sort = columnResult.sort + 1\n        log.info(\'sort is\' + sort)\n    }\n    var result = db.table(\'project_columns\').insert({\n        project_id: projectId,\n        name: tempColumnName,\n        sort: sort,\n    })\n    log.info(\'插入任务列表的结果：\' + result)\n    //创建创建列表日志\n    var logDetail = \'创建列表\' + tempColumnName\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: projectId,\n        column_id: 0,\n        task_id: 0,\n        userid: userid,\n        detail: logDetail\n    })\n    newColumn = db.table(\"project_columns\").where().eq(\"id\", result).selectOne()\n    newColumn.project_task = []\n}\nif (newColumn = null) {\n    exit 400, \'任务列表不存在或已被删除\'\n}\n\n\nvar flowItemId\nvar flowItemName\n\n//工作流处理\nvar projectFlow = db.table(\"project_flows\").where().eq(\"project_id\", projectId).selectOne()\nlog.info(\'projectFlow:\' + projectFlow)\n\n\nif (projectFlow != null) { //开启工作流的项目\n    var projectFlowItem = db.table(\"project_flow_items\").where().eq(\"flow_id\", projectFlow.id).select()\n    log.info(\'projectFlowItem:\' + projectFlowItem)\n    //赋开始状态\n    for (item in projectFlowItem) {\n        if (item.status == \'start\') {\n            flowItemId = item.id\n            flowItemName = item.status + \'|\' + item.name\n        }\n    }\n} else { //未开始工作流的项目\n\n\n}\n\n//TODO 项目内未完成任务不能超过2000个\ntasks = db.table(\"project_tasks\").where().eq(\"project_id\", project_id).select()\n\nif (tasks.size() > 2000) {\n    exit 400, \'项目内未完成任务不能超过2000个\';\n}\n\n// //插入的数据\n// var data = {}\n// data.parent_id = 0\n// data.project_id = projectId\n// data.column_id = column.id\n// name: name,\n//     userid: userid,\n//     flow_item_id: flowItemId,\n//     flow_item_name: flowItemName,\n//     //优先级相关\n//     p_level: p_level,\n//     p_name: p_name,\n//     p_color: p_color,\n\nlog.info(\"info\" + times)\nstart_time = \"\"\nend_time = \"\"\n\n//时间处理\nif (times != \"\") {\n    log.info(\"info111\" + times)\n    let timeArr = times.split(\',\');\n    if (timeArr.size() == 2) {\n        start_time = timeArr[0]\n        end_time = timeArr[1]\n    }\n}\n\nimport cn.hutool.core.util.IdUtil;\nimport http;\n\n//TODO 创建频道，并将自己加入\nlet subscribers = []\nvar useridStr = userid::string\nlog.info(\'useridStr:\' + useridStr);\nsubscribers.push(useridStr)\n//频道id\nchannelId = IdUtil.simpleUUID()\nlog.info(\'item+\' + subscribers);\nfor (item in subscribers) {\n    log.info(\'item+\' + subscribers);\n}\n\n//TODO 创建频道，并将自己加入\nvar responseEntity = http.connect(wukongIMUrl+\'/channel\').contentType(\'application/json\').body({\n    channel_id: channelId, // 频道的唯一ID，如果是群聊频道，建议使用群聊ID\n    channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道（个人与个人聊天不需要创建频道，系统将自动创建）\n    large: 0, // 是否是超大群，0.否 1.是 （一般建议500成员以上设置为超大群，注意：超大群不会维护最近会话数据。）\n    ban: 0, // 是否封禁此频道，0.否 1.是 （被封后 任何人都不能发消息，包括创建者）\n    subscribers: subscribers, // 设// 订阅者集合\n}).post().getBody();\nlog.info(\"添加任务加入频道返回responseEntity\" + responseEntity)\n\n//TODO 判断成功与否\n\n\n//TODO 判断列表是不是属于这个项目\n//插入任务表\nvar taskResult = db.table(\'project_tasks\').insert({\n    parent_id: 0, //如果有子任务这里要修改\n    project_id: projectId,\n    column_id: column_id,\n    name: name,\n    userid: userid, //创建人\n    flow_item_id: flowItemId,\n    flow_item_name: flowItemName,\n    //优先级相关\n    p_level: p_level,\n    p_name: p_name,\n    p_color: p_color,\n    //时间\n    start_at: start_time,\n    end_at: end_time,\n    dialog_id: channelId,\n    //排序\n    //TODO 内容\n})\n\n//插入dialog表\nvar dialog = db.table(\"web_socket_dialogs\").insert({\n    name: name,\n    type: \"group\",\n    group_type: \"task\",\n    channel_id: channelId,\n})\n\nlog.info(\'taskResult:\' + taskResult)\n\n\nimport \'@/task/saveContent\' as saveContent\nimport \'cn.hutool.http.HtmlUtil\';\n\nif (content != null) {\n    let textWithoutHtml = HtmlUtil.cleanHtmlTag(content);\n    log.info(textWithoutHtml)\n    db.update(\"\"\"\n        update project_tasks set `desc` = #{textWithoutHtml} where id = #{taskResult}\n    \"\"\")\n    saveUrl = saveContent(content, \'update\')\n    log.info(\" saveContent url --->\" + saveUrl)\n    var contentValue = {}\n    contentValue.url = saveUrl\n    if (url != \"\") {\n        log.info(\"project_id--->\" + projectId)\n        log.info(\"task_id--->\" + taskResult)\n        log.info(\"content--->\" + contentValue::stringify)\n        //TODO 直接按插入\n        var result = db.table(\'project_task_contents\').insert({\n            project_id: projectId,\n            task_id: taskResult,\n            content: contentValue::stringify //  这里存json\n        })\n    } else {\n        exit 400, \'内容保存异常\';\n    }\n}\n\nvar result\n//负责人\n//TODO 负责人所有项目未完成加起来不能超过500个\nif (owner != \"\" && owner.length() > 0) {\n    log.info(\"owner：：\" + owner)\n    let ownerArr = owner.split(\',\');\n    for (item in ownerArr) {\n        result = db.table(\'project_task_users\').insert({\n            project_id: projectId,\n            task_id: taskResult,\n            task_pid: taskResult, //不考虑父id\n            userid: item,\n            owner: 1,\n            created_at: now(),\n        })\n        log.info(\"负责人插入用户表\" + result)\n    }\n}\nif (assist != null) {\n    if (assist != \"\" && assist.length() > 0) {\n        log.info(\"assist\" + assist)\n        log.info(\"assist.length()\" + assist.length())\n        let assistArr = assist.split(\',\');\n        log.info(\"assistArr size\" + assistArr.size())\n        for (item in assistArr) {\n            log.info(\"assistArr item\" + item)\n            result = db.table(\'project_task_users\').insert({\n                project_id: projectId,\n                task_id: taskResult,\n                task_pid: taskResult, //不考虑父id\n                userid: item,\n                owner: 0,\n                created_at: now(),\n            })\n            log.info(\"协助人插入用户表\" + result)\n        }\n    }\n\n}\n\n\n//如果负责人和协助人都没有，就要添加自己为协助人\nif (assist == \"\" && owner == \"\") {\n    result = db.table(\'project_task_users\').insert({\n        project_id: projectId,\n        task_id: taskResult,\n        task_pid: taskResult, //不考虑父id\n        userid: userid,\n        owner: 0,\n        created_at: now(),\n    })\n    log.info(\"自己插入用户表\" + result)\n}\n\n// //协助人\n// var owner = userid\n// result = db.table(\'project_task_users\').insert({\n//     project_id: projectId,\n//     task_id: taskResult,\n//     task_pid: taskResult,\n//     userid: userid,\n//     owner: owner,\n//     created_at: now(),\n// })\n//可见性先不考虑了\n//子任务也先不考虑了\nlog.info(\'插入任务用户表结果\' + result)\n// })\nvar data = db.table(\"project_tasks\").where().eq(\"id\", taskResult).selectOne()\n//TODO 下面这部分应该不会出现，一边创建项目一边创建任务列表\n//任务用户\nvar taskUser = db.table(\"project_task_users\").where().eq(\"task_id\", taskResult).select()\nlog.info(\"taskUser\" + taskUser)\n\ndata.task_user = taskUser\ndata.task_tag = []\n\n// data.task_user =  db.table(\"project_task_users\").where().eq(\"task_id\", result).select() \n// 可见性设置\n// 首次聊天后才会创建聊天室，所以这里不创建聊天室\n// if(newColumn){\n//      //将data 转成数组\n//      data.new_column = newColumn\n// }\n//推送消息\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/简单列表-.ms', '{\n  \"properties\" : { },\n  \"id\" : \"6edef24287614f1e9225cec2116ad5fb\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"简单列表-\",\n  \"createTime\" : 1720519096423,\n  \"updateTime\" : 1713024594248,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/easylists\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"taskid\",\n    \"value\" : null,\n    \"description\" : \"排除的任务ID\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"userid\",\n    \"value\" : null,\n    \"description\" : \"用户ID（如：1,2）\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"timerange\",\n    \"value\" : null,\n    \"description\" : \"时间范围（如：2022-03-01 12:12:12,2022-05-01 12:12:12）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"12313\\\",\\n    \\\"timestamp\\\": 1706291248711,\\n    \\\"executeTime\\\": 1\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1706269500881\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"0\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\n//TODO 接口未实现,暂时不考虑任务冲突的时\n// \nvar data = {\n    data\n}\ndata.data = []\nreturn  data\n\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/获取任务文件列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"21b1658fce9345c7bcebcdda5efac173\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"获取任务文件列表\",\n  \"createTime\" : 1720519096429,\n  \"updateTime\" : 1713024594331,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/files\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : null,\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\n//TODO 打算集成新的东西来实现\ntask = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\n\nif (task == null) {\n    exit 400, \'任务不存在\';\n}\nfiles = db.table(\"project_task_files\").where().eq(\"task_id\", task_id).orderByDesc(\"id\").select();\nreturn files.size() > 0 ? files : []');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/获取任务文件详情.ms', '{\n  \"properties\" : { },\n  \"id\" : \"8ddf64d5cc344219beb4f9611bfd12fc\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"获取任务文件详情\",\n  \"createTime\" : 1720519096433,\n  \"updateTime\" : 1713024594405,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/filedetail\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"file_id\",\n    \"value\" : \"\",\n    \"description\" : \"文件ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport org.ssssssss.magicboot.utils.MinioUtil\nimport log\nfile = db.table(\"project_task_files\").where().eq(\"id\", file_id).selectOne()\nif (file == null) {\n    exit 400, \'文件不存在\';\n}\n\nvar result = {}\n\n//文件实际的路径\nresult.path = MinioUtil.preview(file.name)\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/获取任务详细描述.ms', '{\n  \"properties\" : { },\n  \"id\" : \"07b4cadafed54738b6f9fa439930af56\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"获取任务详细描述\",\n  \"createTime\" : 1720519096438,\n  \"updateTime\" : 1713024594479,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/content\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : \"217\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 44,\\n        \\\"project_id\\\": 111,\\n        \\\"task_id\\\": 217,\\n        \\\"content\\\": \\\"<p>4444441213131231313131</p>\\\\n<p><img src=\\\\\\\"http://82.157.62.190:9000/task/2024-03-02/2383d8d71e8b43b4bdd71fb47f804e47.jpeg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=admin%2F20240301%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20240301T172451Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=edbf883076d5f60f88d1edd59a7a6acf65a07957277306720950dffe840557a1\\\\\\\" original-width=\\\\\\\"1814\\\\\\\" original-height=\\\\\\\"1068\\\\\\\" /><img src=\\\\\\\"http://82.157.62.190:9000/task/2024-03-02/2383d8d71e8b43b4bdd71fb47f804e47.jpeg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=admin%2F20240301%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20240301T172451Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=edbf883076d5f60f88d1edd59a7a6acf65a07957277306720950dffe840557a1\\\\\\\" original-width=\\\\\\\"1814\\\\\\\" original-height=\\\\\\\"1068\\\\\\\" /></p>\\\\n\\\"\\n    },\\n    \\\"timestamp\\\": 1709314554762,\\n    \\\"executeTime\\\": 25\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"task_id\",\n      \"value\" : \"217\",\n      \"description\" : \"任务id\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"content\",\n      \"value\" : \"<p>121313</p>\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"id\",\n        \"value\" : \"44\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"project_id\",\n        \"value\" : \"111\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"task_id\",\n        \"value\" : \"217\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"content\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"String\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1709314391849\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"12\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport \'org.ssssssss.magicboot.utils.MinioUtil\';\nvar useTask = db.table(\"project_tasks\").where().eq(\"id\", task_id).selectOne()\nif (useTask == null) {\n    exit 400, \"任务不存在\";\n}\n\nlog.info(\"useTask.content----: \" + useTask.id)\nlog.info(\"useTask.content----: \" + useTask.name)\nlog.info(\"useTask.content----: \" + useTask.desc)\nlog.info(useTask)\nlog.info(\"useTask.content----: \")\n\n\nif (useTask.desc == \"\") {\n    return {}\n}\n\ntaskContent = db.table(\"project_task_contents\").where().eq(\"task_id\", useTask.id).orderByDesc(\"id\").selectOne()\n\nlog.info(\"contentValue11111111----: \")\nlog.info(taskContent.content)\nlog.info(\"taskContent\")\n\nvar result = {}\nif (taskContent != null) {\n\n    json = taskContent.content::json\n    log.info(\"json value\" + json)\n    // url = json.url\n    // log.info(\"url value\" + url)\n    contentValue = MinioUtil.getContent(json.url)\n    log.info(\"contentValue: \" + contentValue)\n    result.id = taskContent.id\n    result.project_id = useTask.project_id\n    result.task_id = useTask.id\n    //获取远程url中的minio中的文件的内容\n    result.content = contentValue\n\n}\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务/获取单个任务信息-进行中.ms', '{\n  \"properties\" : { },\n  \"id\" : \"7f04e97c9f274a869bb0dc974260c359\",\n  \"script\" : null,\n  \"groupId\" : \"f2a82a98ff1d49a3904430542a3d776d\",\n  \"name\" : \"获取单个任务信息-进行中\",\n  \"createTime\" : 1720519096445,\n  \"updateTime\" : 1713024594560,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/one\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"task_id\",\n    \"value\" : \"173\",\n    \"description\" : \"任务ID\",\n    \"required\" : true,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"archived\",\n    \"value\" : null,\n    \"description\" : \"归档状态  all：所有 yes：已归档 no：未归档（默认）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 173,\\n        \\\"parent_id\\\": 0,\\n        \\\"project_id\\\": 98,\\n        \\\"column_id\\\": 216,\\n        \\\"dialog_id\\\": 0,\\n        \\\"flow_item_id\\\": 227,\\n        \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n        \\\"name\\\": \\\"123\\\",\\n        \\\"color\\\": \\\"\\\",\\n        \\\"desc\\\": \\\"\\\",\\n        \\\"start_at\\\": 1708304400000,\\n        \\\"end_at\\\": 1708423200000,\\n        \\\"archived_at\\\": null,\\n        \\\"archived_userid\\\": 0,\\n        \\\"archived_follow\\\": 0,\\n        \\\"complete_at\\\": null,\\n        \\\"userid\\\": 1,\\n        \\\"visibility\\\": 1,\\n        \\\"p_level\\\": 1,\\n        \\\"p_name\\\": \\\"重要且紧急\\\",\\n        \\\"p_color\\\": \\\"#ED4014\\\",\\n        \\\"sort\\\": 0,\\n        \\\"loop\\\": \\\"\\\",\\n        \\\"loop_at\\\": null,\\n        \\\"created_at\\\": null,\\n        \\\"updated_at\\\": null,\\n        \\\"deleted_at\\\": null,\\n        \\\"deleted_userid\\\": 0,\\n        \\\"taskUser\\\": [\\n            {\\n                \\\"id\\\": 169,\\n                \\\"project_id\\\": 98,\\n                \\\"task_id\\\": 173,\\n                \\\"task_pid\\\": 173,\\n                \\\"userid\\\": 1,\\n                \\\"owner\\\": 1,\\n                \\\"created_at\\\": 1708311999000,\\n                \\\"updated_at\\\": null\\n            },\\n            {\\n                \\\"id\\\": 170,\\n                \\\"project_id\\\": 98,\\n                \\\"task_id\\\": 173,\\n                \\\"task_pid\\\": 173,\\n                \\\"userid\\\": 1,\\n                \\\"owner\\\": 1,\\n                \\\"created_at\\\": 1708311999000,\\n                \\\"updated_at\\\": null\\n            }\\n        ],\\n        \\\"taskTag\\\": [],\\n        \\\"project_name\\\": \\\"测试\\\",\\n        \\\"column_name\\\": \\\"Default\\\"\\n    },\\n    \\\"timestamp\\\": 1708313748899,\\n    \\\"executeTime\\\": 28\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708313636471\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"10\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\n//todo 判断项目是否可用 已删除状态先不考虑\n//arch  yes  no all：所有\n\nvar arch = archived\nvar builder = db.table(\"project_tasks\").where().eq(\"id\", task_id)\n\nvar task\n\nif (arch == \'all\') { //获取所有\n    task = builder.selectOne() //TODO 针对不同类型返回报错\n} else if (arch == \'yes\') { //获取已归档\n    task = builder.notNull(\"archived_at\").selectOne() //TODO 针对不同类型返回报错\n} else { //获取未归档 \n    task = builder.isNull(\"archived_at\").selectOne() //TODO 针对不同类型返回报错\n}\nif (task == null) {\n    exit 400, \'任务不存在\';\n}\n\ntaskUsers = db.table(\"project_task_users\").where().eq(\"project_id\", task.project_id).eq(\"task_id\", task.id).orderBy(\'id\').select()\n\nvar useProject = db.table(\"projects\").where().eq(\"id\", task.project_id).selectOne()\nvar column = db.table(\"project_columns\").where().eq(\"id\", task.column_id).selectOne()\n\ntaskTag = []\n\n//获取统计信息\n// task.push({\n//     taskUser: taskUsers,\n//     taskTag: taskTag,\n//     project_name: useProject.name,\n//     column_name: column.name,\n// })\ntask.taskUser = taskUsers\ntask.taskTag = taskTag\ntask.project_name = useProject.name\ntask.column_name = column.name\n\nreturn task');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"45cfe6d453b047dd9a1c2b8c9f241edf\",\n  \"name\" : \"任务列表\",\n  \"type\" : \"api\",\n  \"parentId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"path\" : \"/column\",\n  \"createTime\" : 1720519095437,\n  \"updateTime\" : 1713024590226,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/修改任务列表-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"631a594c0e974efc8deb47fe81892e03\",\n  \"script\" : null,\n  \"groupId\" : \"45cfe6d453b047dd9a1c2b8c9f241edf\",\n  \"name\" : \"修改任务列表-待测试\",\n  \"createTime\" : 1720519096474,\n  \"updateTime\" : 1713024594630,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/update\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"column_id\",\n    \"value\" : null,\n    \"description\" : \"列表ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : null,\n    \"description\" : \"列表名称\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"color\",\n    \"value\" : null,\n    \"description\" : \"颜色\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport log\nimport \'@/project/use\' as use\nimport \'@/project/log\' as addlog\n\n//查找是否有这个列表\nvar column = db.table(\"project_columns\").where().eq(\"id\", column_id).selectOne()\nif (column == null) {\n    exit 400, \'列表不存在\'\n}\n//判断项目是否已归档，自己在不在项目中\nvar useProject = use()\n\n//修改任务列表\nvar val = db.transaction(() => {\n    var updateData = {}\n    //判断名称修改是否一致 \n    if (name != null && column.name != name) {\n        updateData.name = name\n        //TODO 添加日志\n    }\n\n    //颜色修改\n    if (color != null && column.color != color) {\n        updateData.color = color\n        //TODO 添加日志\n    }\n    updateData.id = column.id\n    builder = db.table(\"project_columns\").primary(\"id\").update(updateData)\n})\n\n//推送修改成功消息\nreturn \'修改成功\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/删除任务列表-已完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"4e21e775e1a54250bdd2d94d07bfc8f0\",\n  \"script\" : null,\n  \"groupId\" : \"45cfe6d453b047dd9a1c2b8c9f241edf\",\n  \"name\" : \"删除任务列表-已完成\",\n  \"createTime\" : 1720519096480,\n  \"updateTime\" : 1713024594709,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/remove\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"column_id\",\n    \"value\" : \"131\",\n    \"description\" : \"列表ID（留空为添加列表）\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"删除成功\\\",\\n    \\\"timestamp\\\": 1712626109818,\\n    \\\"executeTime\\\": 19\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"400\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"项目不存在或已归档\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1712626055690\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"5\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n//查找是否有这个列表\nvar column = db.table(\"project_columns\").where().eq(\"id\", column_id).selectOne()\nif (column == null) {\n    exit 400, \'列表不存在\'\n}\n//判断项目是否已归档，自己在不在项目中\nvar useProject = db.table(\"projects\").where().eq(\"id\", column.project_id).isNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\n\n//删除任务列表\nvar val = db.transaction(() => {\n    var taskList = db.table(\"project_tasks\").where().eq(\"column_id\", column_id).select()\n    if (taskList.size() > 0) {\n        //遍历任务列表\n        for (task in taskList) {\n              //删除会话\n              var result   =  db.table(\'web_socket_dialogs\').where().eq(\"id\",task.dialog_id).delete()\n              log.info(\"result-->\",result)\n              //删除任务本身\n              result = db.table(\'project_tasks\').where().eq(\"id\",task.id).delete()  \n              log.info(\"result-->\",result)\n              \n        }\n    }\n    //TODO userid 使用当前登录用户的\n    //删除列表  \n    var delResult = db.table(\"project_columns\").where().eq(\"id\", column_id).delete()\n    log.info(\"delResult is \" + delResult)\n    //添加日志\n    var logDetail = \'删除列表\' + name\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: projectId,\n        column_id: 0,\n        task_id: 0,\n        userid: userid,\n        detail: logDetail\n    })\n\n})\nreturn \'删除成功\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/添加任务列表-已完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"85090fe98f88476b8021c5d2b6d35e84\",\n  \"script\" : null,\n  \"groupId\" : \"45cfe6d453b047dd9a1c2b8c9f241edf\",\n  \"name\" : \"添加任务列表-已完成\",\n  \"createTime\" : 1720519096488,\n  \"updateTime\" : 1713024594787,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/add\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"65\",\n    \"description\" : \"项目ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : \"测试列表1\",\n    \"description\" : \"列表名称\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1706430574825,\\n    \\\"executeTime\\\": 33\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1706430505295\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"35\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n//判断项目是否已归档，自己在不在项目中\nvar useProject = db.table(\"projects\").where().eq(\"id\", project_id).notNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\nvar columCount = db.table(\"project_columns\").where().eq(\"id\", project_id).count()\nif (columCount > 50) {\n    exit 400, \'项目列表最多不能超过50个\'\n}\n//根据查询出来的排序+1\nvar sort = 0\nvar columnList = db.table(\"project_columns\").where().eq(\"id\", project_id).orderByDesc(\'sort\').selectOne()\nif (columnList!=null && columnList.size() > 0) {\n    sort = columnList.sort + 1\n}\n\nlog.info(\'sort ->\' + sort);\nvar columId = db.table(\'project_columns\').insert({\n    project_id: project_id,\n    name: name,\n    sort: sort\n})\n\nlog.info(\'columId ->\' + columId);\n//添加日志  \n//TODO userid用登录用户的\nvar logDetail = \'创建列表\' + name\nvar project_log = db.table(\'project_logs\').insert({\n    project_id: projectId,\n    column_id: columId,\n    task_id: 0,\n    userid: userid,\n    detail: logDetail\n})\n\nvar data = db.table(\"project_columns\").where().eq(\"project_id\", project_id).eq(\"id\", columId).selectOne()\n\n\nlog.info(\'data data  data ->\' + data);\n// data.project_task = []\n//TODO 还要返回添加成功\nreturn data\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/获取任务列表-已完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"6c42b4e0d502406aa2e5a433137307b4\",\n  \"script\" : null,\n  \"groupId\" : \"45cfe6d453b047dd9a1c2b8c9f241edf\",\n  \"name\" : \"获取任务列表-已完成\",\n  \"createTime\" : 1720519096495,\n  \"updateTime\" : 1713024594861,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/lists\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"65\",\n    \"description\" : \"项目ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"page\",\n    \"value\" : null,\n    \"description\" : \"当前页，默认:1\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"pagesize\",\n    \"value\" : null,\n    \"description\" : \"每页显示数量，默认:100，最大:200\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [\\n        {\\n            \\\"id\\\": 156,\\n            \\\"projectId\\\": 65,\\n            \\\"name\\\": \\\"\\\",\\n            \\\"color\\\": \\\"\\\",\\n            \\\"sort\\\": 0,\\n            \\\"createdAt\\\": null,\\n            \\\"updatedAt\\\": null,\\n            \\\"deletedAt\\\": null\\n        },\\n        {\\n            \\\"id\\\": 160,\\n            \\\"projectId\\\": 65,\\n            \\\"name\\\": \\\"测试列表1\\\",\\n            \\\"color\\\": \\\"\\\",\\n            \\\"sort\\\": 0,\\n            \\\"createdAt\\\": null,\\n            \\\"updatedAt\\\": null,\\n            \\\"deletedAt\\\": null\\n        },\\n        {\\n            \\\"id\\\": 161,\\n            \\\"projectId\\\": 65,\\n            \\\"name\\\": \\\"VR\\\",\\n            \\\"color\\\": \\\"\\\",\\n            \\\"sort\\\": 0,\\n            \\\"createdAt\\\": null,\\n            \\\"updatedAt\\\": null,\\n            \\\"deletedAt\\\": null\\n        }\\n    ],\\n    \\\"timestamp\\\": 1706248632811,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1706066844557\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"15\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n//判断项目是否已归档，自己在不在项目中\nvar useProject = db.table(\"projects\").where().eq(\"id\", project_id).notNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\n\nvar result = {\n    data\n}\n\n//TODO 分页暂时不考虑\nvar columnList = db.table(\"project_columns\").where().eq(\"project_id\", project_id).orderBy(\'sort\').orderBy(\'id\').select()\nresult.data = columnList\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/任务列表/获取任务列表详细-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"a392458067ad4bf597af2a96077fbbea\",\n  \"script\" : null,\n  \"groupId\" : \"45cfe6d453b047dd9a1c2b8c9f241edf\",\n  \"name\" : \"获取任务列表详细-待测试\",\n  \"createTime\" : 1720519096502,\n  \"updateTime\" : 1713024594939,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/one\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"column_id\",\n    \"value\" : null,\n    \"description\" : \"列表ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"deleted\",\n    \"value\" : null,\n    \"description\" : \"是否读取已删除  all：所有 yes：已删除 no：未删除（默认）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\nvar builder = db.table(\"project_columns\").where().eq(\"id\", column_id)\n\nif (deleted == \'all\') {\n    //不处理，就是查所有\n} else if (deleted == \'yes\') {\n    builder.notNull(\'deleted_at\')\n}\ncolumn = builder.selectOne()\nif (column == null) {\n    exit 400, \'列表不存在\';\n}\nreturn column');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/修改项目.ms', '{\n  \"properties\" : { },\n  \"id\" : \"e294c30226fa4e75ab474294a1c9e789\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"修改项目\",\n  \"createTime\" : 1720519096121,\n  \"updateTime\" : 1714468474154,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/update\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"9\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"expression\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : \"修改的名称2\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"expression\",\n    \"error\" : \"项目名称最少设置2个字\",\n    \"expression\" : \"value.length()>2\",\n    \"children\" : null\n  }, {\n    \"name\" : \"desc\",\n    \"value\" : \"测试的描述22\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"expression\",\n    \"error\" : \"项目介绍最多只能设置255个字\",\n    \"expression\" : \"value.length()<255\",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"5b57b554-2a1f-4cb9-ae48-1336b58914bc\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"修改项目接口\\\",\\n    \\\"timestamp\\\": 1705324211263,\\n    \\\"executeTime\\\": 20399\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1705322951677\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"427\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n//TODO  已归档或者其他状态下的项目不能操作\n//查找项目信息\nvar useProject = db.table(\"projects\").where().eq(\"id\",project_id).notNull(\"archived_at\").selectOne()\nif (useProject ==null) {\n    exit 400, \'项目不存在或已归档\'\n}\nlog.info(\'useProject:\'+useProject)\n\nvar val = db.transaction(() => {\n    var logDetail = \"修改项目名称\"+useProject.name+\"=>\"+name\n    //插入日志\n    var project_log = db.table(\'project_logs\').insert({\n        project_id: project_id,\n        column_id: 0,\n        task_id: 0,\n        userid: userid,\n        detail: logDetail\n    })\n\n    //更新聊天室的信息（主要是名称）\n    db.table(\'web_socket_dialogs\').primary(\'channel_id\').update({\n        channel_id: useProject.dialogId,\n         name: name\n    })\n\n    //更新项目信息\n    db.table(\'projects\').primary(\'id\').update({\n        id: project_id,\n        name: name\n    })\n\n    // log.info(\'desc:\'+desc)\n    if (desc1){\n        var logDetail = \"修改项目介绍\"\n        //插入日志\n        var project_log = db.table(\'project_logs\').insert({\n            project_id: project_id,\n            column_id: 0,\n            task_id: 0,\n            userid: userid,\n            detail: logDetail\n        })  \n\n        //  var descStr = desc\n         log.info(\'desc1:\'+desc1)\n         log.info(\'project_id:\'+project_id)\n        //更新项目信息 这里分成2步执行，需要优化成一个sql执行\n        // db.table(\'projects\').primary(\'id\').update({\n        //     id: project_id,\n        //     `desc`: desc\n        //  })\n    }else{\n         log.info(\'描述为空\')\n    }\n});\n\n\n//推送更新通知\n\n\nreturn \'修改项目接口\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/修改项目成员-ok.ms', '{\n  \"properties\" : { },\n  \"id\" : \"ef2191dc61ba491cb4a295d221f6fb51\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"修改项目成员-ok\",\n  \"createTime\" : 1720519096133,\n  \"updateTime\" : 1716877465979,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/user\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"35\",\n    \"description\" : \"项目ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : \"\",\n    \"children\" : null\n  }, {\n    \"name\" : \"userid\",\n    \"value\" : \"21,17\",\n    \"description\" : \"成员ID 或 成员ID组\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"d625f2aa-4130-40d6-9e8a-7d89f44422a6\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"修改成功\\\",\\n    \\\"timestamp\\\": 1711107258377,\\n    \\\"executeTime\\\": 34\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708446696677\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"21\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport http;\nimport env\n\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\n\n\nif (!StpUtil.isLogin()) {\n    exit - 1, \'请登录后继续\';\n}\nvar projectId = project_id\nvar loginUserid = StpUtil.getLoginId()\nvar userids = userid.split(\',\'); //最新的项目成员id数组\nif (userids.getLength() > 100) { //判断项目人数最多100人\n    exit 400, \'项目人数最多100人\'\n}\nvar useProject = db.table(\"projects\").where().eq(\"id\", projectId).notNull(\"archived_at\").selectOne() //获取项目信息\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\n\n\n//启动事务\nvar val = db.transaction(() => {\n\n    //更新频道信息\n    var channelId = useProject.dialog_id\n\n    log.info(\'useProject channelId+\' + channelId);\n    log.info(\'useProject value+\' + useProject);\n    log.info(useProject);\n    //处理进来的用户 id\n    // let subscribers = []\n    // for (item in userids) {\n    // subscribers.push(useridStr)\n    // }\n    log.info(\'userids value+\' + userids);\n\n\n    //强转成 string\n    let subscribers = []\n    for (item in userids) {\n        subscribers.push(item::string)\n    }\n\n    log.info(\"开始请求1\")\n    if (chanelId != \"\") {\n        log.info(\"开始请求2\")\n        var responseEntity = http.connect(wukongIMUrl + \'/channel/subscriber_add\').contentType(\'application/json\').body({\n            channel_id: channelId, // 频道的唯一ID，如果是群聊频道，建议使用群聊ID\n            channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道（个人与个人聊天不需要创建频道，系统将自动创建）\n            reset: 1, // 是否重置订阅者 （0.不重置 1.重置），选择重置，则删除旧的订阅者，选择不重置则保留旧的订阅者   \n            subscribers: subscribers, //订阅者集合\n        }).post().getBody();\n        log.info(\"开始请求3\")\n        log.info(\"更新频道返回结果\" + responseEntity)\n\n        if (responseEntity.status == 200) {\n            log.info(\"频道更新成功\")\n        } else {\n            log.info(\"频道更新失败\")\n            exit 400, \"频道更新失败\";\n        }\n    }\n\n\n\n\n    //新增的项目成员加入项目\n    //旧的列表中的数据\n    var oldUserList = db.table(\'project_users\').where().eq(\'project_id\', projectId).select()\n    // //要更新的数组\n    // var updateUser = []\n    // for (item in oldUserList) {\n    //     for (item2 in userids) { //如果遍历中存在\n    //         if (item.userid == item2) {\n    //             updateUser.push(item2)\n    //         }\n    //     }\n    // }\n    log.info(userids::string)\n    var updateItems = userids.filter(item => oldUserList.some(obj => obj.userid == item));\n    log.info(\"updateItems\")\n    // log.info(updateItems)\n    for (item in updateItems) {\n        log.info(\"更新列表数据：\" + item::string)\n        // db.table(\'project_users\').primary(\'project_id\').primary(\"userid\").update({\n        //     project_id: projectId,\n        //     userid: item,\n        //     owner: 1\n        // })\n\n        // db.table(\"project_users\").primary(\'project_id\', \'userid\').update({\n        //     project_id: projectId,\n        //     userid: item,\n        //     owner: 1\n        // })\n        db.update(\"\"\"\n            update project_users set owner = 1  where project_id = #{projectId} and userid =  #{item}\n        \"\"\")\n\n        //         var projectTasks = db.select(\"\"\"\n        //     SELECT\n        //         project_tasks.*,\n        //         project_task_users.owner,\n        //         1 AS assist\n        //     FROM\n        //         project_tasks\n        //     left JOIN\n        //         project_task_users ON project_tasks.id = project_task_users.task_id\n        //     WHERE\n        //         project_task_users.userid = #{userid}\n        //     AND\n        //         project_task_users.owner = 1 \n        //     AND\n        //         project_task_users.project_id = #{project_id}     \n        // \"\"\")\n\n    }\n\n    var unequalItems = userids.filter(item => !oldUserList.some(obj => obj.userid == item));\n    log.info(\"不在列表中的进行插入\")\n    for (item in unequalItems) {\n        log.info(\"不在列表中的进行插入\" + item)\n        db.table(\"project_users\").insert({\n            project_id: projectId,\n            userid: item,\n            owner: 1\n        })\n    }\n    //获取不在表中的人员id的信息\n    var userList = db.table(\'project_users\').where().eq(\'project_id\', projectId).notIn(\'userid\', userids).select()\n\n    //移除的人员id数组\n    log.info(\"移除的人员id数组 ->\" + userList)\n    //如果有删除人员,将这些人员退出任务和聊天室\n    if (userList.size() > 0) {\n        let deleteUserIds = [];\n        //获取删除掉的人员的id列表\n        for (item in userList) {\n            deleteUserIds.push(item.userid)\n        }\n        log.info(\"deleteUserIds is \", deleteUserIds)\n        //获取到删除人员的所有项目任务，从用户表找到相关的任务id列表\n        var taskUserList = db.table(\'project_task_users\').where().eq(\'project_id\', projectId).in(\'userid\', deleteUserIds).select()\n        log.info(\"任务列表 taskUserList is \", taskUserList)\n        // log.info(taskUserList)\n        if (taskUserList.size() > 0) {\n            var tastIds = [];\n            for (taskUser in taskUserList) {\n                tastIds.push(taskUser.taskId)\n            }\n            log.info(\"tastIds is \" + tastIds)\n        }\n\n        if (taskIds != null) {\n            //循环删除项目和项目聊天室 todo 先不考虑子任务的情况\n            for (task in tastIds) {\n                //获取的任务聊天室dialogId\n                var taskDialogId = task.dialogId\n                //退出任务聊天室\n                var taskDialogResult = db.table(\'web_socket_dialog_users\').where().eq(\'dialog_id\', taskDialogId).in(\'userid\', deleteUserIds).delete()\n            }\n            //退出任务 删除项目任务用户表\n            var delResult = db.table(\'project_task_user\').where().eq(\'project_id\', projectId).in(\'userid\', deleteUserIds).delete()\n            log.info(\"删除项目任务用户表\" + delResult)\n        }\n\n        //从项目用户表中移除\n        var delUserResult = db.table(\'project_users\').where().eq(\'project_id\', projectId).notIn(\'userid\', userids).delete()\n        log.info(\"delUserResult result --->\" + delUserResult)\n    }\n\n    // //同步项目聊天室成员\n    // var dialog = db.table(\'web_socket_dialogs\').where().eq(\'id\', useProject.dialog_id).selectOne()\n\n    //TODO 同步项目聊天室成员\n    // log.info(\"dialog is \" + dialog)\n    // //聊天id\n    // var dialogId = dialog.id\n    // for (item in userids) {\n    //     var result = db.table(\'web_socket_dialog_user\').primary(\'id\').saveOrUpdate({\n    //         dialog_id: dialogId,\n    //         userid: item\n    //     })\n    //     log.info(\"web_socket_dialog_user result  ->\" + result)\n    // }\n    // //将移除的用户从项目聊天室中移除\n    // var delResult = db.table(\'web_socket_dialog_user\').where().eq(\'dialog_id\', dialogId).notIn(\'userid\', userids).delete()\n    // log.info(\"delResult  ->\" + delResult)\n});\n\n//添加项目修改成员日志 todo 确认放不放userid ，这个userid是使用的当前用户还是列表上传的\nvar logDetail = \'修改项目成员\'\nvar project_log = db.table(\'project_logs\').insert({\n    project_id: projectId,\n    column_id: 0,\n    task_id: 0,\n    userid: loginUserid,\n    detail: logDetail\n})\n\n//推送成员移除消息\nreturn \'修改成功\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/删除项目-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"01577be29c86402090331f67fdd726db\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"删除项目-待测试\",\n  \"createTime\" : 1720519096145,\n  \"updateTime\" : 1716877617158,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/remove\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"85\",\n    \"description\" : \"项目id\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"6c2ca735-04aa-4305-8036-5e90535d6355\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1712059662458,\\n    \\\"executeTime\\\": 66\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'@/project/use\' as use\nimport \'@/project/log\' as logI\nimport log\nimport http\nimport env\n\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\n//判断项目状态\nvar useProject = use()\nvar val = db.transaction(() => {\n    //删除项目聊天室  TODO 标记已读状态\n    // db.table(\"web_socket_dialogs\").primary(\"id\").update({\n    //     id: useProject.dialog_id,\n    //     userid: userid,\n    //     deleted_at: now()\n    // })\n    //删除项目聊天室\n    channelId = useProject.dialog_id\n    log.info(\"channelId--->\",channelId)\n    //删除频道id\n    var responseEntity = http.connect(wukongIMUrl+\'/channel/delete\').contentType(\'application/json\').body({\n        channel_id: channelId, // 频道的唯一ID\n        channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道\n    }).post().getBody();\n    log.info(\"删除频道返回responseEntity\" + responseEntity)\n    if (responseEntity.status == 200) {\n        log.info(\"删除频道成功\")\n    } else {\n        log.info(\"删除频道失败\")\n        exit 400, \"删除频道失败\";\n    }\n    //\n    //删除项目\n    db.table(\"projects\").primary(\"id\").update({\n        id: project_id,\n        deleted_at: now()\n    })\n\n    // 删除任务列表\n    columns = db.table(\"project_columns\").where().eq(\"project_id\", project_id).select()\n    for (item in columns) {\n        //遍历出所有任务\n        tasks = db.table(\"project_tasks\").where().eq(\"project_id\", item).select()\n        //删除任务\n        for (item2 in tasks) {\n            db.table(\"project_tasks\").primary(\"id\").update({\n                id: item2.id,\n                deleted_at: now()\n            })\n        }\n        //删除列表\n        db.table(\"project_columns\").primary(\"id\").update({\n            id: item.id,\n            deleted_at: now()\n        })\n    }\n    //添加删除日志\n    logI(\'删除项目\')\n});\n\nvar data = {\n    \"id\":useProject.id\n}\n//推送删除信息\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/工作流/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/工作流/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"3c96b136ec424b4ba5425699a669f2e1\",\n  \"name\" : \"工作流\",\n  \"type\" : \"api\",\n  \"parentId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"path\" : \"/flow\",\n  \"createTime\" : 1720519095453,\n  \"updateTime\" : 1713024590303,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/工作流/保存工作流-进行中.ms', '{\n  \"properties\" : { },\n  \"id\" : \"1ca7db2e1db34f2e9a43c5659cc45912\",\n  \"script\" : null,\n  \"groupId\" : \"3c96b136ec424b4ba5425699a669f2e1\",\n  \"name\" : \"保存工作流-进行中\",\n  \"createTime\" : 1720519096508,\n  \"updateTime\" : 1713024595023,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/save\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"project_id\\\": 65,\\n  \\\"flows\\\": [\\n    {\\n      \\\"id\\\": 186,\\n      \\\"project_id\\\": 65,\\n      \\\"flow_id\\\": 54,\\n      \\\"name\\\": \\\"待处理\\\",\\n      \\\"status\\\": \\\"start\\\",\\n      \\\"turns\\\": [\\n        186,\\n        187,\\n        188,\\n        189,\\n        190,\\n        -288709\\n      ],\\n      \\\"userids\\\": \\\"[]\\\",\\n      \\\"usertype\\\": \\\"add\\\",\\n      \\\"userlimit\\\": 0,\\n      \\\"columnid\\\": 0,\\n      \\\"sort\\\": 0,\\n      \\\"created_at\\\": null,\\n      \\\"updated_at\\\": null\\n    },\\n    {\\n      \\\"id\\\": 187,\\n      \\\"project_id\\\": 65,\\n      \\\"flow_id\\\": 54,\\n      \\\"name\\\": \\\"进行中\\\",\\n      \\\"status\\\": \\\"progress\\\",\\n      \\\"turns\\\": [\\n        186,\\n        187,\\n        188,\\n        189,\\n        190,\\n        -288709\\n      ],\\n      \\\"userids\\\": \\\"[]\\\",\\n      \\\"usertype\\\": \\\"add\\\",\\n      \\\"userlimit\\\": 0,\\n      \\\"columnid\\\": 0,\\n      \\\"sort\\\": 1,\\n      \\\"created_at\\\": null,\\n      \\\"updated_at\\\": null\\n    },\\n    {\\n      \\\"id\\\": 188,\\n      \\\"project_id\\\": 65,\\n      \\\"flow_id\\\": 54,\\n      \\\"name\\\": \\\"待测试\\\",\\n      \\\"status\\\": \\\"test\\\",\\n      \\\"turns\\\": [\\n        186,\\n        187,\\n        188,\\n        189,\\n        190,\\n        -288709\\n      ],\\n      \\\"userids\\\": \\\"[]\\\",\\n      \\\"usertype\\\": \\\"add\\\",\\n      \\\"userlimit\\\": 0,\\n      \\\"columnid\\\": 0,\\n      \\\"sort\\\": 2,\\n      \\\"created_at\\\": null,\\n      \\\"updated_at\\\": null\\n    },\\n    {\\n      \\\"id\\\": 189,\\n      \\\"project_id\\\": 65,\\n      \\\"flow_id\\\": 54,\\n      \\\"name\\\": \\\"已完成\\\",\\n      \\\"status\\\": \\\"end\\\",\\n      \\\"turns\\\": [\\n        186,\\n        187,\\n        188,\\n        189,\\n        190,\\n        -288709\\n      ],\\n      \\\"userids\\\": \\\"[]\\\",\\n      \\\"usertype\\\": \\\"add\\\",\\n      \\\"userlimit\\\": 0,\\n      \\\"columnid\\\": 0,\\n      \\\"sort\\\": 3,\\n      \\\"created_at\\\": null,\\n      \\\"updated_at\\\": null\\n    },\\n    {\\n      \\\"id\\\": 190,\\n      \\\"project_id\\\": 65,\\n      \\\"flow_id\\\": 54,\\n      \\\"name\\\": \\\"已取消\\\",\\n      \\\"status\\\": \\\"end\\\",\\n      \\\"turns\\\": [\\n        186,\\n        187,\\n        188,\\n        189,\\n        190,\\n        -288709\\n      ],\\n      \\\"userids\\\": \\\"[]\\\",\\n      \\\"usertype\\\": \\\"add\\\",\\n      \\\"userlimit\\\": 0,\\n      \\\"columnid\\\": 0,\\n      \\\"sort\\\": 4,\\n      \\\"created_at\\\": null,\\n      \\\"updated_at\\\": null\\n    },\\n    {\\n      \\\"id\\\": -288709,\\n      \\\"name\\\": \\\"已处理\\\",\\n      \\\"status\\\": \\\"end\\\",\\n      \\\"turns\\\": [\\n        186,\\n        187,\\n        188,\\n        189,\\n        190,\\n        -288709\\n      ],\\n      \\\"userids\\\": [],\\n      \\\"usertype\\\": \\\"add\\\",\\n      \\\"userlimit\\\": 0,\\n      \\\"columnid\\\": 0,\\n      \\\"sort\\\": 5\\n    }\\n  ]\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 400,\\n    \\\"message\\\": \\\"至少需要1个开始状态\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711591926381,\\n    \\\"executeTime\\\": 35\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"project_id\",\n      \"value\" : \"64\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"flows\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"id\",\n          \"value\" : \"176\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"project_id\",\n          \"value\" : \"64\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"flow_id\",\n          \"value\" : \"53\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"name\",\n          \"value\" : \"待处理\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"status\",\n          \"value\" : \"start\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"turns\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Array\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ {\n            \"name\" : \"\",\n            \"value\" : \"176\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          } ]\n        }, {\n          \"name\" : \"userids\",\n          \"value\" : \"[]\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"usertype\",\n          \"value\" : \"add\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"userlimit\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"columnid\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"sort\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"created_at\",\n          \"value\" : \"null\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"updated_at\",\n          \"value\" : \"null\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        } ]\n      } ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"400\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"至少需要1个开始状态\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711560039607\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"19\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport \'@/project/addFlow\' as addFlow;\nflows = body.flows\nlog.info(\"flows\" + flows)\nif (flows.size() < 1) {\n    exit 400, \"参数异常\";\n}\nvar projectFlow = addFlow(flows, body.project_id)\nreturn projectFlow');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/工作流/工作流列表-已完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"2403ef9ba25f4317a666746d738b8774\",\n  \"script\" : null,\n  \"groupId\" : \"3c96b136ec424b4ba5425699a669f2e1\",\n  \"name\" : \"工作流列表-已完成\",\n  \"createTime\" : 1720519096517,\n  \"updateTime\" : 1713024595100,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/list\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"9\",\n    \"description\" : \"项目ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"pass\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711524039572,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"id\",\n          \"value\" : \"7\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"projectId\",\n          \"value\" : \"9\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"name\",\n          \"value\" : \"Default\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"createdAt\",\n          \"value\" : \"2024-01-12 09:43:18\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"updatedAt\",\n          \"value\" : \"2024-01-12 09:43:18\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"flowId\",\n          \"value\" : \"7\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"status\",\n          \"value\" : \"start\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"turns\",\n          \"value\" : \"[31,32,33,34,35]\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"userids\",\n          \"value\" : \"[]\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"usertype\",\n          \"value\" : \"add\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"String\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"userlimit\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"columnid\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"sort\",\n          \"value\" : \"0\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1706066500340\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"17\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport \'@/project/use\' as use\nvar useProject = use()\n\n//TODO  已归档或者其他状态下的项目不能操作\n//查找项目信息\n// var useProject = db.table(\"projects\").where().eq(\"id\", project_id).notNull(\"archived_at\").selectOne()\n// if (useProject == null) {\n//     exit 400, \'项目不存在或已归档\'\n// }\n\n\n\nlog.info(\'useProject:\' + useProject)\n\nvar flow = db.table(\"project_flows\").where().eq(\"project_id\", project_id).selectOne()\nlog.info(\'flow:\' + flow)\nif (flow == null) {\n    return []\n    // exit 400, \"项目未开启工作流\" //这项需要验证\n}\nvar items = db.table(\"project_flow_items\").where().eq(\"flow_id\", flow.id).select()\nlog.info(\'items:\' + items)\nlet flowItems = [];\nfor (flow in items) {\n    var tmpTurn = flow.turns\n    if (tmpTurn.length() > 2) {\n        let turnArr = []\n        turnstr = tmpTurn.substring(1, tmpTurn.length() - 1).split(\", \")\n        for (item2 in turnstr) {\n            turnArr.push(item2::int)\n        }\n        flow.turns = turnArr\n    }\n}\nflowItems.push(items)\nflow.project_flow_item = flowItems\n\nlet result = [];\nresult.push(flow)\n\n// var flows = db.select(\"\"\"\n//     SELECT\n//         project_flow_items.*,\n//         project_flows.project_id\n//     FROM\n//         project_flows\n//     JOIN\n//         project_flow_items ON project_flows.id = project_flow_items.flow_id\n//     WHERE\n//         project_flows.project_id =  #{project_id}\n// \"\"\")\n\n// var data = {\n//     data,\n//     project_flow_item\n// }\n\n\n\n// log.info(\'flows:\' + flows)\n\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/归档项目-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"8f41947b64b24a4ead432dc8bac31c20\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"归档项目-待测试\",\n  \"createTime\" : 1720519096153,\n  \"updateTime\" : 1713325106985,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/archived\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"788\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : null,\n    \"description\" : \"类型： add：归档（默认） recovery：还原归档\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"add\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"1084b6f5-ce65-4d93-b2f4-6e9d7ac409af\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 400,\\n    \\\"message\\\": \\\"项目不存在或已归档\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1707222657055,\\n    \\\"executeTime\\\": 6\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1706941533641\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"21\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'@/project/use\' as use\nimport \'@/project/log\' as log\nimport \'@/project/archivedProject\' as archivedProject\n// 暂时不考虑子任务\nvar useProject = use()\nif (type == \'recovery\') { //还原归档\n    archivedProject(null)\n} else { //添加归档\n    archivedProject(now())\n}\n\nvar data = {}\ndata.id = useProject.id\n//推送归档信息\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/排序任务.ms', '{\n  \"properties\" : { },\n  \"id\" : \"e6ef7fe6cf5942c980581044e77a5dff\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"排序任务\",\n  \"createTime\" : 1720519096161,\n  \"updateTime\" : 1713325102555,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/sort\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n  \\\"project_id\\\": 94,\\n  \\\"sort\\\": [\\n    {\\n      \\\"id\\\": 133,\\n      \\\"task\\\": []\\n    },\\n    {\\n      \\\"id\\\": 134,\\n      \\\"task\\\": [\\n        135\\n      ]\\n    }\\n  ],\\n  \\\"only_column\\\": 0\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": [],\\n    \\\"timestamp\\\": 1712569802656,\\n    \\\"executeTime\\\": 16\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"project_id\",\n      \"value\" : \"92\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"sort\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Array\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Object\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"id\",\n          \"value\" : \"126\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Integer\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ ]\n        }, {\n          \"name\" : \"task\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Array\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ {\n            \"name\" : \"\",\n            \"value\" : \"125\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          } ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"only_column\",\n      \"value\" : \"0\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1712563007008\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"3\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\n\nvar useProject = db.table(\"projects\").where().eq(\"id\", body.project_id).isNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\n\nif (only_column) { //仅仅有默认列表 TODO 遇到再测试\n    for (item in body.sort) {\n        indexSort = 0\n        log.info(\'item value\' + item)\n        // if (item.task.size() > 0) {\n        // for (item2 in item.task) {\n        log.info(\'item2 value\' + item2)\n        result = db.update(\"\"\"\n        UPDATE project_tasks SET sort = #{indexSort}  WHERE id = #{item.id}  and project_id = #{body.project_id}\n        \"\"\")\n        log.info(\"update result \" + result)\n        //父任务先不管\n        indexSort++\n        // }\n        // }\n\n    }\n    return []\n\n} else {\n    for (item in body.sort) {\n        indexSort = 0\n        log.info(\'item value\' + item)\n        if (item.task.size() > 0) {\n            for (item2 in item.task) {\n                log.info(\'item2 value\' + item2)\n                result = db.update(\"\"\"\n        UPDATE project_tasks SET sort = #{indexSort} ,column_id = #{item.id}  WHERE id = #{item2}  and project_id = #{body.project_id} and complete_at is null\n        \"\"\")\n                log.info(\"update result \" + result)\n                //父任务先不管\n                indexSort++\n            }\n        }\n    }\n    return []\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/添加项目.ms', '{\n  \"properties\" : { },\n  \"id\" : \"132df1e24b504aef807c77e5e67c1020\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"添加项目\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720940854596,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/add\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"name\",\n    \"value\" : \"12331212\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"pass\",\n    \"error\" : \"项目名称不能少于2个字\",\n    \"expression\" : \"\",\n    \"children\" : null\n  }, {\n    \"name\" : \"desc\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : \"项目介绍最多只能设置255个字\",\n    \"expression\" : \"value.length()>255\",\n    \"children\" : null\n  }, {\n    \"name\" : \"columns\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"flow\",\n    \"value\" : \"open\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"personal\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"2119d6a4-79bf-4fee-b0d7-e4677d1f7657\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1711609127547,\\n    \\\"executeTime\\\": 45\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1711608941416\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"17\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\nimport cn.hutool.core.util.IdUtil;\nimport http;\nimport \'@/project/addFlow\' as addFlow;\nimport env\n\nvar wukongIMUrl = env.get(\"wukongim.endpoint\")\nlog.info(\"wukongIMUrl\" + wukongIMUrl);\n\nif (name.length() > 32) {\n    exit 400, \'项目名称最多设置32个字符\'\n}\n\n\nlet insertColumns = [];\n//分割列表\nif (columns != \"\") {\n    let columnsArr = columns.split(\',\');\n    let insertColumns = [];\n    let sort = 0;\n    //创建列表参数 排序\n    for (item in columnsArr) {\n        insertColumns.push({\n            \'name\': item.trim(),\n            \'sort\': sort++\n        })\n    }\n} else {\n    log.info(\'--------------->columns无值:\' + columns)\n}\nif (insertColumns.size() == 0) {\n    insertColumns.push({\n        \'name\': \'Default\',\n        \'sort\': 0\n    })\n}\n\n//限制列表数量不超过30个\nif (insertColumns.size() > 30) {\n    exit 400, \'项目列表最多不能超过30个\'\n}\n\nvar project\nvar projectId\n//判断个人项目是否已经存在\nvar userid = StpUtil.getLoginId()\n// var userid = 6  //测试时候放开\nif (personal) {\n    project = db.table(\"projects\").where().eq(\"userid\", userid).eq(\"personal\", 1) selectOne()\n    log.info(\"person project is.  \" + project)\n    if (project.size() > 0) {\n        exit 400, \'个人项目已存在，无须重复创建\'\n    }\n    //返回的project中personal赋值1\n    project.personal = 1\n}\n\n\n\n//启动事务\nvar val = db.transaction(() => {\n    // 创建频道，并将自己加入\n    let subscribers = []\n    var useridStr = userid::string\n    subscribers.push(useridStr)\n    channelId = IdUtil.simpleUUID() //频道id\n    var responseEntity = http.connect(wukongIMUrl+\'/channel\').contentType(\'application/json\').body({\n        channel_id: channelId, // 频道的唯一ID，如果是群聊频道，建议使用群聊ID\n        channel_type: 2, // 频道的类型 1.个人频道 2.群聊频道（个人与个人聊天不需要创建频道，系统将自动创建）\n        large: 0, // 是否是超大群，0.否 1.是 （一般建议500成员以上设置为超大群，注意：超大群不会维护最近会话数据。）\n        ban: 0, // 是否封禁此频道，0.否 1.是 （被封后 任何人都不能发消息，包括创建者）\n        subscribers: subscribers, // 设// 订阅者集合\n    }).post().getBody();\n\n    log.info(\"加入频道返回responseEntity\" + responseEntity)\n\n\n\n    if (responseEntity.status == 200) {\n        log.info(\"创建频道成功\")\n    } else {\n        log.info(\"创建频道失败\")\n        exit 400, \"创建频道失败\";\n    }\n\n    //插入dialog表\n    dialog = db.table(\"web_socket_dialogs\").insert({\n        name: name,\n        type:\"group\",\n        group_type:\"project\",\n        channel_id: channelId,  \n    })\n    \n    //创建项目  \n    projectId = db.table(\'projects\').insert({\n        name: name,\n        desc: desc,\n        userid: userid,\n        dialog_id: channelId,  //这里改成了频道id，web_socket_dialogs 这是记录相应的信息\n    })\n    log.info(\"创建项目返回-->\" + projectId)\n\n\n    //插入项目用户表 \n    var projectuser = db.table(\'project_users\').insert({\n        project_id: projectId,\n        userid: userid,\n        owner: userid\n    })\n    //插入项目列表，遍历插入\n    for (index, item in insertColumns) {\n        var project_columns = db.table(\'project_columns\').insert({\n            name: item.name,\n            sort: item.sort,\n            project_id: projectId\n        })\n    }\n    //创建工作流\n    if (flow == \'open\') {\n        //默认的工作流配置\n        var flows = [{\n            \"id\": -10,\n            \"name\": \"待处理\",\n            \"status\": \"start\",\n            \"turns\": [-10, -11, -12, -13, -14],\n            \"userids\": \"[]\",\n            \"usertype\": \"add\",\n            \"userlimit\": 0,\n            \"columnid\": 0\n        }, {\n            \"id\": -11,\n            \"name\": \"进行中\",\n            \"status\": \"progress\",\n            \"turns\": [-10, -11, -12, -13, -14],\n            \"userids\": \"[]\",\n            \"usertype\": \"add\",\n            \"userlimit\": 0,\n            \"columnid\": 0\n        }, {\n            \"id\": -12,\n            \"name\": \"待测试\",\n            \"status\": \"test\",\n            \"turns\": [-10, -11, -12, -13, -14],\n            \"userids\": \"[]\",\n            \"usertype\": \"add\",\n            \"userlimit\": 0,\n            \"columnid\": 0\n        }, {\n            \"id\": -13,\n            \"name\": \"已完成\",\n            \"status\": \"end\",\n            \"turns\": [-10, -11, -12, -13, -14],\n            \"userids\": \"[]\",\n            \"usertype\": \"add\",\n            \"userlimit\": 0,\n            \"columnid\": 0\n        }, {\n            \"id\": -14,\n            \"name\": \"已取消\",\n            \"status\": \"end\",\n            \"turns\": [-10, -11, -12, -13, -14],\n            \"userids\": \"[]\",\n            \"usertype\": \"add\",\n            \"userlimit\": 0,\n            \"columnid\": 0\n        }]\n        //执行流程创建\n        log.info(\"执行流程创建。。。\")\n        var projectFlowList =  addFlow(flows,projectId)\n         log.info(\"执行流程创建结束。。。\")\n    }\n});\n\n//查找project\nproject = db.table(\"projects\").where().eq(\"id\", projectId).selectOne()\n\n//创建项目日志\nvar logDetail = \'创建项目\'\nvar project_log = db.table(\'project_logs\').insert({\n    project_id: projectId,\n    column_id: 0,\n    task_id: 0,\n    userid: userid,\n    detail: logDetail\n})\n//TODO 推送创建项目信息，后面再做\nreturn project');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/移交项目-待测试.ms', '{\n  \"properties\" : { },\n  \"id\" : \"f193bc0459c943aeb83c5debc6ff5ff2\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"移交项目-待测试\",\n  \"createTime\" : 1720519096184,\n  \"updateTime\" : 1713325088328,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/transfer\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"9\",\n    \"description\" : \"项目ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"owner_userid\",\n    \"value\" : \"2\",\n    \"description\" : \"新的项目负责人ID\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"1084b6f5-ce65-4d93-b2f4-6e9d7ac409af\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : null,\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport \'@/project/use\' as use\nimport \'@/project/log\' as log\nvar useProject = use()\nresult = db.table(\"users\").where().eq(\"id\", owner_userid).selectOne()\nif (result == null) {\n    exit 400, \'成员不存在\'\n}\nvar val = db.transaction(() => {\n    //变更用户\n    db.table(\"project_users\").primary(\"project_id\").primary(\"userid\").update({\n        project_id: project_id,\n        userid: userid,\n        owner: 0\n    })\n\n    db.table(\"project_users\").primary(\"project_id\").primary(\"userid\").update({\n        project_id: project_id,\n        userid: userid,\n        owner: 1\n    })\n    //TODO 更新聊天室\n\n    var result = log(\'移交项目给[\' + owner_userid + \']\')\n});\n\n\n//TODO 推送消息\n\nvar data = {}\ndata.id = useProject.id\n\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/置顶项目.ms', '{\n  \"properties\" : { },\n  \"id\" : \"a9facac8de6d4084bc3cadfa290fe94b\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"置顶项目\",\n  \"createTime\" : 1720519096193,\n  \"updateTime\" : 1712799457103,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/top\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"93\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"a627f152-6545-4d6d-be87-8abe177aecff\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 109,\\n        \\\"top_at\\\": \\\"2024-04-10 11:12:34\\\"\\n    },\\n    \\\"timestamp\\\": 1712718754600,\\n    \\\"executeTime\\\": 11\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"id\",\n        \"value\" : \"109\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"top_at\",\n        \"value\" : \"1712718573694\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Long\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1712718573704\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"13\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport log\nimport \'cn.hutool.core.date.DateUtil\';\n\nimport \'cn.dev33.satoken.stp.StpUtil\';\nif (!StpUtil.isLogin()) {\n    exit - 1, \'请登录后继续\';\n}\n\nvar userid = StpUtil.getLoginId()\nprojectUser = db.table(\"project_users\").where().eq(\"userid\", userid).eq(\"project_id\", project_id).selectOne()\nif (projectUser == null) {\n    exit 400, \"项目不存在\";\n}\ntopTime = now()\nif (projectUser.top_at) {\n    topTime = null\n}\nlog.info(\"topTime ->\" + topTime)\n\nresult = db.update(\"\"\"\n        UPDATE project_users SET top_at = #{topTime} WHERE userid = #{userid} AND project_id = #{project_id}\n        \"\"\")\nlog.info(\"更新用户表+result\" + result)\n\n\n\n\nvar last_top_at = DateUtil.date(topTime)::string;\nlog.info(\"last_top_at-->\" + last_top_at)\n\nvar data = {\n    id: projectUser.id,\n    top_at: last_top_at\n}\nlog.info(\"data-->\" + data)\n\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/获取项目信息-OK.ms', '{\n  \"properties\" : { },\n  \"id\" : \"50a1ee98162142568ac06ce8f3394b57\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"获取项目信息-OK\",\n  \"createTime\" : 1720519096203,\n  \"updateTime\" : 1713325105143,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/one\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"project_id\",\n    \"value\" : \"9\",\n    \"description\" : \"项目id\",\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : \"\",\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"2b1c974f-bcaf-4fec-b311-364d9bb9848e\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"id\\\": 9,\\n        \\\"name\\\": \\\"修改的名称2\\\",\\n        \\\"desc\\\": \\\"测试\\\",\\n        \\\"userid\\\": 1,\\n        \\\"personal\\\": false,\\n        \\\"user_simple\\\": \\\"\\\",\\n        \\\"dialog_id\\\": 22,\\n        \\\"archived_at\\\": null,\\n        \\\"archived_userid\\\": 0,\\n        \\\"created_at\\\": \\\"2024-01-12 09:43:18\\\",\\n        \\\"updated_at\\\": \\\"2024-01-12 11:00:50\\\",\\n        \\\"deleted_at\\\": null,\\n        \\\"project_user\\\": [\\n            {\\n                \\\"id\\\": 13,\\n                \\\"project_id\\\": 9,\\n                \\\"userid\\\": 1,\\n                \\\"owner\\\": 1,\\n                \\\"top_at\\\": null,\\n                \\\"created_at\\\": \\\"2024-01-12 09:43:18\\\",\\n                \\\"updated_at\\\": \\\"2024-01-12 09:43:18\\\"\\n            }\\n        ],\\n        \\\"task_num\\\": 5,\\n        \\\"task_complete\\\": 0,\\n        \\\"task_percent\\\": 0,\\n        \\\"task_my_num\\\": 5,\\n        \\\"task_my_complete\\\": 0,\\n        \\\"task_my_percent\\\": 0,\\n        \\\"owner\\\": 1,\\n        \\\"owner_userid\\\": 1\\n    },\\n    \\\"timestamp\\\": 1706362803485,\\n    \\\"executeTime\\\": 61\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"500\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"系统内部出现错误\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"null\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1705161979207\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"64\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\n//TODO判断当前用户有没有权限\nimport log\nimport \'cn.dev33.satoken.stp.StpUtil\';\n//添加统计信息\nvar project = db.table(\"projects\").where().eq(\"id\", project_id).selectOne()\nlog.info(\"project is.  \" + project)\nvar userid = StpUtil.getLoginId()\nvar AllUser = db.table(\"project_users\").select()\nlog.info(\"AllUser value\", AllUser)\n//查找项目用户信息\nvar projectuser = db.table(\"project_users\").where().eq(\"project_id\", project_id).select()\n//添加用户信息\nproject.project_user = projectuser\n//统计信息\n//任务总数\nvar taskBaseSelect = db.table(\"project_tasks\").where().eq(\"project_id\", project_id).isNull(\"archived_at\")\nvar taskNum = taskBaseSelect.select()\nproject.task_num = taskNum.size()\n\n//任务完成数\nvar taskComplete = db.table(\"project_tasks\").where().eq(\"project_id\", project_id).isNotNull(\"complete_at\").isNull(\"archived_at\").select()\nproject.task_complete = taskComplete.size()\n//任务完成百分比\nproject.task_percent = project.task_num != 0 ? (project.task_complete / project.task_num * 100)::int : 0\n\n//自己的任务数量\nvar projectTasks = db.select(\"\"\"\n    SELECT\n        project_tasks.*,\n        project_task_users.owner,\n        1 AS assist\n    FROM\n        project_tasks\n    left JOIN\n        project_task_users ON project_tasks.id = project_task_users.task_id\n    WHERE\n        project_task_users.userid = #{userid}\n    AND\n        project_task_users.owner = 1 \n    AND\n        project_task_users.project_id = #{project_id}     \n\"\"\")\n\nlog.info(\"projectTasks len\" + projectTasks.size())\n\nproject.task_my_num = projectTasks.size()\n\n\n//已完成的任务数\nvar projectCompleteTasks = db.select(\"\"\"\n    SELECT\n        project_tasks.*,\n        project_task_users.owner,\n        1 AS assist\n    FROM\n        project_tasks\n    left JOIN\n        project_task_users ON project_tasks.id = project_task_users.task_id\n    WHERE\n        project_task_users.userid = #{userid}\n    AND\n        project_task_users.owner = 1 \n    AND\n        project_task_users.project_id = #{project_id}   \n    AND\n        project_tasks.complete_at IS NOT NULL\n\"\"\")\n\nproject.task_my_complete = projectCompleteTasks.size()\n\n//任务完成百分比\nproject.task_my_percent = project.task_my_num != 0 ? (project.task_my_complete / project.task_my_num * 100)::int : 0\n\n//判断当前的用户id和项目负责的id 是否\nif (project.userid == userid) {\n    project.owner = 1\n}\n\nproject.owner_userid = project.userid\n//获取频道id\n\n// int taskPercent = taskNum != 0 ? (int) ((taskComplete / (float) taskNum) * 100) : 0;\nreturn project');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/项目列表-ok.ms', '{\n  \"properties\" : { },\n  \"id\" : \"e435b811dd074e89b5ae2c22d83b558c\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"项目列表-ok\",\n  \"createTime\" : null,\n  \"updateTime\" : 1720545650477,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/lists\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"all\",\n    \"value\" : null,\n    \"description\" : \"是否查看所有项目（限制管理员）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : null,\n    \"description\" : \"项目类型 all：全部（默认）team：团队项目 personal：个人项目\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"all\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"archived\",\n    \"value\" : null,\n    \"description\" : \"归档状态 all：全部 no：未归档（默认）yes：已归档\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"getcolumn\",\n    \"value\" : null,\n    \"description\" : \"同时取列表 no：不取（默认）yes：取列表\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"getuserid\",\n    \"value\" : null,\n    \"description\" : \"同时取成员ID no：不取（默认）yes：取列表\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"no\",\n    \"validateType\" : null,\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : null\n  }, {\n    \"name\" : \"getstatistics\",\n    \"value\" : null,\n    \"description\" : \"同时取任务统计 no：不取 yes：取统计（默认）\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : \"yes\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"keys\",\n    \"value\" : null,\n    \"description\" : \"keys.name: 项目名称\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"timerange\",\n    \"value\" : null,\n    \"description\" : \"时间范围，时间戳格式\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"page\",\n    \"value\" : null,\n    \"description\" : \"当前页，默认:1\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : \"1\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"pagesize\",\n    \"value\" : null,\n    \"description\" : \"每页显示数量，默认:50，最大:100\",\n    \"required\" : false,\n    \"dataType\" : \"Integer\",\n    \"type\" : null,\n    \"defaultValue\" : \"50\",\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"52fbbf24-17c6-4825-96a3-8cd04a437dc1\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"data\\\": [\\n            {\\n                \\\"id\\\": 89,\\n                \\\"name\\\": \\\"23424\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"userid\\\": 6,\\n                \\\"personal\\\": false,\\n                \\\"user_simple\\\": \\\"\\\",\\n                \\\"dialog_id\\\": \\\"59e8e671d2144f61a69b6f7a3940011d\\\",\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"channel_id\\\": null,\\n                \\\"owner\\\": 6,\\n                \\\"userid_list\\\": [\\n                    6,\\n                    6\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 91,\\n                \\\"name\\\": \\\"测1\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"userid\\\": 6,\\n                \\\"personal\\\": false,\\n                \\\"user_simple\\\": \\\"\\\",\\n                \\\"dialog_id\\\": \\\"3a3b1b55a82d4a12bac6b4b6553fbd15\\\",\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"channel_id\\\": null,\\n                \\\"owner\\\": 6,\\n                \\\"userid_list\\\": [\\n                    6\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 92,\\n                \\\"name\\\": \\\"12313\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"userid\\\": 6,\\n                \\\"personal\\\": false,\\n                \\\"user_simple\\\": \\\"\\\",\\n                \\\"dialog_id\\\": \\\"926af67729c743be922758c568f02375\\\",\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"channel_id\\\": null,\\n                \\\"owner\\\": 6,\\n                \\\"userid_list\\\": [\\n                    6\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 94,\\n                \\\"name\\\": \\\"测试\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"userid\\\": 6,\\n                \\\"personal\\\": false,\\n                \\\"user_simple\\\": \\\"\\\",\\n                \\\"dialog_id\\\": \\\"b529e7fed1a7430fac86475dc95186de\\\",\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"channel_id\\\": null,\\n                \\\"owner\\\": 6,\\n                \\\"userid_list\\\": [\\n                    6\\n                ]\\n            },\\n            {\\n                \\\"id\\\": 96,\\n                \\\"name\\\": \\\"项目测试1\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"userid\\\": 6,\\n                \\\"personal\\\": false,\\n                \\\"user_simple\\\": \\\"\\\",\\n                \\\"dialog_id\\\": \\\"87ec61f3449c4b898591976a50613233\\\",\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"channel_id\\\": null,\\n                \\\"owner\\\": 6,\\n                \\\"userid_list\\\": [\\n                    6,\\n                    6\\n                ]\\n            }\\n        ],\\n        \\\"total_all\\\": 5\\n    },\\n    \\\"timestamp\\\": 1712598094001,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"data\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Array\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ {\n            \"name\" : \"id\",\n            \"value\" : \"9\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"name\",\n            \"value\" : \"修改的名称2\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"desc\",\n            \"value\" : \"测试\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"userid\",\n            \"value\" : \"1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"personal\",\n            \"value\" : \"false\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Boolean\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"user_simple\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"dialog_id\",\n            \"value\" : \"22\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_userid\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"created_at\",\n            \"value\" : \"1705023798000\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Long\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"updated_at\",\n            \"value\" : \"1705028450000\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Long\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"deleted_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"owner\",\n            \"value\" : \"1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"userid_list\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Array\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          } ]\n        } ]\n      }, {\n        \"name\" : \"total_all\",\n        \"value\" : \"1\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1708015019611\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"46\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\n//拦截用户部分没处理\nimport log\nimport \'cn.dev33.satoken.stp.StpUtil\';\nvar userid = StpUtil.getLoginId()\n// var userid = 6\nlog.info(\"userid is->\" + userid)\n//各种判断还有统计\nlog.info(\"archived is->\" + archived)\n\n//查找是自己负责或者自己创建的项目   TODO  owner怎么填\n\nvar projects = db.select(\"\"\"\n    SELECT\n        p.*,\n        pu.owner\n    FROM\n        project_users pu \n    JOIN\n        projects p  ON p.id = pu.project_id\n    WHERE\n        pu.userid = #{userid} \n    AND \n        p.deleted_at IS  NULL\n\"\"\")\n\n//处理用户列表\nif (getuserid != null) {\n     log.info(getuserid)\n    //遍历项目列表，增加userid_list列，罗列用户列表\n    for (item in projects) {\n        //获取用户成员\n        userListQuery = db.table(\"project_users\").where().eq(\"project_id\", item.id).select()\n        let useridList = []\n        for (item in userListQuery) {\n            useridList.push(userListQuery.userid)\n        }\n        // log.info(\"useridList .size:::::+\"+useridList.size())\n        item.owner = item.userid\n        item.userid_list = useridList\n    }\n}\n\nvar data = {\n    data,\n    total_all\n}\n\ndata.data = projects\ndata.total_all = projects.size()\nreturn data');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/API/项目/首页数据.ms', '{\n  \"properties\" : { },\n  \"id\" : \"d68a5f37401143fabf5f4e19ba9378af\",\n  \"script\" : null,\n  \"groupId\" : \"0c2d9f4051a44b37a9a0f361f4e13b75\",\n  \"name\" : \"首页数据\",\n  \"createTime\" : 1720519096241,\n  \"updateTime\" : 1713325098255,\n  \"lock\" : \"1\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/dash\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ {\n    \"name\" : \"token\",\n    \"value\" : \"636903cb-abcb-4e1e-beda-76e3c6bdc230\",\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": {\\n        \\\"myTaskSize\\\": 9,\\n        \\\"pendingTaskSize\\\": 5,\\n        \\\"weekCompleteTaskSize\\\": 0,\\n        \\\"weekShouleCompleteTaskSize\\\": 5,\\n        \\\"overdueTask\\\": [\\n            {\\n                \\\"id\\\": 124,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 89,\\n                \\\"column_id\\\": 123,\\n                \\\"dialog_id\\\": \\\"d675a42e0abe47a1827d4b0273ad1db8\\\",\\n                \\\"flow_item_id\\\": 261,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"测试任务1\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712106000000,\\n                \\\"end_at\\\": 1712224800000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 125,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 92,\\n                \\\"column_id\\\": 126,\\n                \\\"dialog_id\\\": \\\"0bf1b478b30d419db3924e72c0e70099\\\",\\n                \\\"flow_item_id\\\": 276,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"121231\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712129932000,\\n                \\\"end_at\\\": 1712216332000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 126,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 91,\\n                \\\"column_id\\\": 125,\\n                \\\"dialog_id\\\": \\\"4e15a6a9e94140d99b40469e02516aff\\\",\\n                \\\"flow_item_id\\\": 271,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"123\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"1233\\\",\\n                \\\"start_at\\\": 1712252105000,\\n                \\\"end_at\\\": 1712338505000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 135,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 94,\\n                \\\"column_id\\\": 133,\\n                \\\"dialog_id\\\": \\\"c64dcbbc05d8436e83950a58002a57bd\\\",\\n                \\\"flow_item_id\\\": 286,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"12313\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712566514000,\\n                \\\"end_at\\\": 1712652914000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 137,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 96,\\n                \\\"column_id\\\": 137,\\n                \\\"dialog_id\\\": \\\"743adb371d674a66838c8b307cab0a99\\\",\\n                \\\"flow_item_id\\\": 0,\\n                \\\"flow_item_name\\\": \\\"\\\",\\n                \\\"name\\\": \\\"应用开发\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712579930000,\\n                \\\"end_at\\\": 1712666330000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 138,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 96,\\n                \\\"column_id\\\": 136,\\n                \\\"dialog_id\\\": \\\"c63e555076544e2ea6bf7e0f37cf9805\\\",\\n                \\\"flow_item_id\\\": 0,\\n                \\\"flow_item_name\\\": \\\"\\\",\\n                \\\"name\\\": \\\"开发2\\\",\\n                \\\"color\\\": \\\"#ffeaee\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712580000000,\\n                \\\"end_at\\\": 1712666400000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 192,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 104,\\n                \\\"column_id\\\": 146,\\n                \\\"dialog_id\\\": \\\"26dbe3265a1a416bab384f0c23c3edab\\\",\\n                \\\"flow_item_id\\\": 331,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"123123123\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712673678000,\\n                \\\"end_at\\\": 1712760078000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 139,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 96,\\n                \\\"column_id\\\": 136,\\n                \\\"dialog_id\\\": \\\"be9202f29d3443a3b4d33ee5adaedace\\\",\\n                \\\"flow_item_id\\\": 0,\\n                \\\"flow_item_name\\\": \\\"\\\",\\n                \\\"name\\\": \\\"哈哈\\\",\\n                \\\"color\\\": \\\"#e5f5ff\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712581210000,\\n                \\\"end_at\\\": 1712667610000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 3,\\n                \\\"p_name\\\": \\\"紧急不重要\\\",\\n                \\\"p_color\\\": \\\"#4B70F3\\\",\\n                \\\"sort\\\": 1,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            }\\n        ],\\n        \\\"runingTask\\\": [\\n            {\\n                \\\"id\\\": 124,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 89,\\n                \\\"column_id\\\": 123,\\n                \\\"dialog_id\\\": \\\"d675a42e0abe47a1827d4b0273ad1db8\\\",\\n                \\\"flow_item_id\\\": 261,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"测试任务1\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712106000000,\\n                \\\"end_at\\\": 1712224800000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 125,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 92,\\n                \\\"column_id\\\": 126,\\n                \\\"dialog_id\\\": \\\"0bf1b478b30d419db3924e72c0e70099\\\",\\n                \\\"flow_item_id\\\": 276,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"121231\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712129932000,\\n                \\\"end_at\\\": 1712216332000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 126,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 91,\\n                \\\"column_id\\\": 125,\\n                \\\"dialog_id\\\": \\\"4e15a6a9e94140d99b40469e02516aff\\\",\\n                \\\"flow_item_id\\\": 271,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"123\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"1233\\\",\\n                \\\"start_at\\\": 1712252105000,\\n                \\\"end_at\\\": 1712338505000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 135,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 94,\\n                \\\"column_id\\\": 133,\\n                \\\"dialog_id\\\": \\\"c64dcbbc05d8436e83950a58002a57bd\\\",\\n                \\\"flow_item_id\\\": 286,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"12313\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712566514000,\\n                \\\"end_at\\\": 1712652914000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 137,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 96,\\n                \\\"column_id\\\": 137,\\n                \\\"dialog_id\\\": \\\"743adb371d674a66838c8b307cab0a99\\\",\\n                \\\"flow_item_id\\\": 0,\\n                \\\"flow_item_name\\\": \\\"\\\",\\n                \\\"name\\\": \\\"应用开发\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712579930000,\\n                \\\"end_at\\\": 1712666330000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 138,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 96,\\n                \\\"column_id\\\": 136,\\n                \\\"dialog_id\\\": \\\"c63e555076544e2ea6bf7e0f37cf9805\\\",\\n                \\\"flow_item_id\\\": 0,\\n                \\\"flow_item_name\\\": \\\"\\\",\\n                \\\"name\\\": \\\"开发2\\\",\\n                \\\"color\\\": \\\"#ffeaee\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712580000000,\\n                \\\"end_at\\\": 1712666400000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 192,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 104,\\n                \\\"column_id\\\": 146,\\n                \\\"dialog_id\\\": \\\"26dbe3265a1a416bab384f0c23c3edab\\\",\\n                \\\"flow_item_id\\\": 331,\\n                \\\"flow_item_name\\\": \\\"start|待处理\\\",\\n                \\\"name\\\": \\\"123123123\\\",\\n                \\\"color\\\": \\\"\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712673678000,\\n                \\\"end_at\\\": 1712760078000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 1,\\n                \\\"p_name\\\": \\\"重要且紧急\\\",\\n                \\\"p_color\\\": \\\"#ED4014\\\",\\n                \\\"sort\\\": 0,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            },\\n            {\\n                \\\"id\\\": 139,\\n                \\\"parent_id\\\": 0,\\n                \\\"project_id\\\": 96,\\n                \\\"column_id\\\": 136,\\n                \\\"dialog_id\\\": \\\"be9202f29d3443a3b4d33ee5adaedace\\\",\\n                \\\"flow_item_id\\\": 0,\\n                \\\"flow_item_name\\\": \\\"\\\",\\n                \\\"name\\\": \\\"哈哈\\\",\\n                \\\"color\\\": \\\"#e5f5ff\\\",\\n                \\\"desc\\\": \\\"\\\",\\n                \\\"start_at\\\": 1712581210000,\\n                \\\"end_at\\\": 1712667610000,\\n                \\\"archived_at\\\": null,\\n                \\\"archived_userid\\\": 0,\\n                \\\"archived_follow\\\": 0,\\n                \\\"complete_at\\\": null,\\n                \\\"userid\\\": 6,\\n                \\\"visibility\\\": 1,\\n                \\\"p_level\\\": 3,\\n                \\\"p_name\\\": \\\"紧急不重要\\\",\\n                \\\"p_color\\\": \\\"#4B70F3\\\",\\n                \\\"sort\\\": 1,\\n                \\\"loop\\\": \\\"\\\",\\n                \\\"loop_at\\\": null,\\n                \\\"created_at\\\": null,\\n                \\\"updated_at\\\": null,\\n                \\\"deleted_at\\\": null,\\n                \\\"deleted_userid\\\": 0\\n            }\\n        ]\\n    },\\n    \\\"timestamp\\\": 1712939055731,\\n    \\\"executeTime\\\": 7\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Object\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ {\n        \"name\" : \"myTaskSize\",\n        \"value\" : \"9\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"pendingTaskSize\",\n        \"value\" : \"5\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"weekCompleteTaskSize\",\n        \"value\" : \"0\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"weekShouleCompleteTaskSize\",\n        \"value\" : \"5\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Integer\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ ]\n      }, {\n        \"name\" : \"overdueTask\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Array\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ {\n            \"name\" : \"id\",\n            \"value\" : \"124\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"parent_id\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"project_id\",\n            \"value\" : \"89\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"column_id\",\n            \"value\" : \"123\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"dialog_id\",\n            \"value\" : \"d675a42e0abe47a1827d4b0273ad1db8\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"flow_item_id\",\n            \"value\" : \"261\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"flow_item_name\",\n            \"value\" : \"start|待处理\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"name\",\n            \"value\" : \"测试任务1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"color\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"desc\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"start_at\",\n            \"value\" : \"1712106000000\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Long\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"end_at\",\n            \"value\" : \"1712224800000\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Long\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_userid\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_follow\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"complete_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"userid\",\n            \"value\" : \"6\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"visibility\",\n            \"value\" : \"1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"p_level\",\n            \"value\" : \"1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"p_name\",\n            \"value\" : \"重要且紧急\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"p_color\",\n            \"value\" : \"#ED4014\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"sort\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"loop\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"loop_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"created_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"updated_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"deleted_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"deleted_userid\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          } ]\n        } ]\n      }, {\n        \"name\" : \"runingTask\",\n        \"value\" : \"\",\n        \"description\" : \"\",\n        \"required\" : false,\n        \"dataType\" : \"Array\",\n        \"type\" : null,\n        \"defaultValue\" : null,\n        \"validateType\" : \"\",\n        \"error\" : \"\",\n        \"expression\" : \"\",\n        \"children\" : [ {\n          \"name\" : \"\",\n          \"value\" : \"\",\n          \"description\" : \"\",\n          \"required\" : false,\n          \"dataType\" : \"Object\",\n          \"type\" : null,\n          \"defaultValue\" : null,\n          \"validateType\" : \"\",\n          \"error\" : \"\",\n          \"expression\" : \"\",\n          \"children\" : [ {\n            \"name\" : \"id\",\n            \"value\" : \"124\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"parent_id\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"project_id\",\n            \"value\" : \"89\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"column_id\",\n            \"value\" : \"123\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"dialog_id\",\n            \"value\" : \"d675a42e0abe47a1827d4b0273ad1db8\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"flow_item_id\",\n            \"value\" : \"261\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"flow_item_name\",\n            \"value\" : \"start|待处理\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"name\",\n            \"value\" : \"测试任务1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"color\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"desc\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"start_at\",\n            \"value\" : \"1712106000000\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Long\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"end_at\",\n            \"value\" : \"1712224800000\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Long\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_userid\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"archived_follow\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"complete_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"userid\",\n            \"value\" : \"6\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"visibility\",\n            \"value\" : \"1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"p_level\",\n            \"value\" : \"1\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"p_name\",\n            \"value\" : \"重要且紧急\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"p_color\",\n            \"value\" : \"#ED4014\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"sort\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"loop\",\n            \"value\" : \"\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"String\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"loop_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"created_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"updated_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"deleted_at\",\n            \"value\" : \"null\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Object\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          }, {\n            \"name\" : \"deleted_userid\",\n            \"value\" : \"0\",\n            \"description\" : \"\",\n            \"required\" : false,\n            \"dataType\" : \"Integer\",\n            \"type\" : null,\n            \"defaultValue\" : null,\n            \"validateType\" : \"\",\n            \"error\" : \"\",\n            \"expression\" : \"\",\n            \"children\" : [ ]\n          } ]\n        } ]\n      } ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1712939055731\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"7\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport \'cn.hutool.core.date.DateUtil\';\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\nvar userid = StpUtil.getLoginId()\n\n//自己的项目列表\nlet projectList = []\n\nvar projects = db.select(\"\"\"\n        SELECT\n            p.id\n        FROM\n            project_users pu \n        JOIN\n            projects p  ON p.id = pu.project_id\n        WHERE\n            pu.userid = #{userid} \n        AND \n            p.deleted_at IS NULL\n    \"\"\")\nif (projects.size() > 0) {\n    projectList = []\n    for (item in projects) {\n        log.info(\"projects-->\", item)\n        projectList.push(item.id)\n    }\n    log.info(\"projectList-->\" + projectList)\n} else {\n    log.info(\"projectList size 0 -->\")\n    //直接返回没数据了\n    // return []\n}\n\n//只查询和自己有关的任务\nlet taskList = []\nvar tasks = db.select(\"\"\"\n        SELECT\n            p.id\n        FROM\n            project_task_users pu \n        JOIN\n            project_tasks p  ON p.id = pu.task_id\n        WHERE\n            pu.userid = #{userid} \n        AND \n            p.deleted_at IS NULL\n    \"\"\")\n\nif (tasks.size() > 0) {\n    for (item in tasks) {\n        taskList.push(item.id)\n    }\n    log.info(\"task_id taskList-->\" + taskList)\n} else {\n    log.info(\"task_id taskList-->size 0\")\n}\n\n\n//我的任务，不包含已归档的\nvar myTaskSize = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\').isNull(\"archived_at\").in(\"project_id\", projectList).in(\"id\",taskList).count();\nlog.info(\"mytaskSize value->\" + myTaskSize) //考虑加分页\n\n//待处理\nvar pendingTask = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\').in(\"id\",taskList).in(\"project_id\", projectList).like(\"flow_item_name\", \"%待处理%\").select();\nlog.info(\"pendingTask value->\" + pendingTask)\nvar pendingTaskSize = pendingTask.size()\nlog.info(\"pendingTaskSize value->\" + pendingTaskSize)\n\n// 计算本周开始和结束的时间\nweekBeginDate = DateUtil.beginOfWeek(now())\nlog.info(\"weekBeginDate value->\" + weekBeginDate)\nweekEndDate = DateUtil.endOfWeek(now());\nlog.info(\"weekEndDate value->\" + weekEndDate)\n\n//本周已完成\nvar weekCompleteTaskSize = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\').gte(\"complete_at\", weekBeginDate).lte(\"complete_at\", weekEndDate).in(\"id\",taskList).in(\"project_id\", projectList).count();\nlog.info(\"weekCompleteTaskSize value->\" + weekCompleteTaskSize)\n\n//本周应完成\nvar weekShouleCompleteTaskSize = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\').isNull(\"complete_at\").gte(\"end_at\", weekBeginDate).lte(\"end_at\", weekEndDate).in(\"id\",taskList).in(\"project_id\", projectList).count();\nlog.info(\"weekShouleCompleteTaskSize value->\" + weekShouleCompleteTaskSize)\n\n//超期任务 TODO \nvar overdueTask = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\').isNull(\"complete_at\").lte(\"end_at\", now()).in(\"project_id\", projectList).in(\"id\",taskList).select()\nlog.info(\"overdueTask value->\" + overdueTask)\n\n//进行中任务\nvar runingTask = db.table(\"project_tasks\").where().orderBy(\'sort\').orderBy(\'id\').isNull(\"complete_at\").in(\"project_id\", projectList).in(\"id\",taskList).gte(\"end_at\", now()).select()\nlog.info(\"runingTask value->\" + runingTask)\n\nvar data = {\n    myTaskSize: myTaskSize,\n    pendingTaskSize: pendingTaskSize,\n    weekCompleteTaskSize: weekCompleteTaskSize,\n    weekShouleCompleteTaskSize: weekShouleCompleteTaskSize,\n    overdueTask: overdueTask,\n    runingTask: runingTask,\n}\nreturn data\n\n\n\n\n\n\n//任务状态分布图 前端直接处理应该都可以\n\n//已超期任务\n\n\n\n//进行中任务\n//活动图');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/文件/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/文件/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"22e24c6facd143a49cf7e7cf201c727d\",\n  \"name\" : \"文件\",\n  \"type\" : \"api\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/file\",\n  \"createTime\" : 1720519095464,\n  \"updateTime\" : 1702111391739,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/文件/文件列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"333019c5837f4026ae772985341aafeb\",\n  \"script\" : null,\n  \"groupId\" : \"22e24c6facd143a49cf7e7cf201c727d\",\n  \"name\" : \"文件列表\",\n  \"createTime\" : 1720519096529,\n  \"updateTime\" : 1713257192464,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/lists\",\n  \"method\" : \"POST\",\n  \"parameters\" : [ ],\n  \"options\" : [ ],\n  \"requestBody\" : \"{\\n    \\\"pid\\\":13\\n}\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 500,\\n    \\\"message\\\": \\\"系统内部出现错误\\\",\\n    \\\"data\\\": null,\\n    \\\"timestamp\\\": 1710505183537,\\n    \\\"executeTime\\\": 5\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : {\n    \"name\" : \"root\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"pid\",\n      \"value\" : \"12\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  },\n  \"responseBodyDefinition\" : {\n    \"name\" : \"\",\n    \"value\" : \"\",\n    \"description\" : \"\",\n    \"required\" : false,\n    \"dataType\" : \"Object\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : \"\",\n    \"error\" : \"\",\n    \"expression\" : \"\",\n    \"children\" : [ {\n      \"name\" : \"code\",\n      \"value\" : \"200\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"message\",\n      \"value\" : \"success\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"data\",\n      \"value\" : \"文件存在\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"String\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"timestamp\",\n      \"value\" : \"1702457283482\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Long\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    }, {\n      \"name\" : \"executeTime\",\n      \"value\" : \"119\",\n      \"description\" : \"\",\n      \"required\" : false,\n      \"dataType\" : \"Integer\",\n      \"type\" : null,\n      \"defaultValue\" : null,\n      \"validateType\" : \"\",\n      \"error\" : \"\",\n      \"expression\" : \"\",\n      \"children\" : [ ]\n    } ]\n  }\n}\r\n================================\r\nimport org.junit.jupiter.params.provider.NullAndEmptySource\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log;\nvar userId = StpUtil.getLoginId()\n// var userId = \'1\'\n\n// 设置权限值，如果用户是文件的创建者或拥有者，则权限值为1000。\nvar permission = 1000\nvar etype = \"all\"\n\n// 如果类型为 \'dir\'，则只查询文件夹。\nif (type = \"dir\") {\n    etype = \"folder\"\n}\n\nif (body.pid > 0) {\n    // todo 如果$pid大于0，说明不是根目录，需要检查权限\n} else {\n    // 如果是根目录，只查询当前用户的文件\n    $builder -> whereUserid($user -> userid);\n}\n\nvar fileList\n\n// 需要查询该节点的所有子节点\nif (body.pid > 0) {\n    // 查询所有子节点\n    var file = db.select(\"\"\"\n          SELECT * FROM files WHERE pid = #{body.pid} \n     \"\"\")\n    log.info(\'file:\' + file);\n    if (file.getLength() == 0) { //判断文件是否存在\n        return \"文件不存在或已被删除\"\n    }\n    //判断权限\n    var limit = 0\n    if (file[0].userid == userId || file[0].createdId == userId) {\n        permission = 1000\n    } else {\n        //查找共享\n        if (file[0].share) {\n            log.info(\'共享文件夹-真，就返回这个文件或者目录\');\n            fileList = file[0] //TODO 这里需要处理\n        }\n        pid = file[0].pid\n        //遍历获取最顶级的 pid\n        while (pid > 0) {\n            var fileTemp = db.select(\"\"\"\n               SELECT * FROM files WHERE id = #{pid} \n          \"\"\")\n            if (fileTemp.getLength() == 0) { //判断文件是否存在\n                break\n            }\n            if (fileTemp[0].share) {\n                log.info(\'do this file:\' + fileTemp[0]);\n                //    return fileTemp[0]\n                fileList = file[0] //TODO 这里需要处理\n            }\n            pid = fileTemp[0].pid\n        }\n\n        //查找文件共享表\n        if (fileTemp.getLength() > 0) {\n            var fileUser = db.selectOne(\"\"\"\n                              SELECT * FROM file_users WHERE id = #{pid} and #{userId} in userid   order by desc      permission \"\"\")\n            if (fileUser.getLength() == 0) { //判断是否在指定共享成员内\n                permission = fileUser.permission\n                log.info(\'else permission:\' + permission);\n            }\n        }\n\n    }\n\n\n} else {\n    //获取用户自己的文件\n    var file = db.table(\"files\").where().eq(\"userid\", userId).isNull(\'deleted_at\').select()\n    return file\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/文件预览/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/文件预览/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"9263848cc4844cff9b94615a00ae91cf\",\n  \"name\" : \"文件预览\",\n  \"type\" : \"api\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/online\",\n  \"createTime\" : 1720519095473,\n  \"updateTime\" : 1716518789773,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/api/文件预览/文件预览.ms', '{\n  \"properties\" : { },\n  \"id\" : \"caa1bb876b0b4960845d96a090a61404\",\n  \"script\" : null,\n  \"groupId\" : \"9263848cc4844cff9b94615a00ae91cf\",\n  \"name\" : \"文件预览\",\n  \"createTime\" : 1720519096536,\n  \"updateTime\" : 1716520109292,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/preview/{id}\",\n  \"method\" : \"GET\",\n  \"parameters\" : [ {\n    \"name\" : \"key\",\n    \"value\" : \"\",\n    \"description\" : null,\n    \"required\" : true,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ],\n  \"options\" : [ ],\n  \"requestBody\" : \"\",\n  \"headers\" : [ ],\n  \"paths\" : [ ],\n  \"responseBody\" : \"{\\n    \\\"code\\\": 200,\\n    \\\"message\\\": \\\"success\\\",\\n    \\\"data\\\": \\\"hellow\\\",\\n    \\\"timestamp\\\": 1716518853081,\\n    \\\"executeTime\\\": 4\\n}\",\n  \"description\" : null,\n  \"requestBodyDefinition\" : null,\n  \"responseBodyDefinition\" : null\n}\r\n================================\r\nimport response;\r\n// 清理输入中的空白字符\r\nvar trimmedKey = key.trim();\r\n\r\nvar encodedUrl = \"/api/file/preview/\" + trimmedKey;\r\n\r\nreturn response.redirect(encodedUrl);');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/component/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/component/数据管理/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/component/数据管理/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"55ff62aa20144b7bb5c6dfb5d76c8139\",\n  \"name\" : \"数据管理\",\n  \"type\" : \"component\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/data\",\n  \"createTime\" : 1720519095484,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/component/数据管理/测试生成/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/component/数据管理/测试生成/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"eb5dbed949de4f50ba4bf59f483252a5\",\n  \"name\" : \"测试生成\",\n  \"type\" : \"component\",\n  \"parentId\" : \"55ff62aa20144b7bb5c6dfb5d76c8139\",\n  \"path\" : \"/test\",\n  \"createTime\" : 1720519095492,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/component/数据管理/测试生成/列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"b35e1c055131478d8ebabb7a64eb721d\",\n  \"script\" : null,\n  \"groupId\" : \"eb5dbed949de4f50ba4bf59f483252a5\",\n  \"name\" : \"列表\",\n  \"createTime\" : 1720519096542,\n  \"updateTime\" : 1709100179824,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/list\",\n  \"description\" : null\n}\r\n================================\r\n<template>\n    <mb-list ref=\"magicList\" v-bind=\"listOptions\" />\n    <mb-dialog ref=\"formDialog\" :title=\"magicFormTitle\" @confirm-click=\"magicForm.save($event)\" width=\"50%\">\n        <template #content>\n            <mb-form ref=\"magicForm\" @reload=\"magicList.reload\" v-bind=\"formOptions\" />\n        </template>\n    </mb-dialog>\n</template>\n<script setup>\n    import { ref, reactive, getCurrentInstance, nextTick } from \'vue\'\n    const { proxy } = getCurrentInstance()\n    const formDialog = ref()\n    const magicList = ref()\n    const magicForm = ref()\n    const magicFormTitle = ref()\n    const listOptions = reactive({\n        tools: [{\n            type: \'add\',\n            permission: \'data:test:save\',\n            click: () => {\n                magicFormTitle.value = \'添加\'\n                formDialog.value.show()\n            }\n        }],\n        table: {\n            url: \'/data/test/list\',\n            where: {\n                name: {\n                    label: \'名字\'\n                },\n                sex: {\n                    label: \'性别\'\n                },\n                headPortrait: {\n                    label: \'头像\'\n                },\n                remarks: {\n                    label: \'备注\'\n                }\n            },\n            cols: [\n                {\n                    field: \'name\',\n                    label: \'名字\'\n                },\n                {\n                    field: \'sex\',\n                    label: \'性别\',\n                    dictType: \'sex\'\n                },\n                {\n                    field: \'headPortrait\',\n                    label: \'头像\',\n                    type: \'image\'\n                },\n                {\n                    field: \'remarks\',\n                    label: \'备注\'\n                },{\n                    label: \'操作\',\n                    type: \'btns\',\n                    width: 140,\n                    fixed: \'right\',\n                    btns: [\n                        {\n                            permission: \'data:test:save\',\n                            label: \'修改\',\n                            type: \'primary\',\n                            link: true,\n                            icon: \'ElEdit\',\n                            click: (row) => {\n                                magicFormTitle.value = \'修改\'\n                                formDialog.value.show(() => magicForm.value.getDetail(row.id))\n                            }\n                        }, {\n                            permission: \'data:test:delete\',\n                            label: \'删除\',\n                            type: \'primary\',\n                            link: true,\n                            icon: \'ElDelete\',\n                            click: (row) => {\n                                proxy.$common.handleDelete({\n                                    url: \'/data/test/delete\',\n                                    id: row.id,\n                                    done: () => magicList.value.reload()\n                                })\n                            }\n                        }\n                    ]\n                }\n            ]\n        }\n    })\n\n    const formOptions = reactive({\n        detail: {\n            request: {\n              url: \'/data/test/get\'\n            }\n        },\n        form: {\n            request: {\n                url: \"/data/test/save\"\n            },\n            rows: [{\n                gutter: 24,\n                cols: [{\n                    span: 12,\n                    name: \'name\',\n                    label: \'名字\',\n                    component: \'input\',\n                    rules: [{ required: true, message: \'请输入名字\', trigger: \'change\' }]\n                },{\n                    span: 12,\n                    name: \'sex\',\n                    label: \'性别\',\n                    component: \'radio-group\',\n                    props: {\n                        type: \'sex\'\n                    }\n                },{\n                    span: 12,\n                    name: \'headPortrait\',\n                    label: \'头像\',\n                    component: \'upload-image\',\n                    rules: [{ required: true, message: \'请选择头像\', trigger: \'change\' }]\n                },{\n                    span: 12,\n                    name: \'remarks\',\n                    label: \'备注\',\n                    component: \'input\',\n                    props: {\n                        type: \'textarea\'\n                    }\n\n                }]\n            }]\n        }\n    })\n</script>\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/datasource/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/任务/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/任务/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"07213facdab54280b6ba7b4637732337\",\n  \"name\" : \"任务\",\n  \"type\" : \"function\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/task\",\n  \"createTime\" : 1720519095503,\n  \"updateTime\" : 1713024590379,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/任务/保存任务正文内容.ms', '{\n  \"properties\" : { },\n  \"id\" : \"50aa4204a27c40198e30d90a1dc96956\",\n  \"script\" : null,\n  \"groupId\" : \"07213facdab54280b6ba7b4637732337\",\n  \"name\" : \"保存任务正文内容\",\n  \"createTime\" : 1720519096550,\n  \"updateTime\" : 1717056324840,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/saveContent\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"content\",\n    \"value\" : null,\n    \"description\" : \"内容\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"type\",\n    \"value\" : null,\n    \"description\" : \"操作类型  add-添加 update 更新 \",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport log\nimport \'cn.hutool.http.HtmlUtil\';\nimport \'cn.hutool.core.util.ReUtil\';\nimport \'org.ssssssss.magicboot.utils.MinioUtil\';\nimport \'org.ssssssss.magicboot.utils.FileUtils\';\nimport cn.hutool.core.util.StrUtil;\nimport env\n\n\n\nlog.info(\"获取的content value is \" + content)\nlog.info(\"获取的type value is \" + type)\n//先处理\n\nlet textWithoutHtml = HtmlUtil.cleanHtmlTag(content);\nlog.info(textWithoutHtml)\n\n// path = \"uploads/task/content/\" + now() + \"/\" + taskId + \"/\"; //基础的地址，修改成按月份\nregex = \"<img\\\\s+src=\\\"data:image/(png|jpg|jpeg|webp);base64,(.*?)\\\"\";\n\nlet allList = []\nReUtil.findAll(regex, content, 0, allList) //全部\nfor (item in allList) {\n    log.info(\"allList -->\" + item)\n}\n\nlet group1List = []\nReUtil.findAll(regex, content, 1, group1List) //类型\nfor (item in group1List) {\n    log.info(\"group1List -->\" + item)\n}\n\nlet group2List = []\nReUtil.findAll(regex, content, 2, group2List) //base64\nlog.info(\"group2List size  -->\" + group2List.size())\n\nfor (index, item in group2List) {\n    log.info(\"group2List -->\" + item)\n    var url = MinioUtil.uploadBase64(item)\n    log.info(\"保存图片到minio中\" + url)\n    prewUrl = MinioUtil.preview(url)\n    log.info(\"图片真实地址:\" + prewUrl)\n\n    var domain = env.get(\"public.domain\").replace(\"http://\", \"\").replace(\"https://\", \"\")\n    log.info(\"domain-->\" + domain);\n\n    preview = StrUtil.replaceChars(prewUrl, \"task-minio\", domain) //TODO 这里需要特殊处理,这里是不靠谱的\n    log.info(\"处理后的图片真实地址:\" + prewUrl)\n\n\n    // let imgInfo = FileUtils.getImageSize(\'https://s2.51cto.com/blog/activity/bride/DetailsBride.gif?x-oss-process=image/ignore-error,1\')\n    var imgInfo = FileUtils.getImageSize(prewUrl)\n    //组装url\n    lastUrl = \'<img src=\"\' + prewUrl + \'\" original-width=\"\' + imgInfo[0] + \'\" original-height=\"\' + imgInfo[1] + \'\"\'\n    log.info(\"lastUrl-->\" + lastUrl)\n    content = content.replace(allList[index], lastUrl)\n}\n\n\n//这里不需要进行替换操作了，直接展示吧\n//TODO minio保存文件的方法\ntextUrl = MinioUtil.uploadTxt(content)\nlog.info(\"textUrl\" + textUrl)\n// resultUrl = MinioUtil.preview(textUrl) //TODO URL这里不处理了。直接按资源名，这样子才能取得\nresultUrl = textUrl\nlog.info(\"resultUrl Url\" + resultUrl)\n\n// var result = db.table(\'project_task_contents\').primary(\'project_id\').primary(\'task_id\').update({\n//     project_id: project_id,\n//     task_id: task_id,\n//     content: contentValue::json //  这里存json\n// })\n// log.info(\"insert ->result:\", result)\n\nreturn resultUrl\n\n//TODO 文件存储操作\n\n// $path = \'uploads/task/content/\' . date(\"Ym\") . \'/\' . $task_id . \'/\';\n//     //\n//     preg_match_all(\"/<img\\s+src=\\\"data:image\\/(png|jpg|jpeg|webp);base64,(.*?)\\\"/s\", $content, $matchs);\n//     foreach ($matchs[2] as $key => $text) {\n//         $tmpPath = $path . \'attached/\';\n//         Base::makeDir(public_path($tmpPath));\n//         $tmpPath .= md5($text) . \".\" . $matchs[1][$key];\n//         if (Base::saveContentImage(public_path($tmpPath), base64_decode($text))) {\n//             $paramet = getimagesize(public_path($tmpPath));\n//             $content = str_replace($matchs[0][$key], \'<img src=\"{{RemoteURL}}\' . $tmpPath . \'\" original-width=\"\' . $paramet[0] . \'\" original-height=\"\' . $paramet[1] . \'\"\', $content);\n//         }\n//     }\n//     $pattern = \'/<img(.*?)src=(\"|\\\')https*:\\/\\/(.*?)\\/(uploads\\/task\\/content\\/(.*?))\\2/is\';\n//     $content = preg_replace($pattern, \'<img$1src=$2{{RemoteURL}}$4$2\', $content);\n//     //\n//     $filePath = $path . md5($content);\n//     $publicPath = public_path($filePath);\n//     Base::makeDir(dirname($publicPath));\n//     file_put_contents($publicPath, $content);\n//     //\n//     return $filePath;\n\n// log.info(\'content ->\' + body.content);\n// log.info(\'contentValue ->\' + contentValue);\n// var result = db.table(\'project_task_contents\').insert({\n//     project_id: useTask.project_id,\n//     task_id: useTask.task_id,\n//     content: contentValue\n// })\n// log.info(\"插入详细描述\", result)\n// var logDetail = \'修改任务详细描述\'\n// var project_log = db.table(\'project_logs\').insert({\n//     project_id: useTask.project_id,\n//     column_id: 0,\n//     task_id: useTask.task_id,\n//     userid: userid,\n//     detail: logDetail\n// })\n// log.info(\"插入详细描述日志\", project_log)\n\n\n//TODO $updateMarking[\'is_update_content\'] = true;\n// //处理详情描述\n// var contentValue = {}\n\n// contentValue.url = \'\'\n// var contentId = db.table(\'project_task_contents\').primary(\'project_id\').primary(\'task_id\').update({\n//     project_id: project_id,\n//     task_id: task_id,\n//     content: contentValue::json //  这里存json\n// })\n\n\n// return \"调用保存内容正文正确\"');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/任务/归档或还原任务-未完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"05a6cfb2c0de4d2082834597ca8d86bd\",\n  \"script\" : null,\n  \"groupId\" : \"07213facdab54280b6ba7b4637732337\",\n  \"name\" : \"归档或还原任务-未完成\",\n  \"createTime\" : 1720519096558,\n  \"updateTime\" : 1713024595276,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/archivedTask\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"archived_at\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nvar userid = StpUtil.getLoginId()\nimport \'@/project/log\' as log\n//TODO 判断权限部分\n\n// primary(\"id\").primary\n\nvar val = db.transaction(() => {\n    if (archived_at == null) {\n        db.table(\"project_tasks\").where().eq(\"project_id\", project_id).eq(\"id\", task_id).update({\n            archived_at: null,\n            archived_follow: 0,\n        })\n        log(\'任务取消归档\')\n    } else {\n        //任务归档\n        db.table(\"project_tasks\").where().eq(\"project_id\", project_id).eq(\"id\", task_id).update({\n            archived_at: archived_at,\n            archived_follow: 1,\n        })\n        log(\'任务归档\')\n        //推送归档的通知\n    }\n    db.table(\"projects\").primary(\"id\").update({\n        id: project_id,\n        archived_at: archived_at,\n        archived_userid: userid\n    })\n\n});');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/任务/添加任务日志-未完成.ms', '{\n  \"properties\" : { },\n  \"id\" : \"7a537422c5e54c02a7dcd651f37028b2\",\n  \"script\" : null,\n  \"groupId\" : \"07213facdab54280b6ba7b4637732337\",\n  \"name\" : \"添加任务日志-未完成\",\n  \"createTime\" : 1720519096563,\n  \"updateTime\" : 1713024595362,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/log\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ ]\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\nvar userid = StpUtil.getLoginId()\nlog.info(\'userid is \' + userid)\n\nif (userid == null) {\n    log.info(\'userid is null\')\n    exit 400, \'用户未登录\'\n}\nlog.info(\'logDetail value：\' + logDetail)\n\nvar result = db.table(\'project_logs\').insert({\n    project_id: project_id,\n    column_id: 0,\n    task_id: 0,\n    userid: userid,\n    detail: logDetail\n})\n\nlog.info(\'日志插入\' + result)\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"文件\",\n  \"type\" : \"function\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/file\",\n  \"createTime\" : 1720519095515,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/上传知识库.ms', '{\n  \"properties\" : { },\n  \"id\" : \"b185b1f67d9840149dee60d17cfa2fcd\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"上传知识库\",\n  \"createTime\" : 1720519096569,\n  \"updateTime\" : 1716809386760,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/uploadkb\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"fileUrl\",\n    \"value\" : null,\n    \"description\" : \"文件url\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport log\nimport http\nimport cn.hutool.http.HttpRequest;\nimport cn.hutool.http.HttpResponse;\nimport org.ssssssss.magicboot.utils.MinioUtil\nimport cn.hutool.core.io.FileUtil;\nimport cn.hutool.http.HttpUtil;\nimport cn.hutool.core.io.IoUtil;\n\nvar know = db.table(\"settings\").where().eq(\"name\", \"know\").selectOne();\nif (know === null) {\n    log.info(\"知识库未配置\")\n    return \"知识库未配置\"\n} else {\n    if (know != null && know.setting) {\n        var result = know.setting::json\n        if (result.auto_upload != \"open\") {\n            return \"自动上传未开启\"\n        }\n        var apiUrl = result.linkUrl\n        var user = result.user\n        var pwd = result.pwd\n        var dataSetId = result.appid\n\n         log.info(\"result-->\" + result)\n         log.info(\"user-->\" + user)\n         log.info(\"pwd-->\" + pwd)\n        if (apiUrl != null && user != null && pwd != null && dataSetId != null) {\n            //执行登录\n            var responseEntity = http.connect(apiUrl + \'/api/user/login\').contentType(\'application/json\').body({\n                username: user,\n                password: pwd,\n            }).post().getBody();\n            log.info(\"获取登录返回：\" + responseEntity)\n            if (responseEntity.code == 200) {\n                log.info(\"登录成功\")\n                var token = responseEntity.data;\n                log.info(\"token-->\" + token)\n                var firstIndex = fileUrl.indexOf(\".\")\n                var prefix = fileUrl.substring(0, firstIndex)\n                var suffix = fileUrl.substring(firstIndex, fileUrl.length())\n                log.info(\"prefix-->\" + prefix)\n                log.info(\"suffix-->\" + suffix)\n\n                File tempFile = FileUtil.createTempFile(prefix, suffix, FileUtil.getTmpDir());\n                FileUtil.writeBytes(MinioUtil.download(fileUrl), tempFile);\n                log.info(\"临时文件已创建: \" + tempFile.getAbsolutePath());\n                var url = apiUrl + \"/api/dataset/document/split\";\n                HttpRequest request = HttpRequest.post(url);\n                request.form(\"file\", tempFile);\n                request.header(\"Authorization\", token);\n                HttpResponse execute = request.execute();\n                boolean ok = execute.isOk();\n                String body = execute.body();\n                log.info(\"request execute.body-->\" + body)\n                var result = body::json.data\n                String name = result[0].name;\n                var content = result[0].content;\n                log.info(\"request execute.body content-->\" + content)\n                //TODO 单文件自动上传只是取[0]是否正确\n                //正式导入\n                //处理数据\n                var bodyData = [];\n                var par = {};\n                par.name = name;\n                par.paragraphs = content\n                bodyData.push(par)\n                var responseEntity = http.connect(apiUrl + \"/api/dataset/\" + dataSetId + \"/document/_bach\").header(\"Authorization\", token).contentType(\'application/json\').body(bodyData).post().getBody();\n                log.info(\"获取bach返回：\" + responseEntity)\n            }\n\n        }\n    }\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/保存文件(夹)之前的操作.ms', '{\n  \"properties\" : { },\n  \"id\" : \"2bf8450fa0df42b0833ea294e98b3e1d\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"保存文件(夹)之前的操作\",\n  \"createTime\" : 1720519096576,\n  \"updateTime\" : 1716604533339,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/saveBefore\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"file\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\n\r\n\r\nreturn \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/处理文件重命名.ms', '{\n  \"properties\" : { },\n  \"id\" : \"2308e266c5b84ba58da6c365d5d33b63\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"处理文件重命名\",\n  \"createTime\" : 1720519096583,\n  \"updateTime\" : 1711784127593,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/handleDuplicateName\",\n  \"description\" : \"处理名称重复的情况，返回新的名称\",\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"pid\",\n    \"value\" : null,\n    \"description\" : \"父id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"userid\",\n    \"value\" : null,\n    \"description\" : \"用户id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"ext\",\n    \"value\" : null,\n    \"description\" : \"后缀\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"name\",\n    \"value\" : null,\n    \"description\" : \"文件名称\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport java.util.Random;\nimport java.util.regex.Pattern;\n\nvar nameNum = db.table(\"files\")\n    .where()\n    .isNull(\'deleted_at\')\n    .eq(\'pid\', pid)\n    .eq(\'userid\', userid)\n    .eq(\'ext\', ext)\n    .eq(\'name\', name)\n    .count();\n\nif (nameNum == 0) {\n    // 未重名，不需要处理\n    return name;\n}\n\n// 发现重名，开始自动重命名\nvar nextNum = 2;\n// 如果文件名符合 \"文件名 (数字)\" 格式，则提取文件名前缀和数字部分\nif (Pattern.matches(\"(.*?)(\\\\s+\\\\(\\\\d+\\\\))*$\", name)) {\n    // 使用正则表达式提取文件名前缀\n    String preName = name.replaceAll(\"(.*?)(\\\\s+\\\\(\\\\d+\\\\))*$\", \"$1\");\n    // 查询已存在的类似文件名的数量\n    nextNum = db.selectInt(\"\"\"select count(1) from files where name like CONCAT(#{preName},\'%\') and deleted_at is null\"\"\") + 1;\n}\n\n// 组合新的文件名\nString newName = name + \" (\" + nextNum + \")\";\n\nvar nameIsExists = db.select(\"\"\"\nSELECT EXISTS (SELECT 1 FROM files WHERE name = #{newName} and deleted_at is null) as nameIsExists;\n\"\"\");\n\n// 如果新文件名已存在，则随机生成数字直到新文件名唯一\nwhile (nameIsExists.nameIsExists == 1) {\n    nextNum = new Random().nextInt(9900) + 100; // 生成 100-9999 之间的随机数\n    newName = name + \" (\" + nextNum + \")\";\n    nameIsExists = db.select(\"\"\"\n    SELECT EXISTS (SELECT 1 FROM files WHERE name = #{newName} and deleted_at is null) as nameIsExists;\n    \"\"\");\n}\n\nreturn newName;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/根据文件后缀获取文件类型.ms', '{\n  \"properties\" : { },\n  \"id\" : \"0afbe3c925ec495689209382c321c529\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"根据文件后缀获取文件类型\",\n  \"createTime\" : 1720519096588,\n  \"updateTime\" : 1712062916634,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/getFileTypeByExt\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"ext\",\n    \"value\" : null,\n    \"description\" : \"文件后缀\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nvar typeMap = {\n    \'text\': \'document\',\n    \'md\': \'document\',\n    \'markdown\': \'document\',\n    \'drawio\': \'drawio\',\n    \'mind\': \'mind\',\n    \'doc\': \'word\',\n    \'docx\': \'word\',\n    \'xls\': \'excel\',\n    \'xlsx\': \'excel\',\n    \'ppt\': \'ppt\',\n    \'pptx\': \'ppt\',\n    \'wps\': \'wps\',\n    \'jpg\': \'picture\',\n    \'jpeg\': \'picture\',\n    \'webp\': \'picture\',\n    \'png\': \'picture\',\n    \'gif\': \'picture\',\n    \'bmp\': \'picture\',\n    \'ico\': \'picture\',\n    \'raw\': \'picture\',\n    \'svg\': \'picture\',\n    \'rar\': \'archive\',\n    \'zip\': \'archive\',\n    \'jar\': \'archive\',\n    \'7-zip\': \'archive\',\n    \'tar\': \'archive\',\n    \'gzip\': \'archive\',\n    \'7z\': \'archive\',\n    \'gz\': \'archive\',\n    \'apk\': \'archive\',\n    \'dmg\': \'archive\',\n    \'tif\': \'tif\',\n    \'tiff\': \'tif\',\n    \'dwg\': \'cad\',\n    \'dxf\': \'cad\',\n    \'ofd\': \'ofd\',\n    \'pdf\': \'pdf\',\n    \'txt\': \'txt\',\n    \'htaccess\': \'code\',\n    \'htgroups\': \'code\',\n    \'htpasswd\': \'code\',\n    \'conf\': \'code\',\n    \'bat\': \'code\',\n    \'cmd\': \'code\',\n    \'cpp\': \'code\',\n    \'c\': \'code\',\n    \'cc\': \'code\',\n    \'cxx\': \'code\',\n    \'h\': \'code\',\n    \'hh\': \'code\',\n    \'hpp\': \'code\',\n    \'ino\': \'code\',\n    \'cs\': \'code\',\n    \'css\': \'code\',\n    \'dockerfile\': \'code\',\n    \'go\': \'code\',\n    \'golang\': \'code\',\n    \'html\': \'code\',\n    \'htm\': \'code\',\n    \'xhtml\': \'code\',\n    \'vue\': \'code\',\n    \'we\': \'code\',\n    \'wpy\': \'code\',\n    \'java\': \'code\',\n    \'js\': \'code\',\n    \'jsm\': \'code\',\n    \'jsx\': \'code\',\n    \'json\': \'code\',\n    \'jsp\': \'code\',\n    \'less\': \'code\',\n    \'lua\': \'code\',\n    \'makefile\': \'code\',\n    \'gnumakefile\': \'code\',\n    \'ocamlmakefile\': \'code\',\n    \'make\': \'code\',\n    \'mysql\': \'code\',\n    \'nginx\': \'code\',\n    \'ini\': \'code\',\n    \'cfg\': \'code\',\n    \'prefs\': \'code\',\n    \'m\': \'code\',\n    \'mm\': \'code\',\n    \'pl\': \'code\',\n    \'pm\': \'code\',\n    \'p6\': \'code\',\n    \'pl6\': \'code\',\n    \'pm6\': \'code\',\n    \'pgsql\': \'code\',\n    \'php\': \'code\',\n    \'inc\': \'code\',\n    \'phtml\': \'code\',\n    \'shtml\': \'code\',\n    \'php3\': \'code\',\n    \'php4\': \'code\',\n    \'php5\': \'code\',\n    \'phps\': \'code\',\n    \'phpt\': \'code\',\n    \'aw\': \'code\',\n    \'ctp\': \'code\',\n    \'module\': \'code\',\n    \'ps1\': \'code\',\n    \'py\': \'code\',\n    \'r\': \'code\',\n    \'rb\': \'code\',\n    \'ru\': \'code\',\n    \'gemspec\': \'code\',\n    \'rake\': \'code\',\n    \'guardfile\': \'code\',\n    \'rakefile\': \'code\',\n    \'gemfile\': \'code\',\n    \'rs\': \'code\',\n    \'sass\': \'code\',\n    \'scss\': \'code\',\n    \'sh\': \'code\',\n    \'bash\': \'code\',\n    \'bashrc\': \'code\',\n    \'sql\': \'code\',\n    \'sqlserver\': \'code\',\n    \'swift\': \'code\',\n    \'ts\': \'code\',\n    \'typescript\': \'code\',\n    \'str\': \'code\',\n    \'vbs\': \'code\',\n    \'vb\': \'code\',\n    \'v\': \'code\',\n    \'vh\': \'code\',\n    \'sv\': \'code\',\n    \'svh\': \'code\',\n    \'xml\': \'code\',\n    \'rdf\': \'code\',\n    \'rss\': \'code\',\n    \'wsdl\': \'code\',\n    \'xslt\': \'code\',\n    \'atom\': \'code\',\n    \'mathml\': \'code\',\n    \'mml\': \'code\',\n    \'xul\': \'code\',\n    \'xbl\': \'code\',\n    \'xaml\': \'code\',\n    \'yaml\': \'code\',\n    \'yml\': \'code\',\n    \'asp\': \'code\',\n    \'properties\': \'code\',\n    \'gitignore\': \'code\',\n    \'log\': \'code\',\n    \'bas\': \'code\',\n    \'prg\': \'code\',\n    \'python\': \'code\',\n    \'ftl\': \'code\',\n    \'aspx\': \'code\',\n    \'plist\': \'code\',\n    \'mp3\': \'media\',\n    \'wav\': \'media\',\n    \'mp4\': \'media\',\n    \'flv\': \'media\',\n    \'avi\': \'media\',\n    \'mov\': \'media\',\n    \'wmv\': \'media\',\n    \'mkv\': \'media\',\n    \'3gp\': \'media\',\n    \'rm\': \'media\',\n    \'xmind\': \'xmind\',\n    \'rp\': \'axure\',\n};\n\nvar result = typeMap.get(ext)\n\nreturn result == null ? \"\" : result;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/根据自身权限获取列表.ms', '{\n  \"properties\" : { },\n  \"id\" : \"ae703ad1ce374d38b44fe5d7826ed46b\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"根据自身权限获取列表\",\n  \"createTime\" : 1720519096593,\n  \"updateTime\" : 1717056184162,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/getFileListByPermission\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"name\",\n    \"value\" : null,\n    \"description\" : \"文件名称,关键词\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Object\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"fileId\",\n    \"value\" : null,\n    \"description\" : \"文件id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"userId\",\n    \"value\" : null,\n    \"description\" : \"用户id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"pid\",\n    \"value\" : null,\n    \"description\" : \"父id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport org.ssssssss.magicboot.utils.MinioUtil;\nimport cn.hutool.core.util.ObjectUtil;\nimport cn.hutool.core.util.StrUtil;\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log;\n\nimport env\n\nvar serviceUrl = env.get(\"public.domain\") + \":\" + env.get(\"server.port\")\nlog.info(\"serviceUrl-->\" + serviceUrl);\n\n\nvar fileList = db.select(\"\"\"\nSELECT\n    f.id,\n    f.pid,\n    f.id_path,\n    f.cid,\n    f.name,\n    f.type,\n    f.ext,\n    f.size,\n    f.userid,\n    f.pshare,\n    f.share,\n    f.created_id,\n    f.created_at,\n    f.url,\n    f.updated_at,\n    f.deleted_at,\n    CASE\n        WHEN f.userid =  #{userId} OR f.created_id =  #{userId} THEN 1000\n        WHEN pu.max_permission IS NOT NULL THEN pu.max_permission\n        ELSE COALESCE((SELECT MAX(fu.permission) FROM file_users fu WHERE fu.file_id = f.pshare), 0)\n    END AS permission\nFROM\n    files f\nLEFT JOIN (\n    SELECT file_id, MAX(permission) AS max_permission\n    FROM file_users\n    GROUP BY file_id\n) pu ON f.id = pu.file_id\nWHERE\n    f.deleted_at IS NULL\n    <if test=\"fileId != null\">\n		AND f.id = #{fileId}\n	</if>\n	<if test=\"pid != null\">\n		AND f.pid = #{pid}\n	</if>\n    <if test=\"key != null and key != \'\'\">\n        AND f.name like concat(\'%\',#{key},\'%\')\n    </if>\n    AND (\n        f.userid =  #{userId}\n        OR f.created_id =  #{userId}\n        OR EXISTS (\n            SELECT 1 FROM file_users fu1 WHERE fu1.userid IN ( #{userId}, -1) AND fu1.file_id IN (SELECT f1.id FROM files f1 WHERE f1.id_path LIKE CONCAT(f.id_path, \'%\'))\n        )\n        OR (\n            f.pshare <> 0  AND EXISTS (SELECT 1 FROM file_users WHERE file_id = f.pshare AND (userid =  #{userId} OR userid = -1))\n        )\n    )\nORDER BY\n    f.created_at DESC;\n    \"\"\")\nlog.info(\"fileList-->\" + fileList)\n\n// 如果是图片，需要补充一下image_url,拼接域名部分：image_url = 域名部分+数据存的\n// 数据库存的是：/uploads/file/picture/202403/36000/d24665e11caac178d1ac6de6ab1c8564.png\n// 拼接域名部分：\"https://autoopm.com\"，不固定，通过配置文件读取\nfor (file in fileList) {\n    // 处理时间\n    file.created_at = date_format(file.created_at);\n    file.updated_at = date_format(file.updated_at);\n    file.deleted_at = date_format(file.deleted_at);\n    // 是图片才需要拼接\n    if (StrUtil.isNotEmpty(file.url) && StrUtil.isNotEmpty(file.type) && \"picture\".equals(file.type)) {\n        file.put(\"image_url\", serviceUrl + \'/api/file/preview/\' + file.id);\n    }\n\n}\n\nreturn fileList;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/获取文件并检测权限.ms', '{\n  \"properties\" : { },\n  \"id\" : \"242dcf301d07402289536c41d9d35aee\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"获取文件并检测权限\",\n  \"createTime\" : 1720519096600,\n  \"updateTime\" : 1720519547691,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/permissionFind\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"userId\",\n    \"value\" : null,\n    \"description\" : \"用户id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"fileId\",\n    \"value\" : null,\n    \"description\" : \"文件id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"limit\",\n    \"value\" : null,\n    \"description\" : \"期望的权限\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport cn.hutool.core.util.ObjectUtil\nimport cn.hutool.core.collection.CollUtil\nimport \'@/file/getFileListByPermission\' as getFileListByPermission\nimport log;\nimport java.util.LinkedHashMap;\n\n// 先查文件是否存在\nvar num = db.table(\'files\').where().eq(\'id\', fileId).isNull(\'deleted_at\').count()\nif (num == 0) {\n    exit 400, \'文件不存在或已被删除\';\n}\n// 验证权限\nvar file = getFileListByPermission(null, fileId, userId, null);\nif (CollUtil.isEmpty(file)) {\n    exit 400, \'没有查看访问权限\';\n}\n\nlog.info(\"file\" + file)\nlog.info(\"file 0 \" + file[0])\nvar permission = file[0].permission;\nlog.info(\"file 0 permission \" + file[0].permission)\nlog.info(\" limit--> \" + limit)\nif (permission == null) {\n    exit 400, \'没有查看访问权限2\';\n}\n\nif (permission < limit) {\n    if (limit == 1000) {\n        exit 400, \'仅限所有者或创建者操作\';\n    } else if (permission == 1) {\n        exit 400, \'没有修改写入权限\';\n    } else {\n        exit 400, \'没有查看访问权限3\';\n    }\n}\nlog.info(\" limit--> \" + limit)\nif (file.size() > 0) {\n    return file[0];\n} else {\n    return null;\n}\n//返回第一个文件');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/获取用户对文件(夹)是否有访问权限.ms', '{\n  \"properties\" : { },\n  \"id\" : \"338a7d440b4946a9805a5cd45b60ae71\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"获取用户对文件(夹)是否有访问权限\",\n  \"createTime\" : 1720519096605,\n  \"updateTime\" : 1711251238001,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/getPermission\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"fileId\",\n    \"value\" : null,\n    \"description\" : \"文件id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"userId\",\n    \"value\" : null,\n    \"description\" : \"用户id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Number\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nvar permission = db.selectValue(\"\"\"\nSELECT\nCASE\n		\n	WHEN\n		( f.userid = #{userId} OR f.created_id =  #{userId} ) THEN\n			1000 ELSE COALESCE ( MAX( fu.permission ), 0 ) \n			END AS permission \n	FROM\n		files f\n		LEFT JOIN file_users fu ON f.id = fu.file_id \n		AND fu.userid IN (  #{userId}, - 1 ) \n	WHERE\n		((\n				f.userid =  #{userId} \n				OR f.created_id =  #{userId}\n				) \n			OR EXISTS (\n			SELECT\n				1 \n			FROM\n				file_users fu1 \n			WHERE\n				fu1.userid IN (  #{userId}, - 1 ) \n				AND fu1.file_id IN ( SELECT f1.id FROM files f1 WHERE f1.id_path LIKE CONCAT( f.id_path, \'%\' ) ) \n			) \n		) \n		AND f.deleted_at IS NULL \n		AND f.id = #{fileId} \n	GROUP BY\n		f.id \n\"\"\")\n\n\nreturn permission;');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/文件/设置或者关闭共享(同时遍历取消里面的共享).ms', '{\n  \"properties\" : { },\n  \"id\" : \"b8dece243258482c948712201c860e08\",\n  \"script\" : null,\n  \"groupId\" : \"89c986b52b04478a95630c451428ab00\",\n  \"name\" : \"设置或者关闭共享(同时遍历取消里面的共享)\",\n  \"createTime\" : 1720519096609,\n  \"updateTime\" : 1711796466266,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/updataShare\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"file\",\n    \"value\" : null,\n    \"description\" : \"文件实体\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.util.Map\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\n  import log;\n  // 如果没有共享用户，则设置共享状态为0；否则设置为1（共享）\n  var share = db.table(\'file_users\').where().eq(\'file_id\', id).count() == 0 ? 0 : 1;\n  // 检查当前文件的共享状态是否需要更新\n  if (share != file.share) {\n      // 更新当前文件的共享状态\n      db.table(\'files\').primary(\'id\').update({\n          id: id,\n          share: share\n      })\n      // 如果文件被共享，设置pshare为当前文件ID，否则设置为0\n      var pshareValue = share == 1 ? file.id : 0;\n      log.info(\"file=\",file);\n      db.update(\"\"\"\n                update files \n                set share = 0,pshare = #{pshareValue} \n                where id_path LIKE CONCAT(#{file.id_path}, \'%\') and deleted_at is null and id <> #{file.id}\n            \"\"\")\n\n      // 如果文件的共享状态被设置为0（非共享），则删除所有相关的共享用户记录\n      if (share == 0) {\n          // 删除指定共享成员\n          db.table(\'file_users\')\n              .where()\n              .eq(\'file_id\', file.id)\n              .delete();\n          // 同时删除成员分享的链接\n          db.table(\'file_links\')\n              .where()\n              .eq(\'file_id\', file.id)\n              .delete();\n      }\n\n  }\n  return \'Hello magic-api\'');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/权限/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/权限/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"41922e26ef57421f8819fe6c59f14d63\",\n  \"name\" : \"权限\",\n  \"type\" : \"function\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/permission\",\n  \"createTime\" : 1720519095528,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/权限/组织机构.ms', '{\n  \"properties\" : { },\n  \"id\" : \"a5f80b11b7fb4f3c97252331c80bcf85\",\n  \"script\" : null,\n  \"groupId\" : \"41922e26ef57421f8819fe6c59f14d63\",\n  \"name\" : \"组织机构\",\n  \"createTime\" : 1720519096615,\n  \"updateTime\" : 1642327198030,\n  \"lock\" : \"0\",\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/office\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : \"/permission/office\",\n  \"parameters\" : [ ]\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\nvar currentUserId = StpUtil.getLoginId()\n//查出当前用户有多少角色\nvar roles = db.select(\"\"\"\n    select permission from sys_role where is_del = 0 and id in (select role_id from sys_user_role where user_id = #{currentUserId})\n\"\"\")\nvar userIds = []\nfor(role in roles){\n    if(role.permission == \'0\'){\n        return []\n    }else if(role.permission == \'1\'){\n        userIds.addAll(db.select(\"\"\"\n            select id from sys_user where is_del = 0 and office_id in (\n                select office_id from sys_role_office where role_id in (\n                    select role_id from sys_user_role where user_id = #{currentUserId}\n                )\n            )\n        \"\"\").map(it => it.id))\n    }else{\n        var officeId = db.selectValue(\"select office_id from sys_user where id = #{currentUserId}\")\n        var offices = []\n        offices.push(officeId)\n        var getOfficeId = (list,pid) => {\n            var ids = select t.id from list t where t.pid = pid;\n            for(it in ids){\n                offices.push(it.id)\n                getOfficeId(list,it.id)\n            }\n        }\n        getOfficeId(db.select(\'select id, pid from sys_office where is_del = 0 order by sort\'),officeId)\n        userIds.addAll(db.select(\"select id from sys_user where office_id in (#{offices})\").map(it => it.id))\n    }\n}\n\nreturn userIds');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/用户/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/用户/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"29554e07436d4c1396420cbfedd40cd9\",\n  \"name\" : \"用户\",\n  \"type\" : \"function\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/users\",\n  \"createTime\" : 1720519095537,\n  \"updateTime\" : 1713024590458,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/用户/删除部门.ms', '{\n  \"properties\" : { },\n  \"id\" : \"61c1402b5fa541909f145cf307e8052a\",\n  \"script\" : null,\n  \"groupId\" : \"29554e07436d4c1396420cbfedd40cd9\",\n  \"name\" : \"删除部门\",\n  \"createTime\" : 1720519096619,\n  \"updateTime\" : 1713024595444,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/deleteDepartment\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"id\",\n    \"value\" : null,\n    \"description\" : \"部门id\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\n  import log\n  import \'@/users/deleteDepartment\' as deleteDepartment\n  log.info(\"传进来的项目id\" + id)\n\n  list = db.table(\"user_departments\").where().eq(\"parent_id\", id).select()\n  if (list.size() > 0) {\n      for (item in list) {\n          //TODO 遍历出自己的 \n          deleteDepartment(item.id)\n      }\n  }\n  //查找哪些用户在部门中\n  userList = db.select(\"\"\"\n        SELECT * FROM users WHERE department like \'%,${id},%\'\n    \"\"\")\n\n  log.info(\"userList size \" + userList.size())\n  //用户的部门信息字段移除删除的部门id\n  for (item in userList) {\n      log.info(\"userList item\" + item)\n      db.update(\"\"\"\n        UPDATE users SET department = CONCAT(\',\', TRIM(BOTH \',\' FROM REPLACE(CONCAT(\',\', department, \',\'), \',${id},\', \',\')), \',\') WHERE department LIKE \'%,${id},%\'\n        \"\"\")\n  }\n  //删除部门\n  result = db.table(\"user_departments\").where().eq(\"id\", id).delete()\n  log.info(\"删除部门返回结果-->\" + result)\n  //TODO 解散群组\n  return result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/配置中心/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/配置中心/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"7e31035eb8d4471b9fc2923ea1d966c3\",\n  \"name\" : \"配置中心\",\n  \"type\" : \"function\",\n  \"parentId\" : \"0\",\n  \"path\" : \"configure\",\n  \"createTime\" : 1720519095547,\n  \"updateTime\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/配置中心/根据keyAndcondition获取数据值.ms', '{\n  \"properties\" : { },\n  \"id\" : \"copy1653111178446d65648\",\n  \"script\" : null,\n  \"groupId\" : \"7e31035eb8d4471b9fc2923ea1d966c3\",\n  \"name\" : \"根据keyAndcondition获取数据值\",\n  \"createTime\" : 1720519096623,\n  \"updateTime\" : 1653118303409,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/getBykeyCondition\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"configureKey\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"configureCondition\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nvar configure = db.cache(`configure:${configureKey}${configureCondition}`).selectOne(\"\"\"\n     select configure_value from sys_configure where configure_key = #{configureKey} \n     ?{configureCondition, and configure_condition = #{configureCondition}}\n\"\"\")\n\nreturn configure == null ? \"\" : configure.get(\"configureValue\")');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/配置中心/根据keyLikeCondition获取数据值.ms', '{\n  \"properties\" : { },\n  \"id\" : \"copy1653112036134d44643\",\n  \"script\" : null,\n  \"groupId\" : \"7e31035eb8d4471b9fc2923ea1d966c3\",\n  \"name\" : \"根据keyLikeCondition获取数据值\",\n  \"createTime\" : 1720519096627,\n  \"updateTime\" : 1653118334978,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/getLikeCondition\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"configureKey\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"configureCondition\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nvar configure = db.cache(`configure:${configureKey}${configureCondition}`).selectOne(\"\"\"\n     select configure_value from sys_configure where configure_key = #{configureKey} \n     ?{configureCondition, and configure_condition like concat(\'%\',#{configureCondition},\'%\')}\n\"\"\")\n\nreturn configure == null ? \"\" : configure.get(\"configureValue\")');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/配置中心/根据key获取数据值.ms', '{\n  \"properties\" : { },\n  \"id\" : \"3a21cd5fcd9b4e96b870a2268088266d\",\n  \"script\" : null,\n  \"groupId\" : \"7e31035eb8d4471b9fc2923ea1d966c3\",\n  \"name\" : \"根据key获取数据值\",\n  \"createTime\" : 1720519096631,\n  \"updateTime\" : 1653119091752,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/getBykey\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"configureKey\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nvar configure = db.cache(`configure:${configureKey}`).selectOne(\"\"\"\n     select configure_value from sys_configure where configure_key = #{configureKey}\n\"\"\")\nreturn configure == null ? \"\" : configure.get(\"configureValue\")');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/项目/', 'this is directory');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/项目/group.json', '{\n  \"properties\" : { },\n  \"id\" : \"f1893ea1928d488999804afc6c84e785\",\n  \"name\" : \"项目\",\n  \"type\" : \"function\",\n  \"parentId\" : \"0\",\n  \"path\" : \"/project\",\n  \"createTime\" : 1720519095557,\n  \"updateTime\" : 1713024590542,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"paths\" : [ ],\n  \"options\" : [ ]\n}');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/项目/归档项目或取消归档.ms', '{\n  \"properties\" : { },\n  \"id\" : \"f8514c3cb7634c71a8160d4428884eab\",\n  \"script\" : null,\n  \"groupId\" : \"f1893ea1928d488999804afc6c84e785\",\n  \"name\" : \"归档项目或取消归档\",\n  \"createTime\" : 1720519096635,\n  \"updateTime\" : 1713024595523,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/archivedProject\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"archived_at\",\n    \"value\" : null,\n    \"description\" : \"归档时间\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : null,\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nvar userid = StpUtil.getLoginId()\nimport \'@/project/log\' as log\n\nvar val = db.transaction(() => {\n    if (archived_at == null) {\n        //项目取消归档\n        //推送取消归档的通知\n        db.table(\"project_tasks\").primary(\"project_id\").primary(\"archived_follow\").update({\n            project_id: project_id,\n            archived_follow: 1,\n            archived_at: null,\n            archived_follow: 0,\n\n        })\n        log(\'项目取消归档\')\n    } else {\n        //项目归档\n        db.table(\"project_tasks\").primary(\"project_id\").primary(\"archived_at\").update({\n            project_id: project_id,\n            archived_at: null,\n            archived_at: archived_at,\n            archived_follow: 1,\n        })\n        log(\'项目归档\')\n        //推送归档的通知\n    }\n\n    db.table(\"projects\").primary(\"id\").update({\n        id: project_id,\n        archived_at: archived_at,\n        archived_userid: userid\n    })\n\n});');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/项目/检查项目.ms', '{\n  \"properties\" : { },\n  \"id\" : \"c92e6b48b9294e26b398c7bf271425bc\",\n  \"script\" : null,\n  \"groupId\" : \"f1893ea1928d488999804afc6c84e785\",\n  \"name\" : \"检查项目\",\n  \"createTime\" : 1720519096638,\n  \"updateTime\" : 1713024595607,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/use\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ ]\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\n\nvar useProject = db.table(\"projects\").where().eq(\"id\", project_id).notNull(\"archived_at\").selectOne()\nif (useProject == null) {\n    exit 400, \'项目不存在或已归档\'\n}\nreturn useProject\n\n\n');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/项目/添加工作流.ms', '{\n  \"properties\" : { },\n  \"id\" : \"631d203dee1042fea99547aa0168e4fb\",\n  \"script\" : null,\n  \"groupId\" : \"f1893ea1928d488999804afc6c84e785\",\n  \"name\" : \"添加工作流\",\n  \"createTime\" : 1720519096641,\n  \"updateTime\" : 1713024595683,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/addFlow\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"flows\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.util.Collection\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  }, {\n    \"name\" : \"projectId\",\n    \"value\" : null,\n    \"description\" : null,\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.Object\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport log\nlog.info(\"this project_id --> \" + projectId)\nlog.info(\"this flows --> \" + flows)\nvar val = db.transaction(() => {\n    //判断是否存在了工作流  \n    var projectFlowId\n    projectFlow = db.table(\"project_flows\").where().eq(\"project_id\", projectId).selectOne()\n    if (!projectFlow) {\n        log.info(\"项目流程不存在则创建\")\n        //创建工作流, 这样能不能等于还是未知\n        projectFlowId = db.table(\'project_flows\').insert({\n            project_id: projectId,\n            name: \'Default\',\n        })\n        if (!projectFlowId) {\n            exit 400, \'工作流创建失败\'\n        }\n    } else {\n        projectFlowId = projectFlow.id\n    }\n    //一个项目只存在一个流程\n    projectFlow = db.table(\"project_flows\").where().eq(\"project_id\", projectId).selectOne()\n\n    idc = []\n    upTaskList = []\n    ids = [];\n    hasStart = false //是否有开始状态\n    hasEnd = false //是否有结束状态\n    sort = -1 //排序\n\n    for (item in flows) {\n        sort = sort + 1\n        item_id = item.id\n        log.info(\'item_id： \' + item_id)\n        item_usertype = item.usertype\n        item_userids = item.userids //TODO 判断空值\n        item_userlimit = item.userlimit\n        item_turns = item.turns //TODO 判断空值\n        if (usertype == \'replace\' && item_userids.size() < 1) {\n            exit 400, \"状态[\" + item.name + \']设置错误，设置流转模式时必须填写状态负责人\'\n        }\n        if (usertype == \'merge\' && item_userids.size() < 1) {\n            exit 400, \"状态[\" + item.name + \']设置错误，设置剔除模式时必须填写状态负责人\'\n        }\n        if (userlimit && item_userids.size() < 1) {\n            exit 400, \"状态[\" + item.name + \']设置错误，设置限制负责人时必须填写状态负责人\'\n        }\n        log.info(\"projectFlowId is\" + projectFlowId)\n        log.info(\'turns is \' + item_turns)\n        log.info(\'item_userids \' + item_userids)\n\n        updateInsertResult = 0\n        //更新或插入数据库，怎么判断呢？\n        if (item.id > 0) { //更新操作\n            //更新数据库\n            ids.push(item.id) // 在这里直接添加了\n            result = db.table(\'project_flow_items\').primary(\"id\").save({\n                id: item.id,\n                flow_id: projectFlowId,\n                project_id: projectId,\n                name: item.name,\n                status: item.status,\n                sort: sort, // 暴力排序\n                usertype: item_usertype,\n                userlimit: item_userlimit,\n                turns: item_turns::string,\n                userids: item_userids,\n            })\n        } else { //新建操作\n            result = db.table(\'project_flow_items\').insert({\n                flow_id: projectFlowId,\n                project_id: projectId,\n                name: item.name,\n                status: item.status,\n                sort: sort, // 暴力排序\n                usertype: item_usertype,\n                userlimit: item_userlimit,\n                turns: item_turns::string,\n                userids: item_userids,\n            })\n            log.info(\"新建操作的返回值->\" + result)\n            ids.push(result)\n        }\n\n        // //插入数据库\n        // var insertId = db.table(\'project_flow_items\').insert({\n        //     name: item.name,\n        //     status: item.status,\n        //     sort: sort, // 暴力排序\n        //     flow_id: projectFlowId,\n        //     project_id: projectId,\n        //     usertype: item_usertype,\n        //     userlimit: item_userlimit,\n        //     turns: item_turns,\n        //     userids: item_userids,\n        // })\n\n        // log.info(\"updateInsertResult value :\" + updateInsertResult)\n        // if (updateInsertResult > 0) {\n        // ids.push(updateInsertResult)\n        // log.info(\"插入或更新成功 :\" + updateInsertResult + \"|\" + ids)\n        // $ids[] = $flow->id;\n        //         if ($flow->id != $id) {\n        //             $idc[$id] = $flow->id;\n        //         }\n        if (item.status == \'start\') {\n            hasStart = true\n        }\n        if (item.status == \'end\') {\n            hasEnd = true\n        }\n        //记录哪些任务的状态描述需要更新，插入为新值的不用管，新状态因为任务还没存在\n        if (item.id > 0) {\n            upTaskList.push({\n                flow_id: item.id,\n                statusStr: item.status + \"|\" + item.name\n            })\n            log.info(\"upTaskList\", upTaskList::string)\n        }\n        // }\n    }\n    if (!hasStart) {\n        exit 400, \'至少需要1个开始状态\'\n    }\n    if (!hasEnd) {\n        exit 400, \'至少需要1个结束状态\'\n    }\n\n    // 查询工作流项中没有的，进行删除操作\n    noInFlowItems = db.table(\"project_flow_items\").where().eq(\"project_id\", projectId).notIn(\"id\", ids).select()\n    for (item in noInFlowItems) {\n        result = db.table(\"project_flow_items\").where().eq(\"project_id\", projectId).eq(\"id\", item.id).delete()\n        log.info(\"删除不存在的项 result\" + result)\n    }\n\n    //修改任务表中该状态的状态显示\n    for (item in upTaskList) {\n        result = db.table(\"project_tasks\").primary(\"flow_item_id\").update({\n            flow_item_id: item.flow_id,\n            flow_item_name: item.statusStr\n        })\n        log.info(\"修改任务的状态显示\" + result)\n    }\n\n    //重新排序\n    ids = ids.sort((a, b) => a - b);\n    log.info(\"ids 重新排序\" + ids::string)\n\n    //修改成最新的\n    for (item in ids) {\n        db.table(\'project_flow_items\').primary(\'id\').update({\n            id: item,\n            turns: ids::string,\n        })\n    }\n\n\n\n    // //取出所有的item项\n    // flowItemList = db.table(\"project_flow_items\").where().eq(\"project_id\", projectId).orderBy(\"sort\").select()\n    // let itemIds = []\n    // for (item in flowItemList) {\n    //     itemIds.push(item.id)\n    // }\n\n    // log.info(\"itemIds\" + itemIds)\n    //将idc进行排序\n    // for (item in flowItemList) {\n    //排序\n    // itemIds = itemIds.sort((a, b) => a - b); //从小到大\n    // log.info(\"itemIds 重新排序\" + itemIds::string) //TODO 能不能放到循环外面呢\n    // foreach ($idc as $oid => $nid) {\n    //             if (in_array($oid, $turns)) {\n    //                 $turns = array_diff($turns, [$oid]);\n    //                 $turns[] = $nid;\n    //             }\n    //         }\n    //         if (!in_array($item->id, $turns)) {\n    //             $turns[] = $item->id;\n    //         }\n    //         $turns = array_values(array_filter(array_unique(array_intersect($turns, $itemIds))));\n    //         sort($turns);\n    //         $item->turns = $turns;\n    //更新\n    flowItemList = db.table(\"project_flow_items\").where().eq(\"project_id\", projectId).orderBy(\"sort\").select()\n    for (item in flowItemList) {\n        log.info(\"flowItemList  item ------\" + item)\n    }\n    // return flowItemList\n    projectFlow.project_flow_item = flowItemList\n    return projectFlow\n});\nreturn val\n\n\n//排序后再返回\n// //更新turns的值\n// log.info(\"ids\" + ids)\n// for (item in ids) {\n//     db.table(\'project_flow_items\').primary(\'id\').update({\n//         id: item,\n//         turns: ids::string,\n//     })\n// }\n\n// return val;\n\n// return []');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/function/项目/添加项目日志.ms', '{\n  \"properties\" : { },\n  \"id\" : \"9fe6c92a4e334d5198e3cacd1923cc1e\",\n  \"script\" : null,\n  \"groupId\" : \"f1893ea1928d488999804afc6c84e785\",\n  \"name\" : \"添加项目日志\",\n  \"createTime\" : 1720519096646,\n  \"updateTime\" : 1713024595760,\n  \"lock\" : null,\n  \"createBy\" : null,\n  \"updateBy\" : null,\n  \"path\" : \"/log\",\n  \"description\" : null,\n  \"returnType\" : null,\n  \"mappingPath\" : null,\n  \"parameters\" : [ {\n    \"name\" : \"detail\",\n    \"value\" : null,\n    \"description\" : \"日志内容\",\n    \"required\" : false,\n    \"dataType\" : \"String\",\n    \"type\" : \"java.lang.String\",\n    \"defaultValue\" : null,\n    \"validateType\" : null,\n    \"error\" : null,\n    \"expression\" : null,\n    \"children\" : null\n  } ]\n}\r\n================================\r\nimport \'cn.dev33.satoken.stp.StpUtil\';\nimport log\n\nvar userid = StpUtil.getLoginId()\nlog.info(\'userid is \' + userid)\n\nif (userid == null) {\n    log.info(\'userid is null\')\n    exit 400, \'用户未登录\'\n}\nlog.info(\'logDetail value：\' + logDetail)\n\nvar result = db.table(\'project_logs\').insert({\n    project_id: project_id,\n    column_id: 0,\n    task_id: 0,\n    userid: userid,\n    detail: logDetail\n})\n\nlog.info(\'日志插入\' + result)\nreturn result');
INSERT INTO `magic_api_file_v2` (`file_path`, `file_content`) VALUES ('/magic-api/task/', 'this is directory');
COMMIT;

SET FOREIGN_KEY_CHECKS = 1;
